<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    

    <title>【翻译】Structured fuzzing Android&#39;s NFC | </title>
    <meta name="author" content="ssj">
    
    <meta name="description" content="https://securitylab.github.com/research/fuzzing_android_nfc
就心热来潮想翻译一下。机翻+手动调整。能理解意思的奇怪语句没有调。

在本文中，我将详细介绍如何使用libprotobuf-mutator为Android的NFC组件构建fuzze">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="【翻译】Structured fuzzing Android&#39;s NFC">
    <meta property="og:site_name" content="ssj&#39;s blog">

    
    <meta property="og:image" content>
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="ssj&#39;s blog" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/tranquil-heart.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>
</html>

<body>
    <img src="/weixin_favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

    <nav class="pink accent-1">
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class="">
            <a href="/" class="brand-logo hide-on-med-and-down">ssj&#39;s blog</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " href="/" >
                            <i class="fa fa-home "></i>
                            
                            Home
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " href="/archives" >
                            <i class="fa fa-archive "></i>
                            
                            Archives
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                            <i class="fa fa-bookmark "></i>
                            
                            Categories
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-reading " href="/reading" >
                            <i class="fa fa-book "></i>
                            
                            Reading
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-about " href="/about" >
                            <i class="fa fa-user "></i>
                            
                            About
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-search modal-trigger " href="#search" >
                            <i class="fa fa-search "></i>
                            
                            Search
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav pink darken-1" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="/pingtou.jpg" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">ssj</p>
                        <p class="desc"></p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/" >
                    <i class="fa fa-home "></i>
                    
                    Home
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives" >
                    <i class="fa fa-archive "></i>
                    
                    Archives
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                    <i class="fa fa-bookmark "></i>
                    
                    Categories
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-reading " href="/reading" >
                    <i class="fa fa-book "></i>
                    
                    Reading
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-about " href="/about" >
                    <i class="fa fa-user "></i>
                    
                    About
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-search modal-trigger " href="#search" >
                    <i class="fa fa-search "></i>
                    
                    Search
                </a>
            </li>
        
    </ul>

    <ul class="side-nav pink darken-1" id="category-menu">
    

            

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Android/">
                    Android <span class="right">13</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/Android/脱壳/">
                    脱壳 <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/Android/马甲包/">
                    马甲包 <span class="right">2</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Ethereum/">
                    Ethereum <span class="right">3</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/CVE/">
                    CVE <span class="right">10</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/二进制/">
                    二进制 <span class="right">11</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/二进制/v8/">
                    v8 <span class="right">6</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/二进制/Base/">
                    Base <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/二进制/Kernel/">
                    Kernel <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/二进制/vm/">
                    vm <span class="right">2</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/二进制/Docs/">
                    Docs <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/CTF/">
                    CTF <span class="right">7</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/CTF/pwn/">
                    pwn <span class="right">6</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/CTF/Android/">
                    Android <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/杂/">
                    杂 <span class="right">5</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/杂/京剧/">
                    京剧 <span class="right">3</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/杂/听戏/">
                    听戏 <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/杂/定场诗/">
                    定场诗 <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/面试体验/">
                    面试体验 <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/面试体验/Android/">
                    Android <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/基础知识/">
                    基础知识 <span class="right">2</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/基础知识/Cpp/">
                    Cpp <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/算法/">
                    算法 <span class="right">1</span></a>
                </a>
            </li>

        

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">Search</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


    <main>
        <div class="container main-container">
    <nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper pink">
        <span class="breadcrumb">Current page(Categories)</span>
        
            
    
    
    <a class="breadcrumb" href="/categories/Android/">Android</a>


        

        
    </div>
</nav>

<article>
    <div class="card">
        <div class="card-content">
            

            <div class="article-title">
                
    
        <h1>【翻译】Structured fuzzing Android&#39;s NFC</h1>
    


            </div>
            <time class="pink-link-context" datetime="2020-07-17T16:05:27.000Z"><a href="/2020/07/18/Structured-fuzzing-Android-s-NFC/">2020-07-18</a></time>

            <span id="busuanzi_container_page_pv" class="read-times-container">
    <i class="fa fa-eye"></i>
    <span id="busuanzi_value_page_pv"></span>
</span>

            
    <div class="tags-row">
        
            <a href="/tags/Android/" class="chip pink lighten-1">Android</a>
        
    </div>


            <div class="toc pink-link-context hide-on-med-and-down">
    <ol class="section table-of-contents"><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#Android-NFC"><span class="section table-of-contents-text">Android NFC</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#Structured-fuzzing-Android-NFC"><span class="section table-of-contents-text">Structured fuzzing Android NFC</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#Fuzzing环境设置"><span class="section table-of-contents-text">Fuzzing环境设置</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#考虑到协议的特定细节"><span class="section table-of-contents-text">考虑到协议的特定细节</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#考虑状态"><span class="section table-of-contents-text">考虑状态</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#在枚举和数据之间切换"><span class="section table-of-contents-text">在枚举和数据之间切换</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#结果"><span class="section table-of-contents-text">结果</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#结论"><span class="section table-of-contents-text">结论</span></a></li></ol>
</div>


            <div class="entry pink-link-context">
                <p><a href="https://securitylab.github.com/research/fuzzing_android_nfc" target="_blank" rel="noopener">https://securitylab.github.com/research/fuzzing_android_nfc</a></p>
<p>就心热来潮想翻译一下。机翻+手动调整。能理解意思的奇怪语句没有调。</p>
<hr>
<p>在本文中，我将详细介绍如何使用<code>libprotobuf-mutator</code>为Android的NFC组件构建fuzzer。NFC Fuzzer本身是公开的，包含使用文档和说明，因此，本文着重于构建Fuzzer时的一些设计方面的注意事项。</p>
<h2 id="Android-NFC"><a href="#Android-NFC" class="headerlink" title="Android NFC"></a>Android NFC</h2><p>Android NFC允许Android手机与NFC感应器（智能卡，smarter sticker等）或其他Android设备共享数据。该组件支持三种不同类型的操作：</p>
<ol>
<li>Reader/Writer模式：这允许移动设备充当NFC标签/读卡器或写入器，并用于与NFC标签进行交互；</li>
<li>对等（P2P）模式：这允许设备通过NFC与另一设备交互；</li>
<li>卡仿真模式：这允许NFC设备像NFC标签一样工作并与外部读卡器或写卡器进行交互；</li>
</ol>
<p>这篇文章和fuzzer将仅查看Reader/Writer模式。Android NFC实现了NFC forum定义的各种类型的NFC tag，这是用于NFC通信的不同协议。与NFC tag进行交互时，Android设备可以充当Reader或Writer。虽然一个Writer可以执行更多类型的操作（并因此具有更大的攻面），但它通常需要第三方应用程序，例如这一个要安装特定程序以及用户交互以初始化写入。另一方面，只要NFC处于打开状态（默认设置）且屏幕处于活动状态，只要设备进入NFC标签范围，就会自动完成读取和检测NFC标签的操作。因此，读取器模式下的漏洞比写入器模式下的漏洞高得多的风险。</p>
<p>Android中的NFC组件是曾经是<a href="https://android-developers.googleblog.com/2019/05/queue-hardening-enhancements.html" target="_blank" rel="noopener">很多漏洞</a>的来源。在2018年，它是Android中严重程度最高的漏洞的第四大来源。这种趋势一直持续到2019年，Qi Zhao @JHyrathon and Guang Gong @oldfresher of Qihoo 360 Alpha Lab, and Xuan Xing of Google贡献了许多漏洞。</p>
<p>Qi Zhao在<a href="https://hitcon.org/2019/CMT/slide-files/d1_s2_r1.pdf" target="_blank" rel="noopener">此处</a>写了一篇有关NFC漏洞的详尽报告，解释了Android NFC的基本概念以及攻击面，并提供了一些很好的示例，因此在这里我不会重复他的工作，而将重点放在fuzz的方面。他还拥有一个repo，该repo展示了他发现的一些漏洞的PoC，这在本研究的早期非常有用。</p>
<h2 id="Structured-fuzzing-Android-NFC"><a href="#Structured-fuzzing-Android-NFC" class="headerlink" title="Structured fuzzing Android NFC"></a>Structured fuzzing Android NFC</h2><p>实际上，创建Android NFC fuzzer的思路与<a href="https://securitylab.github.com/research/fuzzing-sockets-FTP" target="_blank" rel="noopener">fuzz socket</a>非常相似，在Android上运行它有些复杂。由于Android对libFuzzer具有很好的支持，因此我们将使用libFuzzer和libprotobuf-mutator来实现structured fuzzing。</p>
<h3 id="Fuzzing环境设置"><a href="#Fuzzing环境设置" class="headerlink" title="Fuzzing环境设置"></a>Fuzzing环境设置</h3><p>Android NFC Reader/Writer组件使用消息循环来处理事件，该事件可能包含设备本身的内部事件或来自NFC tag的外部事件。此消息循环在以下nfc_task函数中实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> nfc_task(__attribute__((unused)) <span class="keyword">uint32_t</span> arg) &#123;</span><br><span class="line">  <span class="keyword">uint16_t</span> event;</span><br><span class="line">  NFC_HDR* p_msg;</span><br><span class="line">  <span class="keyword">bool</span> free_buf;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Initialize the nfc control block */</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;nfc_cb, <span class="number">0</span>, <span class="keyword">sizeof</span>(tNFC_CB));</span><br><span class="line"></span><br><span class="line">  DLOG_IF(INFO, nfc_debug_enabled) &lt;&lt; StringPrintf(<span class="string">"NFC_TASK started."</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* main loop */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    event = GKI_wait(<span class="number">0xFFFF</span>, <span class="number">0</span>); <span class="comment">//&lt;-- take an event from a task queue</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (event &amp; NFC_MBOX_EVT_MASK) &#123;</span><br><span class="line">      <span class="comment">/* Process all incoming NCI messages */</span></span><br><span class="line">      <span class="keyword">while</span> ((p_msg = (NFC_HDR*)GKI_read_mbox(NFC_MBOX_ID)) != <span class="literal">nullptr</span>) &#123; <span class="comment">//&lt;-- take a message from a queue</span></span><br><span class="line">        free_buf = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Determine the input message type. */</span></span><br><span class="line">        <span class="keyword">switch</span> (p_msg-&gt;event &amp; NFC_EVT_MASK) &#123;</span><br><span class="line">          <span class="keyword">case</span> BT_EVT_TO_NFC_NCI:</span><br><span class="line">            free_buf = nfc_ncif_process_event(p_msg);  <span class="comment">//&lt;--- processing the message</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">case</span> BT_EVT_TO_START_TIMER:</span><br><span class="line">             ...</span><br></pre></td></tr></table></figure>
<p>在上面，GKI_read_mbox负责将数据读取到消息（p_msg）中，然后在nfc_ncif_process_event函数中进行处理。带有NFC tag的通信在这里处理。</p>
<p>为了使我们免于设置各种任务队列并专注于可以由NFC标签控制的事件，我决定以该nfc_ncif_process_event函数为切入点，并实现一个更简单的消息循环，该循环将继续使用fuzzer的输入来调用此函数。 但是，获取入口点只是第一步。为了产生有用的结果，fuzzer需要是实际应用的合理近似值。这至少需要满足以下条件：1.我们可以从标签控制输入数据的哪一部分，例如，nfc_ncif_process_event在现实情况下会接收任意长度的消息吗？是否有硬件根据传入的数据填充了元数据？2.在读取/写入标签之前需要设置哪些状态变量，并且在每次读取/写入之后它们会重置吗？</p>
<p>经过大量测试后，我确定了上面p_msg处理的各种约束nfc_ncif_process_event，包括消息长度的约束以及一些元数据。然后，将这些知识用于实现各种harness_common.cc用于创建p_msgfuzz测试的方法以及用于设置fuzz测试环境的其他方法。在这一点上，fuzz可以从这开始：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">setup(PROTOCOL);</span><br><span class="line">nfa_rw_start_ndef_detection(); </span><br><span class="line">nfa_rw_cb.cur_op = NFA_RW_OP_READ_NDEF;</span><br><span class="line"><span class="keyword">uint8_t</span>[<span class="number">258</span>] buffer;</span><br><span class="line"><span class="keyword">size_t</span> data_len;</span><br><span class="line"><span class="keyword">while</span> (data_len = readSomeData(buffer)) &#123;</span><br><span class="line">  NFC_HDR* p_msg = create_data_msg_meta(data_len, buffer);</span><br><span class="line">  nfc_ncif_process_event(p_msg);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这不是一个非常有效的fuzzer，因为NFC协议期望消息数据具有某种结构，否则某些早期检查将失败。</p>
<h3 id="考虑到协议的特定细节"><a href="#考虑到协议的特定细节" class="headerlink" title="考虑到协议的特定细节"></a>考虑到协议的特定细节</h3><p>现在，我将限于NFC forum type 2 tag，该标记主要在rw_t2t.cc和中实现rw_t2t_ndef.cc。</p>
<p>nfc_ncif_process_event首先处理的消息到达rw_t2t_proc_data，在此处执行各种检查。在检测阶段，即设备首次与NFC标签接触时，如果所有对消息长度和元数据的检查都通过了，它将继续rw_t2t_handle_rsp进行，对实际数据进行更有趣的处理。</p>
<p>这些检查rw_t2t_proc_data对消息有相当严格的限制。基本上，这意味着每个消息都必须具有1（一个”ack”）或16（实际数据）的固定长度，除非子状态为RW_T2T_SUBSTATE_WAIT_SELECT_SECTOR_SUPPORT：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (p_t2t-&gt;substate == RW_T2T_SUBSTATE_WAIT_SELECT_SECTOR_SUPPORT) &#123;</span><br><span class="line">  <span class="comment">/* The select process happens in two steps */</span></span><br><span class="line">  <span class="keyword">if</span> ((*p &amp; <span class="number">0x0f</span>) == T2T_RSP_ACK) &#123;</span><br><span class="line">    <span class="keyword">if</span> (rw_t2t_sector_change(p_t2t-&gt;select_sector) == NFC_STATUS_OK)</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>为了满足这些约束，我在libFuzzer之上使用了libprotobuf-mutator为输入提供结构。这是一个非常有用的库，用于使用libFuzzer实现结构化的fuzz测试，并且已经取得了许多成功。它允许使用protobuf语法指定一种输入结构。就我而言，我希望每条消息的长度为16或1，因此我将2(int64)用作长度16的消息，并将第三个字段ack用作切换使用长度16或长度1的概率：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Generic response of fixed length</span></span><br><span class="line">message DefaultResponse &#123;</span><br><span class="line">  required int64 hdr_0 = <span class="number">1</span>;</span><br><span class="line">  required int64 hdr_1 = <span class="number">2</span>;</span><br><span class="line">  required uint32 ack = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ack解析时，该字段将转换为概率，以决定使用完整的16个字节还是仅使用1个字节。（基本检查了ack阈值）。</p>
<h3 id="考虑状态"><a href="#考虑状态" class="headerlink" title="考虑状态"></a>考虑状态</h3><p>如前所述，允许的消息长度还取决于Android NFC的子状态。这是相当不便的，因为随机生成的消息可能刚结束而不是所期望的消息并立即被拒绝。这也可能导致fuzzer“放弃”不太可能的状态（即，如果某些状态比其他状态更频繁地出现，则fuzzer可能会停止生成适用于较小状态的样本，而这些样本最终将根本无法进行测试）。为了解决这个问题，语料库中的每个样本都包含多个队列，每个状态一个，而不是从fuzzer生成单个线性队列，而fuzzer将根据当前状态决定从哪个队列中获取样本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">message DetectSession &#123;</span><br><span class="line">  repeated WaitSelectSector wait_select = <span class="number">1</span>;</span><br><span class="line">  repeated DefaultResponse dr = <span class="number">2</span>;</span><br><span class="line">  repeated WaitCc wait_cc = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，一个fuzz测试会话包含三个队列（repeated相当于protobuf中的array）。每个消息对应一个针对不同状态的专用消息，并且fuzzer根据实际状态决定使用哪个消息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">void handleT2T(const nfc::DetectSession&amp; session) &#123;</span><br><span class="line">  bool free_buf;</span><br><span class="line">  tRW_T2T_CB* p_t2t = &amp;rw_cb.tcb.t2t;</span><br><span class="line">  int wait_cc_counter = 0;</span><br><span class="line">  int default_message_counter = 0;</span><br><span class="line">  int wait_select_counter = 0;</span><br><span class="line">  for (int i = 0; i &lt; max_op; i++) &#123;</span><br><span class="line">    NFC_HDR* p_msgs[1] = &#123;0&#125;;</span><br><span class="line">    //Choose the appropriate message depending on the state</span><br><span class="line">    switch (p_t2t-&gt;substate) &#123;</span><br><span class="line">        case RW_T2T_SUBSTATE_WAIT_READ_CC:</span><br><span class="line">          if (wait_cc_counter &gt;= session.wait_cc_size()) return;</span><br><span class="line">          create_t2t_wait_cc(session.wait_cc(wait_cc_counter++), p_msgs);</span><br><span class="line">          break;</span><br><span class="line">        case RW_T2T_SUBSTATE_WAIT_SELECT_SECTOR:</span><br><span class="line">          if (wait_select_counter &gt;= session.wait_select_size()) return;</span><br><span class="line">          create_t2t_wait_select_sector(session.wait_select(wait_select_counter++), p_msgs);</span><br><span class="line">          break;</span><br><span class="line">        default:</span><br><span class="line">          if (default_message_counter &gt;= session.dr_size()) return;</span><br><span class="line">          create_t2t_default_response(session.dr(default_message_counter++), p_msgs);</span><br><span class="line">          break;</span><br><span class="line">    &#125;</span><br><span class="line">    if (*p_msgs) &#123;</span><br><span class="line">      set_message_len(*p_msgs);</span><br><span class="line">      NFC_HDR* msg = copy_msg(*p_msgs);</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尽管在当前情况下这种调整似乎没有收获，但我认为当州与州之间存在更多分歧时，这种调整将很有用。</p>
<h3 id="在枚举和数据之间切换"><a href="#在枚举和数据之间切换" class="headerlink" title="在枚举和数据之间切换"></a>在枚举和数据之间切换</h3><p>在负责解析NFC数据的代码中，我注意到数据本身有时被解释为枚举：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (p_t2t-&gt;substate) &#123;</span><br><span class="line">  <span class="keyword">case</span> RW_T2T_SUBSTATE_WAIT_TLV_DETECT:</span><br><span class="line">    <span class="comment">/* Search for the tlv */</span></span><br><span class="line">    p_t2t-&gt;found_tlv = p_data[offset++]; <span class="comment">//&lt;--- p_data is the user controlled data</span></span><br><span class="line">    <span class="keyword">switch</span> (p_t2t-&gt;found_tlv) &#123;  <span class="comment">//&lt;--- interpreted as enum</span></span><br><span class="line">      <span class="keyword">case</span> TAG_NULL_TLV: <span class="comment">/* May be used for padding. SHALL ignore this */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> TAG_NDEF_TLV:</span><br></pre></td></tr></table></figure>
<p>在其他时候，它可能被解释为数字：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> RW_T2T_SUBSTATE_WAIT_FIND_LEN_FIELD_LEN:</span><br><span class="line">  len = p_data[offset];  <span class="comment">//&lt;--- p_data is user controlled, </span></span><br><span class="line">   ...</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* one byte length field */</span></span><br><span class="line">        p_t2t-&gt;ndef_msg_len = len;   <span class="comment">//&lt;--- len interpreted as an actual number</span></span><br><span class="line">        p_t2t-&gt;bytes_count = p_t2t-&gt;ndef_msg_len;</span><br><span class="line">        p_t2t-&gt;substate = RW_T2T_SUBSTATE_WAIT_READ_TLV_VALUE;</span><br></pre></td></tr></table></figure>
<p>这种解释上的差异并不取决于offset。有时将具有相同偏移量的数据解释为枚举，而有时将其解释为数字，具体取决于之前的数据。这是一个问题，因为枚举只有六个有意义的值，而一个数字可能会占用整个范围。为了克服这个问题，我引入了一个将数据解释为枚举时将数字转换为枚举的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//converts uint8_t to one of the tlv states (see tags_defs.h)</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> uint8_t <span class="title">num2tlv</span><span class="params">(<span class="keyword">uint8_t</span> input)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (input % <span class="number">6</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      <span class="keyword">return</span> TAG_NULL_TLV;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">     <span class="keyword">switch</span> (p_t2t-&gt;substate) &#123;</span><br><span class="line">       <span class="keyword">case</span> RW_T2T_SUBSTATE_WAIT_TLV_DETECT:</span><br><span class="line">         <span class="comment">/* Search for the tlv */</span></span><br><span class="line">        p_t2t-&gt;found_tlv = p_data[offset++];</span><br><span class="line">        p_t2t-&gt;found_tlv = num2tlv(p_data[offset++]); <span class="comment">//&lt;--- Converts to enum</span></span><br><span class="line">         <span class="keyword">switch</span> (p_t2t-&gt;found_tlv) &#123;</span><br><span class="line">           <span class="keyword">case</span> TAG_NULL_TLV: <span class="comment">/* May be used for padding. SHALL ignore this */</span></span><br><span class="line">             <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>这样，uint8_t当需要枚举时，fuzzer仍可以生成fuzz范围内的数据，而不会被阻塞。</p>
<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>诚然，由于已经发现了许多漏洞，并且NFC 2型协议具有严格的限制（或多或少固定长度），当它在运行的几分钟内发现了四个OOB写入而没有输入语料库时，我感到有些惊讶。这些漏洞被披露为CVE-2020-0070/GHSL-2020-010, CVE-2020-0071/GHSL-2020-008, CVE-2020-0072/GHSL-2020-007, and CVE-2020-0073/GHSL-2020-006.。</p>
<p>这些都是OOB内部结构写的，ASAN（地址清理器）不会检测到。实际上，当我第一次崩溃时，这是因为其中一个错误最终覆盖了函数指针，并击中了控制流完整性（CFI）检查并崩溃了。更糟的是，libFuzzer似乎认为这是嵌套的崩溃，没有产生崩溃案例。通过引入一些手动断言，我最终能够重构测试用例。在与Antonio Morales进行了一些讨论之后，他指出，在某些情况下，ASAN无法检测到OOB写入而内部结构溢出就是其中一种情况。但是应该可以使用未定义的行为消毒器（UBSAN）来检测这些情况。因此，我接受了建议并将UBSAN边界检查包括在构建配置中：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sanitize : &#123;</span><br><span class="line">    misc_undefined: [</span><br><span class="line">        "bounds",</span><br><span class="line">    ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>然后，这将检测所有情况，而无需我的手动断言，并且在最终版本的fuzzer中使用了该情况。（请注意，未使用完整的UBSAN，因为UBSAN中的vtable检查使fuzz测试器无法使用，因为并非所有依赖项都在启用清除程序的情况下进行编译。）</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>在本文中，我描述了如何为Android NFC实现fuzzer，并展示了如何将结构化fuzz合并到fuzzer中以解决各种问题。它还显示了fuzz测试如何补充手动审核工作，即使在其他研究人员进行了大量审核之后，我仍然能够发现新的错误。</p>

                


<p class="pink-link-context">
    <a href="/2020/06/26/做安服时了解到的Android攻击面/" rel="next" title="做安服时了解到的Android攻击面">
    Next: 做安服时了解到的Android攻击面
  </a>
</p>


            </div>
			
        </div>
    </div>
</article>






</div>

        <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large pink">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect pink" title="Return to top"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse pink darken-1"  data-activates="main-menu" title="Menu"><i class="fa fa-navicon"></i></a></li>
    </ul>
  </div>

    </main>
    <footer class="page-footer pink accent-1 darken-1">
    
    <div class="footer-container container">
        <div class="row">
            
            <div class="social-group col m4 s12">
                <h5 class="white-text">Social</h5>
                
                    <a class="social-link" href="https://github.com/cracke-s-j" target="_blank">
                        <i class="fa fa-2x fa-github"></i>
                    </a>
                
                

            </div>
            

            
            <div class="col m8 s12">
                <h5 class="white-text">Links</h5>
                
                    <a class="social-link" href="https://blog.dyf.ink/" target="_blank">友情链接 dyf&#39;s blog</a>
                
            </div>
            
        </div>
    </div>
    

    <div class="footer-copyright pink-link-context">
        <div class="container">
            © 2020 ssj, All rights reserved.
            <p class="right" style="margin-top: 0;">Blog powered by <a href="https://hexo.io">Hexo</a> | Theme <a href="https://github.com/raytaylorlin/hexo-theme-raytaylorism">raytaylorism</a></p>
        </div>
    </div>
</footer>


    <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>

<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();

            // 目录随屏幕滚动（防止目录过长越过footer）
            var $toc = $('.toc');
            var scrollTargetTop = 0;
            $(window).scroll(function() {
                var $activeLink = $toc.find('a.active.section');
                if ($(window).scrollTop() < 100) {
                    scrollTargetTop = 0;
                } else {
                    if ($activeLink[0]) {
                        scrollTargetTop = $activeLink.offset().top - $toc.offset().top;
                    }
                }
                $toc.css('top', '-' + scrollTargetTop + 'px');
            });

            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass('pink lighten-2');

            
            // 添加new标签
            $('').append('<span class="new badge pink"></span>');
            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<script type="text/javascript" async
  src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"superSample":2,"width":250,"height":500,"position":"left","hOffset":0,"vOffset":-100},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
