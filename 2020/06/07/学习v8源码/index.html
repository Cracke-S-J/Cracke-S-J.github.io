<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    

    <title>通过hello-world.cc学习v8源码 | </title>
    <meta name="author" content="ssj">
    
    <meta name="description" content="人总是会变的，以前我想变成风去推动风车，现在我想等风起。——大蛇丸

我为什么要学习v8源码v8源码这个坑，给人感觉可能只有前端大佬会去趟，我这种前端只会写两句半的猹猹为什么要学习，因为我最近在学习又好搭环境又好利用的浏览器漏洞，目前fuzz无从fuzz，甚至漏洞点原理结合poc都看不太懂，我觉得原">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="通过hello-world.cc学习v8源码">
    <meta property="og:site_name" content="ssj&#39;s blog">

    
    <meta property="og:image" content>
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="ssj&#39;s blog" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/tranquil-heart.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>
</html>

<body>
    <img src="/weixin_favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

    <nav class="pink accent-1">
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class="">
            <a href="/" class="brand-logo hide-on-med-and-down">ssj&#39;s blog</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " href="/" >
                            <i class="fa fa-home "></i>
                            
                            Home
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " href="/archives" >
                            <i class="fa fa-archive "></i>
                            
                            Archives
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                            <i class="fa fa-bookmark "></i>
                            
                            Categories
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-reading " href="/reading" >
                            <i class="fa fa-book "></i>
                            
                            Reading
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-about " href="/about" >
                            <i class="fa fa-user "></i>
                            
                            About
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-search modal-trigger " href="#search" >
                            <i class="fa fa-search "></i>
                            
                            Search
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav pink darken-1" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="/pingtou.jpg" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">ssj</p>
                        <p class="desc"></p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/" >
                    <i class="fa fa-home "></i>
                    
                    Home
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives" >
                    <i class="fa fa-archive "></i>
                    
                    Archives
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                    <i class="fa fa-bookmark "></i>
                    
                    Categories
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-reading " href="/reading" >
                    <i class="fa fa-book "></i>
                    
                    Reading
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-about " href="/about" >
                    <i class="fa fa-user "></i>
                    
                    About
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-search modal-trigger " href="#search" >
                    <i class="fa fa-search "></i>
                    
                    Search
                </a>
            </li>
        
    </ul>

    <ul class="side-nav pink darken-1" id="category-menu">
    

            

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Android/">
                    Android <span class="right">13</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/Android/脱壳/">
                    脱壳 <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/Android/马甲包/">
                    马甲包 <span class="right">2</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Ethereum/">
                    Ethereum <span class="right">3</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Fuzz/">
                    Fuzz <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/二进制/">
                    二进制 <span class="right">11</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/二进制/v8/">
                    v8 <span class="right">6</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/二进制/Base/">
                    Base <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/二进制/Kernel/">
                    Kernel <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/二进制/vm/">
                    vm <span class="right">2</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/二进制/Docs/">
                    Docs <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/CVE/">
                    CVE <span class="right">11</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/CTF/">
                    CTF <span class="right">8</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/CTF/pwn/">
                    pwn <span class="right">7</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/CTF/Android/">
                    Android <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/面试体验/">
                    面试体验 <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/面试体验/Android/">
                    Android <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/杂/">
                    杂 <span class="right">5</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/杂/听戏/">
                    听戏 <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/杂/定场诗/">
                    定场诗 <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/杂/京剧/">
                    京剧 <span class="right">3</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/基础知识/">
                    基础知识 <span class="right">2</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/基础知识/Cpp/">
                    Cpp <span class="right">1</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/算法/">
                    算法 <span class="right">1</span></a>
                </a>
            </li>

        

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">Search</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


    <main>
        <div class="container main-container">
    <nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper pink">
        <span class="breadcrumb">Current page(Categories)</span>
        
            
    
    
    <a class="breadcrumb" href="/categories/二进制/">二进制</a><a class="breadcrumb" href="/categories/二进制/v8/">v8</a>


        

        
    </div>
</nav>

<article>
    <div class="card">
        <div class="card-content">
            

            <div class="article-title">
                
    
        <h1>通过hello-world.cc学习v8源码</h1>
    


            </div>
            <time class="pink-link-context" datetime="2020-06-07T10:09:46.000Z"><a href="/2020/06/07/学习v8源码/">2020-06-07</a></time>

            <span id="busuanzi_container_page_pv" class="read-times-container">
    <i class="fa fa-eye"></i>
    <span id="busuanzi_value_page_pv"></span>
</span>

            
    <div class="tags-row">
        
            <a href="/tags/二进制/" class="chip pink lighten-1">二进制</a>
        
            <a href="/tags/v8/" class="chip pink lighten-1">v8</a>
        
    </div>


            <div class="toc pink-link-context hide-on-med-and-down">
    <ol class="section table-of-contents"><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#我为什么要学习v8源码"><span class="section table-of-contents-text">我为什么要学习v8源码</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#常见v8漏洞点产生原因"><span class="section table-of-contents-text">常见v8漏洞点产生原因</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#用libfuzzer-fuzz-v8"><span class="section table-of-contents-text">用libfuzzer fuzz v8</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#samples-hello-world-cc"><span class="section table-of-contents-text">samples/hello-world.cc</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#初始化阶段"><span class="section table-of-contents-text">初始化阶段</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#Create-a-new-Isolate-and-make-it-the-current-one"><span class="section table-of-contents-text">Create a new Isolate and make it the current one</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#编译执行代码"><span class="section table-of-contents-text">编译执行代码</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#细看一下v8-Script-Compile"><span class="section table-of-contents-text">细看一下v8::Script::Compile()</span></a></li><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#再看Script-Run"><span class="section table-of-contents-text">再看Script::Run()</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#退出，释放资源"><span class="section table-of-contents-text">退出，释放资源</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#后记"><span class="section table-of-contents-text">后记</span></a></li></ol>
</div>


            <div class="entry pink-link-context">
                <blockquote>
<p>人总是会变的，以前我想变成风去推动风车，现在我想等风起。——大蛇丸</p>
</blockquote>
<h2 id="我为什么要学习v8源码"><a href="#我为什么要学习v8源码" class="headerlink" title="我为什么要学习v8源码"></a>我为什么要学习v8源码</h2><p>v8源码这个坑，给人感觉可能只有前端大佬会去趟，我这种前端只会写两句半的猹猹为什么要学习，因为我最近在学习又好搭环境又好利用的浏览器漏洞，目前fuzz无从fuzz，甚至漏洞点原理结合poc都看不太懂，我觉得原理是没有搂一遍v8源码，熟悉一下。</p>
<h3 id="常见v8漏洞点产生原因"><a href="#常见v8漏洞点产生原因" class="headerlink" title="常见v8漏洞点产生原因"></a>常见v8漏洞点产生原因</h3><ul>
<li>遍历优化过程中信息不匹配造成的类型混淆</li>
<li>优化过程中变量范围或者啥的计算错误</li>
<li>（不会了</li>
</ul>
<p>可见不像c的漏洞那种，用了个realloc，double free了，或者条件竞争什么的容易看出，这种漏洞点要懂编译器。</p>
<h3 id="用libfuzzer-fuzz-v8"><a href="#用libfuzzer-fuzz-v8" class="headerlink" title="用libfuzzer fuzz v8"></a>用libfuzzer fuzz v8</h3><p><a href="https://yq.aliyun.com/articles/215709" target="_blank" rel="noopener">https://yq.aliyun.com/articles/215709</a></p>
<p>总之就是v8自带fuzzer的，去fuzz就行了，可是这个fuzz怎么写的，原理怎么，我现在并不清楚，要fuzz的点也不清楚。</p>
<h2 id="samples-hello-world-cc"><a href="#samples-hello-world-cc" class="headerlink" title="samples/hello-world.cc"></a>samples/hello-world.cc</h2><h3 id="初始化阶段"><a href="#初始化阶段" class="headerlink" title="初始化阶段"></a>初始化阶段</h3><p>v8代码中有一些样例，首先通过这个<code>hello-world.cc</code>来看一下这整体编译流程。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Initialize V8.</span></span><br><span class="line">  v8::V8::InitializeICUDefaultLocation(argv[<span class="number">0</span>]);</span><br><span class="line">  v8::V8::InitializeExternalStartupData(argv[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;v8::Platform&gt; platform = v8::platform::NewDefaultPlatform();</span><br><span class="line">  v8::V8::InitializePlatform(platform.get());</span><br><span class="line">  v8::V8::Initialize();</span><br></pre></td></tr></table></figure>
<ul>
<li>v8::V8::InitializeICUDefaultLocation(argv[0]);</li>
</ul>
<p>ICU听起来像996icu，但是它并不是那个缩写，它是一个国际化的库。</p>
<blockquote>
<p>What is ICU?<br>ICU is a cross-platform Unicode based globalization library. It includes support for locale-sensitive string comparison, date/time/number/currency/message formatting, text boundary detection, character set conversion and so on.You can build V8 without ICU library with build option i18nsupport=off. In this case you need to initialize builtin ICU:<br>v8::V8::InitializeICU();</p>
</blockquote>
<ul>
<li>v8::V8::InitializeExternalStartupData(argv[0]);</li>
</ul>
<p>判断了有无这个宏<code>V8_USE_EXTERNAL_STARTUP_DATA</code>，如果有，初始化<code>snapshot</code>.</p>
<ul>
<li>std::unique_ptr<a href="v8::Platform" target="_blank" rel="noopener">v8::Platform</a> platform = v8::platform::NewDefaultPlatform();</li>
</ul>
<p>然后创建一个platform，从它的接口大致能看出他是干嘛的，用来管理isolate，管理线程池等：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * V8 Platform abstraction layer.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The embedder has to provide an implementation of this interface before</span></span><br><span class="line"><span class="comment"> * initializing the rest of V8.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Platform</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~Platform() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Allows the embedder to manage memory page allocations.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> PageAllocator* <span class="title">GetPageAllocator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// TODO(bbudge) Make this abstract after all embedders implement this.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Enables the embedder to respond in cases where V8 can't allocate large</span></span><br><span class="line"><span class="comment">   * blocks of memory. V8 retries the failed allocation once after calling this</span></span><br><span class="line"><span class="comment">   * method. On success, execution continues; otherwise V8 exits with a fatal</span></span><br><span class="line"><span class="comment">   * error.</span></span><br><span class="line"><span class="comment">   * Embedder overrides of this function must NOT call back into V8.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnCriticalMemoryPressure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// TODO(bbudge) Remove this when embedders override the following method.</span></span><br><span class="line">    <span class="comment">// See crbug.com/634547.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Enables the embedder to respond in cases where V8 can't allocate large</span></span><br><span class="line"><span class="comment">   * memory regions. The |length| parameter is the amount of memory needed.</span></span><br><span class="line"><span class="comment">   * Returns true if memory is now available. Returns false if no memory could</span></span><br><span class="line"><span class="comment">   * be made available. V8 will retry allocations until this method returns</span></span><br><span class="line"><span class="comment">   * false.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Embedder overrides of this function must NOT call back into V8.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">OnCriticalMemoryPressure</span><span class="params">(<span class="keyword">size_t</span> length)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Gets the number of worker threads used by</span></span><br><span class="line"><span class="comment">   * Call(BlockingTask)OnWorkerThread(). This can be used to estimate the number</span></span><br><span class="line"><span class="comment">   * of tasks a work package should be split into. A return value of 0 means</span></span><br><span class="line"><span class="comment">   * that there are no worker threads available. Note that a value of 0 won't</span></span><br><span class="line"><span class="comment">   * prohibit V8 from posting tasks using |CallOnWorkerThread|.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">NumberOfWorkerThreads</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns a TaskRunner which can be used to post a task on the foreground.</span></span><br><span class="line"><span class="comment">   * The TaskRunner's NonNestableTasksEnabled() must be true. This function</span></span><br><span class="line"><span class="comment">   * should only be called from a foreground thread.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">virtual</span> <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;v8::TaskRunner&gt; GetForegroundTaskRunner(</span><br><span class="line">      Isolate* isolate) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Schedules a task to be invoked on a worker thread.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CallOnWorkerThread</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Task&gt; task)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Schedules a task that blocks the main thread to be invoked with</span></span><br><span class="line"><span class="comment">   * high-priority on a worker thread.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CallBlockingTaskOnWorkerThread</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Task&gt; task)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Embedders may optionally override this to process these tasks in a high</span></span><br><span class="line">    <span class="comment">// priority pool.</span></span><br><span class="line">    CallOnWorkerThread(<span class="built_in">std</span>::move(task));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Schedules a task to be invoked with low-priority on a worker thread.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CallLowPriorityTaskOnWorkerThread</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Task&gt; task)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Embedders may optionally override this to process these tasks in a low</span></span><br><span class="line">    <span class="comment">// priority pool.</span></span><br><span class="line">    CallOnWorkerThread(<span class="built_in">std</span>::move(task));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Schedules a task to be invoked on a worker thread after |delay_in_seconds|</span></span><br><span class="line"><span class="comment">   * expires.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CallDelayedOnWorkerThread</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Task&gt; task,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         <span class="keyword">double</span> delay_in_seconds)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns true if idle tasks are enabled for the given |isolate|.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IdleTasksEnabled</span><span class="params">(Isolate* isolate)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Posts |job_task| to run in parallel. Returns a JobHandle associated with</span></span><br><span class="line"><span class="comment">   * the Job, which can be joined or canceled.</span></span><br><span class="line"><span class="comment">   * This avoids degenerate cases:</span></span><br><span class="line"><span class="comment">   * - Calling CallOnWorkerThread() for each work item, causing significant</span></span><br><span class="line"><span class="comment">   *   overhead.</span></span><br><span class="line"><span class="comment">   * - Fixed number of CallOnWorkerThread() calls that split the work and might</span></span><br><span class="line"><span class="comment">   *   run for a long time. This is problematic when many components post</span></span><br><span class="line"><span class="comment">   *   "num cores" tasks and all expect to use all the cores. In these cases,</span></span><br><span class="line"><span class="comment">   *   the scheduler lacks context to be fair to multiple same-priority requests</span></span><br><span class="line"><span class="comment">   *   and/or ability to request lower priority work to yield when high priority</span></span><br><span class="line"><span class="comment">   *   work comes in.</span></span><br><span class="line"><span class="comment">   * A canonical implementation of |job_task| looks like:</span></span><br><span class="line"><span class="comment">   * class MyJobTask : public JobTask &#123;</span></span><br><span class="line"><span class="comment">   *  public:</span></span><br><span class="line"><span class="comment">   *   MyJobTask(...) : worker_queue_(...) &#123;&#125;</span></span><br><span class="line"><span class="comment">   *   // JobTask:</span></span><br><span class="line"><span class="comment">   *   void Run(JobDelegate* delegate) override &#123;</span></span><br><span class="line"><span class="comment">   *     while (!delegate-&gt;ShouldYield()) &#123;</span></span><br><span class="line"><span class="comment">   *       // Smallest unit of work.</span></span><br><span class="line"><span class="comment">   *       auto work_item = worker_queue_.TakeWorkItem(); // Thread safe.</span></span><br><span class="line"><span class="comment">   *       if (!work_item) return;</span></span><br><span class="line"><span class="comment">   *       ProcessWork(work_item);</span></span><br><span class="line"><span class="comment">   *     &#125;</span></span><br><span class="line"><span class="comment">   *   &#125;</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *   size_t GetMaxConcurrency() const override &#123;</span></span><br><span class="line"><span class="comment">   *     return worker_queue_.GetSize(); // Thread safe.</span></span><br><span class="line"><span class="comment">   *   &#125;</span></span><br><span class="line"><span class="comment">   * &#125;;</span></span><br><span class="line"><span class="comment">   * auto handle = PostJob(TaskPriority::kUserVisible,</span></span><br><span class="line"><span class="comment">   *                       std::make_unique&lt;MyJobTask&gt;(...));</span></span><br><span class="line"><span class="comment">   * handle-&gt;Join();</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * PostJob() and methods of the returned JobHandle/JobDelegate, must never be</span></span><br><span class="line"><span class="comment">   * called while holding a lock that could be acquired by JobTask::Run or</span></span><br><span class="line"><span class="comment">   * JobTask::GetMaxConcurrency -- that could result in a deadlock. This is</span></span><br><span class="line"><span class="comment">   * because [1] JobTask::GetMaxConcurrency may be invoked while holding</span></span><br><span class="line"><span class="comment">   * internal lock (A), hence JobTask::GetMaxConcurrency can only use a lock (B)</span></span><br><span class="line"><span class="comment">   * if that lock is *never* held while calling back into JobHandle from any</span></span><br><span class="line"><span class="comment">   * thread (A=&gt;B/B=&gt;A deadlock) and [2] JobTask::Run or</span></span><br><span class="line"><span class="comment">   * JobTask::GetMaxConcurrency may be invoked synchronously from JobHandle</span></span><br><span class="line"><span class="comment">   * (B=&gt;JobHandle::foo=&gt;B deadlock).</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * A sufficient PostJob() implementation that uses the default Job provided in</span></span><br><span class="line"><span class="comment">   * libplatform looks like:</span></span><br><span class="line"><span class="comment">   *  std::unique_ptr&lt;JobHandle&gt; PostJob(</span></span><br><span class="line"><span class="comment">   *      TaskPriority priority, std::unique_ptr&lt;JobTask&gt; job_task) override &#123;</span></span><br><span class="line"><span class="comment">   *    return std::make_unique&lt;DefaultJobHandle&gt;(</span></span><br><span class="line"><span class="comment">   *        std::make_shared&lt;DefaultJobState&gt;(</span></span><br><span class="line"><span class="comment">   *            this, std::move(job_task), kNumThreads));</span></span><br><span class="line"><span class="comment">   * &#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">virtual</span> <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;JobHandle&gt; PostJob(</span><br><span class="line">      TaskPriority priority, <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;JobTask&gt; job_task) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Monotonically increasing time in seconds from an arbitrary fixed point in</span></span><br><span class="line"><span class="comment">   * the past. This function is expected to return at least</span></span><br><span class="line"><span class="comment">   * millisecond-precision values. For this reason,</span></span><br><span class="line"><span class="comment">   * it is recommended that the fixed point be no further in the past than</span></span><br><span class="line"><span class="comment">   * the epoch.</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">double</span> <span class="title">MonotonicallyIncreasingTime</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Current wall-clock time in milliseconds since epoch.</span></span><br><span class="line"><span class="comment">   * This function is expected to return at least millisecond-precision values.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">double</span> <span class="title">CurrentClockTimeMillis</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*StackTracePrinter)</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns a function pointer that print a stack trace of the current stack</span></span><br><span class="line"><span class="comment">   * on invocation. Disables printing of the stack trace if nullptr.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> StackTracePrinter <span class="title">GetStackTracePrinter</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="literal">nullptr</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns an instance of a v8::TracingController. This must be non-nullptr.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> TracingController* <span class="title">GetTracingController</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Tells the embedder to generate and upload a crashdump during an unexpected</span></span><br><span class="line"><span class="comment">   * but non-critical scenario.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DumpWithoutCrashing</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Default implementation of current wall-clock time in milliseconds</span></span><br><span class="line"><span class="comment">   * since epoch. Useful for implementing |CurrentClockTimeMillis| if</span></span><br><span class="line"><span class="comment">   * nothing special needed.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">V8_EXPORT <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">SystemClockTimeMillis</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace v8</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// V8_V8_PLATFORM_H_</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>v8::V8::InitializePlatform(platform.get());</li>
</ul>
<p>见名知义，是初始化platform的。</p>
<ul>
<li>v8::V8::Initialize();</li>
</ul>
<p>包含着递归很多层的Initialize。。</p>
<h3 id="Create-a-new-Isolate-and-make-it-the-current-one"><a href="#Create-a-new-Isolate-and-make-it-the-current-one" class="headerlink" title="Create a new Isolate and make it the current one"></a>Create a new Isolate and make it the current one</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a new Isolate and make it the current one.</span></span><br><span class="line">v8::Isolate::CreateParams create_params;</span><br><span class="line">create_params.array_buffer_allocator =</span><br><span class="line">    v8::ArrayBuffer::Allocator::NewDefaultAllocator();</span><br><span class="line">v8::Isolate* isolate = v8::Isolate::New(create_params);</span><br></pre></td></tr></table></figure>
<p>用create_params为参数创建一个isolate；设置数组分配器<code>array_buffer_allocator</code>；然后创建一个单独的v8引擎实例，isolate有完全独立的状态，对象在isolate之间不能共享。我们可以创建多个isolate，然后再不同的线程中使用。isolate在一个时刻只能由一个线程执行，多线程时必须加锁保证同步。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v8::Isolate::<span class="function">Scope <span class="title">isolate_scope</span><span class="params">(isolate)</span></span>;</span><br></pre></td></tr></table></figure>
<p>创建isolate的一个范围，用来给每个引擎设置一个单独执行的环境。该对象只能在栈上分配。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a stack-allocated handle scope.</span></span><br><span class="line">v8::<span class="function">HandleScope <span class="title">handle_scope</span><span class="params">(isolate)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a new context.</span></span><br><span class="line">v8::Local&lt;v8::Context&gt; context = v8::Context::New(isolate);</span><br></pre></td></tr></table></figure>
<p>这一段解释一下handle和context的概念。</p>
<p>context可以理解为上下文，一个有自己内置函数和对象的执行环境，因为JavaScript非常动态，所以可能会有很多执行环境，context可以嵌套，我们可以从一个context进入另一个context，然后再退出。</p>
<p>handle是用来管理context的，我们也可以直接指针持有context，但是v8同时也在管理context，所以为了方便加了一层抽象层用handle来管理context，我们就不用管v8如何去处理这些内存了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Enter the context for compiling and running the hello world script.</span></span><br><span class="line">v8::Context::<span class="function">Scope <span class="title">context_scope</span><span class="params">(context)</span></span>;</span><br></pre></td></tr></table></figure>
<p>这个看起来是要进入当前跑hello world的执行环境。</p>
<h3 id="编译执行代码"><a href="#编译执行代码" class="headerlink" title="编译执行代码"></a>编译执行代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Create a string containing the JavaScript source code.</span></span><br><span class="line">    v8::Local&lt;v8::String&gt; source =</span><br><span class="line">        v8::String::NewFromUtf8Literal(isolate, <span class="string">"'Hello' + ', World!'"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Compile the source code.</span></span><br><span class="line">    v8::Local&lt;v8::Script&gt; script =</span><br><span class="line">        v8::Script::Compile(context, source).ToLocalChecked();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run the script to get the result.</span></span><br><span class="line">    v8::Local&lt;v8::Value&gt; result = script-&gt;Run(context).ToLocalChecked();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Convert the result to an UTF8 string and print it.</span></span><br><span class="line">    v8::String::<span class="function">Utf8Value <span class="title">utf8</span><span class="params">(isolate, result)</span></span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, *utf8);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段是先创建一段源代码，就是<code>&#39;hello&#39; + &#39;, world&#39;</code>；然后compile，然后run，最后把结果输出到屏幕上。</p>
<h4 id="细看一下v8-Script-Compile"><a href="#细看一下v8-Script-Compile" class="headerlink" title="细看一下v8::Script::Compile()"></a>细看一下<code>v8::Script::Compile()</code></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ScriptCompiler::<span class="function">Source <span class="title">script_source</span><span class="params">(source)</span></span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">ScriptCompiler::Source::Source(Local&lt;String&gt; <span class="built_in">string</span>,</span><br><span class="line">                               CachedData* data)</span><br><span class="line">    : source_string(<span class="built_in">string</span>), cached_data(data) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这两句话，首先创建了Source，然后调用了下面那个函数，其中很两个参数都是默认值，<code>kNoCompileOptions</code>和<code>kNoCacheNoReason</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MaybeLocal&lt;Script&gt; ScriptCompiler::Compile(Local&lt;Context&gt; context,</span><br><span class="line">                                           Source* source,</span><br><span class="line">                                           CompileOptions options,</span><br><span class="line">                                           NoCacheReason no_cache_reason) &#123;</span><br><span class="line">  Utils::ApiCheck(</span><br><span class="line">      !source-&gt;GetResourceOptions().IsModule(), <span class="string">"v8::ScriptCompiler::Compile"</span>,</span><br><span class="line">      <span class="string">"v8::ScriptCompiler::CompileModule must be used to compile modules"</span>);</span><br><span class="line">  <span class="keyword">auto</span> isolate = context-&gt;GetIsolate();</span><br><span class="line">  <span class="keyword">auto</span> maybe =</span><br><span class="line">      CompileUnboundInternal(isolate, source, options, no_cache_reason);</span><br><span class="line">  Local&lt;UnboundScript&gt; result;</span><br><span class="line">  <span class="keyword">if</span> (!maybe.ToLocal(&amp;result)) <span class="keyword">return</span> MaybeLocal&lt;Script&gt;();</span><br><span class="line">  v8::Context::<span class="function">Scope <span class="title">scope</span><span class="params">(context)</span></span>;</span><br><span class="line">  <span class="keyword">return</span> result-&gt;BindToCurrentContext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里补充一句，v8几乎满篇都是<code>ToLocal</code>、<code>ToLocalCbecked</code>什么的，<code>ToLocal</code>和<code>OpenHandle</code>是v8用来转换内部类和外部类的，Checked表示不为空，如果为空会直接抛出异常。可以看么这个函数前后有一些检查，然后就是<code>CompileUnboundInternal</code>这个函数了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">MaybeLocal&lt;UnboundScript&gt; ScriptCompiler::CompileUnboundInternal(</span><br><span class="line">    Isolate* v8_isolate, Source* source, CompileOptions options,</span><br><span class="line">    NoCacheReason no_cache_reason) &#123;</span><br><span class="line">  <span class="keyword">auto</span> isolate = <span class="keyword">reinterpret_cast</span>&lt;i::Isolate*&gt;(v8_isolate);</span><br><span class="line">  TRACE_EVENT_CALL_STATS_SCOPED(isolate, <span class="string">"v8"</span>, <span class="string">"V8.ScriptCompiler"</span>);</span><br><span class="line">  ENTER_V8_NO_SCRIPT(isolate, v8_isolate-&gt;GetCurrentContext(), ScriptCompiler,</span><br><span class="line">                     CompileUnbound, MaybeLocal&lt;UnboundScript&gt;(),</span><br><span class="line">                     InternalEscapableScope);</span><br><span class="line"></span><br><span class="line">  i::ScriptData* script_data = <span class="literal">nullptr</span>;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  i::Handle&lt;i::String&gt; str = Utils::OpenHandle(*(source-&gt;source_string));</span><br><span class="line">  i::Handle&lt;i::SharedFunctionInfo&gt; result;</span><br><span class="line">  TRACE_EVENT0(TRACE_DISABLED_BY_DEFAULT(<span class="string">"v8.compile"</span>), <span class="string">"V8.CompileScript"</span>);</span><br><span class="line">  i::Compiler::ScriptDetails script_details = GetScriptDetails(</span><br><span class="line">      isolate, source-&gt;resource_name, source-&gt;resource_line_offset,</span><br><span class="line">      source-&gt;resource_column_offset, source-&gt;source_map_url,</span><br><span class="line">      source-&gt;host_defined_options);</span><br><span class="line">  i::MaybeHandle&lt;i::SharedFunctionInfo&gt; maybe_function_info =</span><br><span class="line">      i::Compiler::GetSharedFunctionInfoForScript(</span><br><span class="line">          isolate, str, script_details, source-&gt;resource_options, <span class="literal">nullptr</span>,</span><br><span class="line">          script_data, options, no_cache_reason, i::NOT_NATIVES_CODE);</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> script_data;</span><br><span class="line">  has_pending_exception = !maybe_function_info.ToHandle(&amp;result);</span><br><span class="line">  RETURN_ON_FAILED_EXECUTION(UnboundScript);</span><br><span class="line">  RETURN_ESCAPED(ToApiHandle&lt;UnboundScript&gt;(result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>忽略其它操作直接进入<code>GetSharedFunctionInfoForScript</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">MaybeHandle&lt;SharedFunctionInfo&gt; Compiler::GetSharedFunctionInfoForScript(</span><br><span class="line">    Isolate* isolate, Handle&lt;String&gt; source,</span><br><span class="line">    <span class="keyword">const</span> Compiler::ScriptDetails&amp; script_details,</span><br><span class="line">    ScriptOriginOptions origin_options, v8::Extension* extension,</span><br><span class="line">    ScriptData* cached_data, ScriptCompiler::CompileOptions compile_options,</span><br><span class="line">    ScriptCompiler::NoCacheReason no_cache_reason, NativesFlag natives) &#123;</span><br><span class="line">  <span class="function">ScriptCompileTimerScope <span class="title">compile_timer</span><span class="params">(isolate, no_cache_reason)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (compile_options == ScriptCompiler::kNoCompileOptions ||</span><br><span class="line">      compile_options == ScriptCompiler::kEagerCompile) &#123;</span><br><span class="line">    DCHECK_NULL(cached_data);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    DCHECK(compile_options == ScriptCompiler::kConsumeCodeCache);</span><br><span class="line">    DCHECK(cached_data);</span><br><span class="line">    DCHECK_NULL(extension);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> source_length = source-&gt;length();</span><br><span class="line">  isolate-&gt;counters()-&gt;total_load_size()-&gt;Increment(source_length);</span><br><span class="line">  isolate-&gt;counters()-&gt;total_compile_size()-&gt;Increment(source_length);</span><br><span class="line"></span><br><span class="line">  LanguageMode language_mode = construct_language_mode(FLAG_use_strict);</span><br><span class="line">  CompilationCache* compilation_cache = isolate-&gt;compilation_cache();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Do a lookup in the compilation cache but not for extensions.</span></span><br><span class="line">  <span class="comment">// 找cache主要是在每个isolate里找看有没有compilation的cache，如果有，直接反序列化取出来用</span></span><br><span class="line">  <span class="comment">// 下面就不粘找cache的代码了，直接看编译过程</span></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (maybe_result.is_null()) &#123;</span><br><span class="line">    <span class="comment">// No cache entry found compile the script.</span></span><br><span class="line">    <span class="keyword">if</span> (FLAG_stress_background_compile &amp;&amp;</span><br><span class="line">        CanBackgroundCompile(script_details, origin_options, extension,</span><br><span class="line">                             compile_options, natives)) &#123;</span><br><span class="line">      <span class="comment">// If the --stress-background-compile flag is set, do the actual</span></span><br><span class="line">      <span class="comment">// compilation on a background thread, and wait for its result.</span></span><br><span class="line">      maybe_result = CompileScriptOnBothBackgroundAndMainThread(</span><br><span class="line">          source, script_details, origin_options, isolate, &amp;is_compiled_scope);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      UnoptimizedCompileFlags flags =</span><br><span class="line">          UnoptimizedCompileFlags::ForToplevelCompile(</span><br><span class="line">              isolate, natives == NOT_NATIVES_CODE, language_mode,</span><br><span class="line">              script_details.repl_mode);</span><br><span class="line"></span><br><span class="line">      flags.set_is_eager(compile_options == ScriptCompiler::kEagerCompile);</span><br><span class="line">      flags.set_is_module(origin_options.IsModule());</span><br><span class="line"></span><br><span class="line">      maybe_result = CompileScriptOnMainThread(</span><br><span class="line">          flags, source, script_details, origin_options, natives, extension,</span><br><span class="line">          isolate, &amp;is_compiled_scope);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add the result to the isolate cache.</span></span><br><span class="line">    Handle&lt;SharedFunctionInfo&gt; result;</span><br><span class="line">    <span class="keyword">if</span> (extension == <span class="literal">nullptr</span> &amp;&amp; maybe_result.ToHandle(&amp;result)) &#123;</span><br><span class="line">      DCHECK(is_compiled_scope.is_compiled());</span><br><span class="line">      compilation_cache-&gt;PutScript(source, isolate-&gt;native_context(),</span><br><span class="line">                                   language_mode, result);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (maybe_result.is_null() &amp;&amp; natives != EXTENSION_CODE) &#123;</span><br><span class="line">      isolate-&gt;ReportPendingMessages();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> maybe_result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现主要函数是<code>CompileScriptOnMainThread</code>和<code>CompileScriptOnBothBackgroundAndMainThread</code>，随便进一个看下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MaybeHandle&lt;SharedFunctionInfo&gt; CompileScriptOnMainThread(</span><br><span class="line">    <span class="keyword">const</span> UnoptimizedCompileFlags flags, Handle&lt;String&gt; source,</span><br><span class="line">    <span class="keyword">const</span> Compiler::ScriptDetails&amp; script_details,</span><br><span class="line">    ScriptOriginOptions origin_options, NativesFlag natives,</span><br><span class="line">    v8::Extension* extension, Isolate* isolate,</span><br><span class="line">    IsCompiledScope* is_compiled_scope) &#123;</span><br><span class="line">  <span class="function">UnoptimizedCompileState <span class="title">compile_state</span><span class="params">(isolate)</span></span>;</span><br><span class="line">  <span class="function">ParseInfo <span class="title">parse_info</span><span class="params">(isolate, flags, &amp;compile_state)</span></span>;</span><br><span class="line">  parse_info.set_extension(extension);</span><br><span class="line"></span><br><span class="line">  Handle&lt;Script&gt; script = NewScript(isolate, &amp;parse_info, source,</span><br><span class="line">                                    script_details, origin_options, natives);</span><br><span class="line">  DCHECK_IMPLIES(parse_info.flags().collect_type_profile(),</span><br><span class="line">                 script-&gt;IsUserJavaScript());</span><br><span class="line">  DCHECK_EQ(parse_info.flags().is_repl_mode(), script-&gt;is_repl_mode());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> CompileToplevel(&amp;parse_info, script, isolate, is_compiled_scope);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续向下分析，<code>CompileToplevel</code>-&gt;<code>parsing::ParseProgram</code>-&gt;<code>Parser::ParseProgram</code>-&gt;<code>Parser::DoParseProgram</code>，在DoParserProgram中看到终于进入主线剧情：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">FunctionLiteral* Parser::DoParseProgram(Isolate* isolate, ParseInfo* info) &#123;</span><br><span class="line">  <span class="comment">// Note that this function can be called from the main thread or from a</span></span><br><span class="line">  <span class="comment">// background thread. We should not access anything Isolate / heap dependent</span></span><br><span class="line">  <span class="comment">// via ParseInfo, and also not pass it forward. If not on the main thread</span></span><br><span class="line">  <span class="comment">// isolate will be nullptr.</span></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里对编译描述类进行查询，判断待编译字符串是否是模块、包装函数，会进入不同的分支；</span></span><br><span class="line">    <span class="comment">// 由于测试代码只是两个字符串相加，所以进入最后的分支。</span></span><br><span class="line">    <span class="keyword">if</span> (flags().is_module()) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info-&gt;is_wrapped_as_function()) &#123;</span><br><span class="line">      DCHECK(parsing_on_main_thread_);</span><br><span class="line">      ParseWrapped(isolate, info, &amp;body, scope, zone());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (flags().is_repl_mode()) &#123;</span><br><span class="line">      ParseREPLProgram(info, &amp;body, scope);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Don't count the mode in the use counters--give the program a chance</span></span><br><span class="line">      <span class="comment">// to enable script-wide strict mode below.</span></span><br><span class="line">      <span class="keyword">this</span>-&gt;scope()-&gt;SetLanguageMode(info-&gt;language_mode());</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 进入这个分支</span></span><br><span class="line">      ParseStatementList(&amp;body, Token::EOS);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>进入那个分支后的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Impl&gt;</span><br><span class="line"><span class="keyword">void</span> ParserBase&lt;Impl&gt;::ParseStatementList(StatementListT* body,</span><br><span class="line">                                          Token::Value end_token) &#123;</span><br><span class="line">  <span class="comment">// StatementList ::</span></span><br><span class="line">  <span class="comment">//   (StatementListItem)* &lt;end_token&gt;</span></span><br><span class="line">  DCHECK_NOT_NULL(body);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// v8对之前解析的第一个词法进行判断，来选择是否开启严格模式或者asm模式</span></span><br><span class="line">  <span class="keyword">while</span> (peek() == Token::STRING) &#123;</span><br><span class="line">    <span class="keyword">bool</span> use_strict = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> use_asm = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    Scanner::Location token_loc = scanner()-&gt;peek_location();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (scanner()-&gt;NextLiteralExactlyEquals(<span class="string">"use strict"</span>)) &#123;</span><br><span class="line">      use_strict = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scanner()-&gt;NextLiteralExactlyEquals(<span class="string">"use asm"</span>)) &#123;</span><br><span class="line">      use_asm = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    StatementT stat = ParseStatementListItem();</span><br><span class="line">    <span class="keyword">if</span> (impl()-&gt;IsNull(stat)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    body-&gt;Add(stat);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!impl()-&gt;IsStringLiteral(stat)) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (use_strict) &#123;</span><br><span class="line">      <span class="comment">// Directive "use strict" (ES5 14.1).</span></span><br><span class="line">      RaiseLanguageMode(LanguageMode::kStrict);</span><br><span class="line">      <span class="keyword">if</span> (!scope()-&gt;HasSimpleParameters()) &#123;</span><br><span class="line">        <span class="comment">// TC39 deemed "use strict" directives to be an error when occurring</span></span><br><span class="line">        <span class="comment">// in the body of a function with non-simple parameter list, on</span></span><br><span class="line">        <span class="comment">// 29/7/2015. https://goo.gl/ueA7Ln</span></span><br><span class="line">        impl()-&gt;ReportMessageAt(token_loc,</span><br><span class="line">                                MessageTemplate::kIllegalLanguageModeDirective,</span><br><span class="line">                                <span class="string">"use strict"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (use_asm) &#123;</span><br><span class="line">      <span class="comment">// Directive "use asm".</span></span><br><span class="line">      impl()-&gt;SetAsmModule();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Possibly an unknown directive.</span></span><br><span class="line">      <span class="comment">// Should not change mode, but will increment usage counters</span></span><br><span class="line">      <span class="comment">// as appropriate. Ditto usages below.</span></span><br><span class="line">      RaiseLanguageMode(LanguageMode::kSloppy);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 这里构建AST，加到body这个容器中</span></span><br><span class="line">  <span class="keyword">while</span> (peek() != end_token) &#123;</span><br><span class="line">    StatementT stat = ParseStatementListItem();</span><br><span class="line">    <span class="keyword">if</span> (impl()-&gt;IsNull(stat)) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (stat-&gt;IsEmptyStatement()) <span class="keyword">continue</span>;</span><br><span class="line">    body-&gt;Add(stat);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此AST建完，再看怎么生成bytecode，<code>CompileToplevel</code>-&gt;<code>parsing::ParseProgram</code>-&gt;<code>Parser::ParseProgram</code>-&gt;<code>MaybeProcessSourceRanges()</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MaybeProcessSourceRanges</span><span class="params">(ParseInfo* parse_info, Expression* root,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">uintptr_t</span> stack_limit_)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (root != <span class="literal">nullptr</span> &amp;&amp; parse_info-&gt;source_range_map() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="function">SourceRangeAstVisitor <span class="title">visitor</span><span class="params">(stack_limit_, root,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  parse_info-&gt;source_range_map())</span></span>;</span><br><span class="line">    visitor.Run();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>准备了一个AstVisitor来遍历AST，生成bytecode的。至于Run的内容，是一个巨长的宏，就不细看了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEFINE_AST_VISITOR_SUBCLASS_MEMBERS();</span><br></pre></td></tr></table></figure>
<p>至此Compile基本完成，再回去看<code>v8::Local&lt;v8::Value&gt; result = script-&gt;Run(context).ToLocalChecked();</code>。</p>
<h4 id="再看Script-Run"><a href="#再看Script-Run" class="headerlink" title="再看Script::Run()"></a>再看<code>Script::Run()</code></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MaybeLocal&lt;Value&gt; Script::Run(Local&lt;Context&gt; context) &#123;</span><br><span class="line">  <span class="keyword">auto</span> isolate = <span class="keyword">reinterpret_cast</span>&lt;i::Isolate*&gt;(context-&gt;GetIsolate());</span><br><span class="line">  TRACE_EVENT_CALL_STATS_SCOPED(isolate, <span class="string">"v8"</span>, <span class="string">"V8.Execute"</span>);</span><br><span class="line">  ENTER_V8(isolate, context, Script, Run, MaybeLocal&lt;Value&gt;(),</span><br><span class="line">           InternalEscapableScope);</span><br><span class="line">  i::<span class="function">HistogramTimerScope <span class="title">execute_timer</span><span class="params">(isolate-&gt;counters()-&gt;execute(), <span class="literal">true</span>)</span></span>;</span><br><span class="line">  i::<span class="function">AggregatingHistogramTimerScope <span class="title">timer</span><span class="params">(isolate-&gt;counters()-&gt;compile_lazy())</span></span>;</span><br><span class="line">  i::TimerEventScope&lt;i::TimerEventExecute&gt; timer_scope(isolate);</span><br><span class="line">  <span class="keyword">auto</span> fun = i::Handle&lt;i::JSFunction&gt;::cast(Utils::OpenHandle(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">  i::Handle&lt;i::Object&gt; receiver = isolate-&gt;global_proxy();</span><br><span class="line">  Local&lt;Value&gt; result;</span><br><span class="line">  has_pending_exception = !ToLocal&lt;Value&gt;(</span><br><span class="line">      i::Execution::Call(isolate, fun, receiver, <span class="number">0</span>, <span class="literal">nullptr</span>), &amp;result);</span><br><span class="line"></span><br><span class="line">  RETURN_ON_FAILED_EXECUTION(Value);</span><br><span class="line">  RETURN_ESCAPED(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>熟悉的代码，好像在learning-v8里看过，好，就此弃坑，因为下面的函数好长：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">V8_WARN_UNUSED_RESULT MaybeHandle&lt;Object&gt; Invoke(Isolate* isolate,</span><br><span class="line">                                                 <span class="keyword">const</span> InvokeParams&amp; params) &#123;</span><br></pre></td></tr></table></figure>
<p><code>params.target</code>是要调的函数。</p>
<h3 id="退出，释放资源"><a href="#退出，释放资源" class="headerlink" title="退出，释放资源"></a>退出，释放资源</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispose the isolate and tear down V8.</span></span><br><span class="line">  isolate-&gt;Dispose();</span><br><span class="line">  v8::V8::Dispose();</span><br><span class="line">  v8::V8::ShutdownPlatform();</span><br><span class="line">  <span class="keyword">delete</span> create_params.array_buffer_allocator;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里把之前的资源啥的都释放了，一次简短的v8之旅到此结束。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>话说本来我已经准备好全力探索v8了，结果刚摆好姿势，Sakura师傅就说别看v8了，直接扔了吧，推荐逆一逆闭源小软件，写写kernel，日日Android什么的，所以源码还没细读，就写了半个hello world又要弃坑了。</p>

                
<p class="pink-link-context">
    <a href="/2020/06/11/分析v8漏洞从入门到入门-Issue-1793/" rel="next" title="分析v8漏洞从入门到入门 -- Issue 1793">
    Prev: 分析v8漏洞从入门到入门 -- Issue 1793
  </a>
</p>



<p class="pink-link-context">
    <a href="/2020/05/31/learning-v8-翻译/" rel="next" title="learning v8 翻译">
    Next: learning v8 翻译
  </a>
</p>


            </div>
			
        </div>
    </div>
</article>






</div>

        <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large pink">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect pink" title="Return to top"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse pink darken-1"  data-activates="main-menu" title="Menu"><i class="fa fa-navicon"></i></a></li>
    </ul>
  </div>

    </main>
    <footer class="page-footer pink accent-1 darken-1">
    
    <div class="footer-container container">
        <div class="row">
            
            <div class="social-group col m4 s12">
                <h5 class="white-text">Social</h5>
                
                    <a class="social-link" href="https://github.com/cracke-s-j" target="_blank">
                        <i class="fa fa-2x fa-github"></i>
                    </a>
                
                

            </div>
            

            
            <div class="col m8 s12">
                <h5 class="white-text">Links</h5>
                
                    <a class="social-link" href="https://blog.dyf.ink/" target="_blank">友情链接 dyf&#39;s blog</a>
                
            </div>
            
        </div>
    </div>
    

    <div class="footer-copyright pink-link-context">
        <div class="container">
            © 2020 ssj, All rights reserved.
            <p class="right" style="margin-top: 0;">Blog powered by <a href="https://hexo.io">Hexo</a> | Theme <a href="https://github.com/raytaylorlin/hexo-theme-raytaylorism">raytaylorism</a></p>
        </div>
    </div>
</footer>


    <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>

<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();

            // 目录随屏幕滚动（防止目录过长越过footer）
            var $toc = $('.toc');
            var scrollTargetTop = 0;
            $(window).scroll(function() {
                var $activeLink = $toc.find('a.active.section');
                if ($(window).scrollTop() < 100) {
                    scrollTargetTop = 0;
                } else {
                    if ($activeLink[0]) {
                        scrollTargetTop = $activeLink.offset().top - $toc.offset().top;
                    }
                }
                $toc.css('top', '-' + scrollTargetTop + 'px');
            });

            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass('pink lighten-2');

            
            // 添加new标签
            $('').append('<span class="new badge pink"></span>');
            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<script type="text/javascript" async
  src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"superSample":2,"width":250,"height":500,"position":"left","hOffset":0,"vOffset":-100},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
