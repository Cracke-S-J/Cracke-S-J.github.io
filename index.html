<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>ssj的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="ssj的博客">
<meta property="og:url" content="https://github.com/Cracke-S-J/index.html">
<meta property="og:site_name" content="ssj的博客">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ssj的博客">
  
    <link rel="alternative" href="/atom.xml" title="ssj的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
    
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet">
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/head.png" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">ssj</a></h1>
        </hgroup>

        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">博客首页</a></li>
                        
                            <li><a href="/categories/programming/">编程相关</a></li>
                        
                            <li><a href="/categories/opera/">跟ssj一起听戏</a></li>
                        
                            <li><a href="/2019/05/29/resume/">本人简历</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl mail" target="_blank" href="/1263914174@qq.com" title="mail">mail</a>
                            
                                <a class="fl github" target="_blank" href="https://github.com/Cracke-S-J" title="github">github</a>
                            
                                <a class="fl QQ" target="_blank" href="/1263914174" title="QQ">QQ</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/C/" style="font-size: 10px;">C++</a> <a href="/tags/CTF/" style="font-size: 10px;">CTF</a> <a href="/tags/Ethereum/" style="font-size: 20px;">Ethereum</a> <a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/resume/" style="font-size: 10px;">resume</a> <a href="/tags/京剧/" style="font-size: 20px;">京剧</a> <a href="/tags/定场诗/" style="font-size: 10px;">定场诗</a> <a href="/tags/脱壳/" style="font-size: 10px;">脱壳</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://luuman.github.io/">name</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">大学生，梆梆安全实习中，业余票友，专业android逆向，资深猫奴。</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">ssj</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/head.png" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">ssj</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">博客首页</a></li>
                
                    <li><a href="/categories/programming/">编程相关</a></li>
                
                    <li><a href="/categories/opera/">跟ssj一起听戏</a></li>
                
                    <li><a href="/2019/05/29/resume/">本人简历</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="mail" target="_blank" href="/1263914174@qq.com" title="mail">mail</a>
                    
                        <a class="github" target="_blank" href="https://github.com/Cracke-S-J" title="github">github</a>
                    
                        <a class="QQ" target="_blank" href="/1263914174" title="QQ">QQ</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-kill-chenshimei" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/06/24/kill-chenshimei/" class="article-date">
      <time datetime="2019-06-24T09:44:12.000Z" itemprop="datePublished">2019-06-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/24/kill-chenshimei/">铡美案</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>有名的包公戏。</p>
<p>。。。</p>
<p>在我心智成熟之前应该是不会再听准叔那版陈世美了，除非自找不dei。</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/opera/">听戏</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/京剧/">京剧</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-easy-android-unpack" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/06/20/easy-android-unpack/" class="article-date">
      <time datetime="2019-06-20T06:36:05.000Z" itemprop="datePublished">2019-06-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/20/easy-android-unpack/">Android脱壳入门</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="什么是hook"><a href="#什么是hook" class="headerlink" title="什么是hook"></a>什么是hook</h2><p>hook是钩子的意思，怎么解释我在面试的时候也没答好，现在也不会描述，只能自行体会。android hook大致有下面三种，然后还有一个进程注入。</p>
<ol>
<li><a href="https://www.cnblogs.com/mmmmar/p/8228391.html" target="_blank" rel="noopener">Android GOT Hook</a></li>
<li><a href="https://www.cnblogs.com/mmmmar/p/8185549.html" target="_blank" rel="noopener">Android Inline Hook</a></li>
<li><a href="https://www.cnblogs.com/mmmmar/p/8227915.html" target="_blank" rel="noopener">Android Exception Hook</a></li>
<li><a href="https://www.cnblogs.com/mmmmar/p/8253537.html" target="_blank" rel="noopener">Android Ptrace Inject</a></li>
</ol>
<h2 id="frida的使用"><a href="#frida的使用" class="headerlink" title="frida的使用"></a>frida的使用</h2><p><a href="https://blog.csdn.net/jiangwei0910410003/article/details/80372118" target="_blank" rel="noopener">Android逆向之旅—Hook神器家族的Frida工具使用详解</a></p>
<p>四哥写的，CSDN，丑点就丑点，内容还是很好的。</p>
<h2 id="Dex加载流程（基于Android5-1）"><a href="#Dex加载流程（基于Android5-1）" class="headerlink" title="Dex加载流程（基于Android5.1）"></a>Dex加载流程（基于Android5.1）</h2><h3 id="DexClassloader"><a href="#DexClassloader" class="headerlink" title="DexClassloader"></a>DexClassloader</h3><p>要动态加载一个dex文件，用到的是DexClassloader，DexClassloader是BaseDexClassLoader的子类，代码很短。</p>
<h3 id="BaseClassloader"><a href="#BaseClassloader" class="headerlink" title="BaseClassloader"></a>BaseClassloader</h3><p>BaseClassloader是Classloader的子类。Classloader有两个比较重要的方法：findClass和loadClass。其中findClass是用来实现类加载的逻辑，loadClass是先从父Classloader里面去寻找，如果找不到就调用自己的findClass来找。需要关注的是BaseClassloader的构造方法和findClass方法。在构造方法中，将自己的pathList这个成员变量赋值，其值是一个新创建的DexPathList对象。在findClass方法中是调用的pathList里面的findClass方法，所以dex加载的逻辑应该是在DexPathList里面实现的。</p>
<h3 id="DexPathList"><a href="#DexPathList" class="headerlink" title="DexPathList"></a>DexPathList</h3><p>在DexPathList里面需要关注三个函数:构造方法、findClass和makeDexElements。findClass是用来找类的，其代码里面是从自己的dexElements去找的类。构造方法中调用makeDexElements这个方法类给dexElements来赋值的。在makeDexElements这个类里面，就是将apk或者zip或者jar或者裸的dex加载起来，放到Elements对象里面。dexFile就是放到这个element里面，在makeDexElements里面是调用的自身的loadDexFile来加载dex，在loadDexFile里面判断了文件是否是zip或者apk jar，如果是就调用构造方法来加载dex，否则就使用loadDex方法来加载dex。</p>
<h3 id="DexFile"><a href="#DexFile" class="headerlink" title="DexFile"></a>DexFile</h3><p>DexFile这个类就是java层最终加载dex的类，在构造方法中调用的openDexFile方法来加载dex，openDexFile是调用的openDexFileNative方法来加载dex，这个方法是一个native方法。其实现在dalvik_system_DexFile.cc中。</p>
<h3 id="dalvik-system-DexFile-cc"><a href="#dalvik-system-DexFile-cc" class="headerlink" title="dalvik_system_DexFile.cc"></a>dalvik_system_DexFile.cc</h3><p>在DexFile.java中调用的openDexFileNative的实现就在dalvik_system_DexFile.cc中的DexFile_openDexFileNative函数里面。这里是由class_inker.cc的OpenDexFilesFromOat来实现的。</p>
<h3 id="class-linker-cc"><a href="#class-linker-cc" class="headerlink" title="class_linker.cc"></a>class_linker.cc</h3><p>查看当前dex文件是否被解析成oat，如果被解析成了oat文件，就直接下一步，如果没有就先调用dex2oat把dex解析成oat文件。</p>
<h2 id="跟踪dex加载流程"><a href="#跟踪dex加载流程" class="headerlink" title="跟踪dex加载流程"></a>跟踪dex加载流程</h2><p><code>frida-trace -R -f [包名] -i &quot;*OatFile*&quot; -i &quot;*DexFile*&quot;</code></p>
<p>用frida跟踪加载流程，由于C++编译的函数符号会带有命名空间，所以一般关注OatFile和DexFile即可。将符号还原为函数名，就可以知道加载流程了。</p>
<h2 id="脱一代壳"><a href="#脱一代壳" class="headerlink" title="脱一代壳"></a>脱一代壳</h2><p>一代壳是将整个dex加密，加载时动态解密，有很多方案可以脱掉。更Low一点的是落地加载，pull出来就行了。</p>
<ol>
<li>内存遍历，找dex，把dex抠出来。</li>
<li>hook从内存中打开dex的函数OpenMemory或者其它合适的。</li>
</ol>
<p>frida脱壳例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> DEX_MAGIC = <span class="number">0x0A786564</span>;</span><br><span class="line"><span class="keyword">var</span> dexrec = [];</span><br><span class="line"></span><br><span class="line">dump_dex_memory = <span class="function"><span class="keyword">function</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> dex_len = Memory.readU32(addr.add(<span class="number">0x20</span>));</span><br><span class="line">    <span class="keyword">var</span> buf = Memory.readByteArray(addr, <span class="number">64</span>);</span><br><span class="line">    <span class="keyword">var</span> dumppath = <span class="string">"/data/local/tmp/"</span> + dex_len.toString(<span class="number">0x10</span>) + <span class="string">".dex"</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(dumppath);</span><br><span class="line">    <span class="keyword">var</span> dumpdexfile = <span class="keyword">new</span> File(dumppath, <span class="string">"wb"</span>);</span><br><span class="line">    dumpdexfile.write(Memory.readByteArray(addr, dex_len));</span><br><span class="line">    dumpdexfile.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> openmemory = Module.findExportByName(<span class="string">"libart.so"</span>, <span class="string">"_ZN3art7DexFile10OpenMemoryEPKhjRKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEEjPNS_6MemMapEPKNS_10OatDexFileEPS9_"</span>);</span><br><span class="line"><span class="keyword">if</span>(openmemory != <span class="literal">undefined</span>) &#123;</span><br><span class="line">    Interceptor.attach(openmemory, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"loaddex: "</span> + args[<span class="number">0</span>] + <span class="string">"size: "</span> + args[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">if</span>(Memory.readU32(args[<span class="number">0</span>]) == DEX_MAGIC) &#123;</span><br><span class="line">                dexrec.push(args[<span class="number">0</span>]);</span><br><span class="line">                dump_dex_memory(args[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"dexfile: "</span> + retval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/programming/">编程</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/脱壳/">脱壳</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-cpp-object" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/06/18/cpp-object/" class="article-date">
      <time datetime="2019-06-18T05:30:05.000Z" itemprop="datePublished">2019-06-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/18/cpp-object/">《深度探索Cpp对象模型》学习笔记</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>首先声明，看这本书，完全是闲的。下面让我们来看看充满潜规则的玄学Cpp整天都在搞什么。</p>
<h2 id="第一章-关于对象"><a href="#第一章-关于对象" class="headerlink" title="第一章 关于对象"></a>第一章 关于对象</h2><h3 id="class封装之后的布局成本"><a href="#class封装之后的布局成本" class="headerlink" title="class封装之后的布局成本"></a>class封装之后的布局成本</h3><p>class并没有增加成本，data members直接内含在每一个class object之中，就像C的struct一样。而member functions虽然被包含在class的声明之内，但是不出现在Object之中。每一个non-inline function只会产生一个函数实体。至于inline function则会在每一个调用使用的地方产生一个函数实体。</p>
<p>class在布局以及存取时间上主要的额外负担是由virtual引起，包括：</p>
<ul>
<li><p>virtual function机制，用以支持一个有效率的<strong>执行期绑定（runtime binding)</strong>。</p>
</li>
<li><p>virtual base class用以实现<strong>多次出现在继承体系中的 base class ,有一个单一的被共享的实体</strong>。</p>
</li>
<li><p>还有一些多继承下的额外负担，发生在<strong>一个derived class和其第二或后继之base class的转换</strong>之间。</p>
</li>
</ul>
<h3 id="C-对象模型"><a href="#C-对象模型" class="headerlink" title="C++ 对象模型"></a>C++ 对象模型</h3><p>在C++对象模型中，nonstatic data members被放置在每一个class object之内，static data members则被存放在所以class object之外。static和nonstaitc function也被放在所有class object之外。virtual functions 则以两个步骤支持之：</p>
<ol>
<li><p>每一个class产生出一堆指向virtual functions的指针，放在表格之中，这个表格被称为virtual table(vtbl)。</p>
</li>
<li><p>每一个class object被添加一个指针，指向相关的virtual table。通常这个指针被称为vptr，vptr的设定和重置都由每一个class的constructor、destructor和copy assignment运算符自动完成。</p>
</li>
</ol>
<p>C++ 以下列方法支持多态：</p>
<ol>
<li><p>经由一组隐含的转化操作。例如把一个derived class指针转换为一个指向其public base type的指针。</p>
</li>
<li><p>经由virtual function机制。</p>
</li>
<li><p>经由dynamic_cast和typied运算符。</p>
</li>
</ol>
<p>class object需要多少内存：</p>
<ol>
<li><p>其nonstatic data members的总和大小。</p>
</li>
<li><p>加上任何由于alignment和padding（内存对齐）需要的空间。</p>
</li>
<li><p>加上为了支持virtual而由内部产生的任何额外负担。</p>
</li>
</ol>
<p>指针类型：告诉编译器如何解释某个特定地址中的内存内容及其大小（例如：一个string是传统的8byte（包括一个4byte的字符指针和一个用来表示字符串长度的整数）。转型（cast)其实是一个编译指令，大部分不会改变一个指针所含有的真正地址，它只影响<strong>被指出值内存的大小和其内容</strong>的解释方式。</p>
<hr>
<h2 id="第二章-构造函数语意学"><a href="#第二章-构造函数语意学" class="headerlink" title="第二章 构造函数语意学"></a>第二章 构造函数语意学</h2><h3 id="2-1-Default-Constructor"><a href="#2-1-Default-Constructor" class="headerlink" title="2.1 Default Constructor"></a>2.1 Default Constructor</h3><p>当编译器需要的时候，default constructor会被合成出来，只执行编译器所需要的任务（将members适当初始化）。</p>
<h4 id="带有Default-Constructor的Member-Class-Object。"><a href="#带有Default-Constructor的Member-Class-Object。" class="headerlink" title="带有Default Constructor的Member Class Object。"></a>带有Default Constructor的Member Class Object。</h4><p>编译器的出来是：如果一个class A内含一个或者一个以上member class objects ，那么class A的每一个 constructor必须调用每一个member classes的default constructor。编译器会扩张已存在的constructors,在其中安插一些代码，使得user code在被执行之前，先调用（调用顺序与member objects在class的声明次序一致）必要的default constructors。</p>
<h4 id="带有-Default-Constructor的Base-class"><a href="#带有-Default-Constructor的Base-class" class="headerlink" title="带有 Default Constructor的Base class"></a>带有 Default Constructor的Base class</h4><p>编译器会在Member Class Object的default constructor被插入调用之前，调用（调用次序根据他们的声明次序）所有base class constructor的default constructor 。</p>
<h4 id="带有一个-Virtual-Function的class"><a href="#带有一个-Virtual-Function的class" class="headerlink" title="带有一个 Virtual Function的class"></a>带有一个 Virtual Function的class</h4><p>下面两种情况同样需要合成default constructor：</p>
<ol>
<li><p>class 声明（或继承）一个virtual function。</p>
</li>
<li><p>class派生自一个继承串链，其中一个或者更多的virtual base class。</p>
</li>
</ol>
<p>扩展（constructor）操作会在编译期间发生：</p>
<ol>
<li><p>一个virtual function table会被编译器产生出来，内放class的virtual functions的地址。</p>
</li>
<li><p>在每一个class object中，一个额外的pointer member（vptr)会被编译器合成出来，内含相关的class vtbl的地址。</p>
</li>
</ol>
<h4 id="带有一个-Virtual-Base-Class的class"><a href="#带有一个-Virtual-Base-Class的class" class="headerlink" title="带有一个 Virtual Base Class的class"></a>带有一个 Virtual Base Class的class</h4><p>Virtual base class的实现法在不同编译器之间有很大差异，然而，每一个实现的共同点在于必须使virtual base class在其每一个derived class object中的位置，能够在执行期准备妥当。对于class所定义的每一个constructor编译器都会安插那些<strong>允许每一个virtual base class 的执行期存取操作</strong>的码。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>以上四种情况，会导致<strong>编译器必须为未声明constructor的class合成一个default constructor</strong>，这只是编译器（而非程序）的需要。它之所以能够完成任务，是借着<strong>调用member object或base class的default constructor</strong>或是<strong>为每一个object初始化其virtual function机制或virtual base class机制</strong>完成。至于没有存在这四种情况而又没有生命constructor的class实际上是不会被合成出来的。</p>
<p>在合成的default constructor中，只有base class subobjects(子对象）和member class objects会被初始化。所有其他的nonstatic data member ，如整数，整数指针，整数数组等是不会被初始化的，这些初始化操作对程序是必须的，但对编译器则并非需要的。</p>
<p>C++新手会有两个误解：</p>
<ol>
<li><p>任何class如果没有定义default constructor，就会被合成出来一个。</p>
</li>
<li><p>编译器合成出来的default constructor会明确设定class内每一个data member的默认值。</p>
</li>
</ol>
<h3 id="2-2-Copy-Constructor"><a href="#2-2-Copy-Constructor" class="headerlink" title="2.2 Copy Constructor"></a>2.2 Copy Constructor</h3><p>有三种情况，会以一个object的内容作为另一class object的初值。</p>
<ol>
<li><p>最明显的当然是对一个object做明确的初始化操作。</p>
</li>
<li><p>当object被当做参数交给某个函数。</p>
</li>
<li><p>当函数返回一个class object。</p>
</li>
</ol>
<p>这三种情况需要有copy constructor。</p>
<h4 id="Default-Memberwise-Initialization"><a href="#Default-Memberwise-Initialization" class="headerlink" title="Default Memberwise Initialization"></a>Default Memberwise Initialization</h4><p>如果class没有提供一个explicit copy constructor时，当class object以相同的另一个object作为初值时，其内部是以所谓的default memberwise initialization方式完成的。也就是把每一个内建的或派生的 data member（例如一个数组或指针）的值，从某个object拷贝一份到另一个object上，但不拷贝其具体内容。例如只拷贝指针地址，不拷贝一份新的指针指向的对象，这也就是浅拷贝，不过它并不会拷贝其中member class object，而是以递归的方式实行memberwise initialization。</p>
<p>就是Bitwise Copy Semantics和default copy constructor。如果class展现了Bitwise Copy Semantics，则使用bitwise copy（bitwise copy semantics编译器生成的伪代码是memcpy函数），否则编译器会生成default copy constructor。</p>
<p>那什么情况下class不展现Bitwise Copy Semantics呢？有四种情况：</p>
<ol>
<li><p>当class内含有一个member class object，而这个member class内有一个默认的copy构造函数，（不论是class设计者明确声明，或者被编译器合成）。</p>
</li>
<li><p>当class继承自一个base class，而base class有copy构造函数（不论是class设计者明确声明，或者被编译器合成）。</p>
</li>
<li><p>当一个类声明了一个或多个virtual函数。</p>
</li>
<li><p>当class派生自一个继承串链，其中一个或者多个virtual base class。</p>
</li>
</ol>
<p>在前2种情况下，编译器必须将member或者base class的copy constructor的调用操作安插到被合成的copy constructor中。</p>
<p>第3种情况下，因为class 包含virtual function，编译时需要做扩张操作：</p>
<ol>
<li><p>增加virtual function table，内含有一个有作用的virtual function的地址；</p>
</li>
<li><p>创建一个指向virtual function table的指针，安插在class object内。</p>
</li>
</ol>
<p>所以，编译器对于每一个新产生的class object的vptr都必须被正确地赋值，否则将跑去执行其他对象的function了，其后果是很严重的。因此，编译器导入一个vptr到class之中时，该class就不在展现bitwise semantics，必须合成copy Constructor并将vptr适当地初始化。</p>
<p>virtual base class的存在需要特别处理。一个class object如果以另一个virtual base class subobject那么也会使bitwise copy semantics失效。</p>
<p>每一个编译器对于虚拟继承的支持承诺，都是表示必须让derived class object中的virtual base class subobject位置在执行期就准备妥当，维护位置的完整性是编译器的责任。Bitwise copy semantics 可能会破坏这个位置，所以编译器必须自己合成出copy constructor。</p>
<p>这也就是说，拷贝构造函数和默认构造器一样，需要的时候会进行构建，而并非程序员不写编译器就帮着构建。</p>
<h3 id="2-4-初始化列表"><a href="#2-4-初始化列表" class="headerlink" title="2.4 初始化列表"></a>2.4 初始化列表</h3><p>下面四种情况必须使用初始化列表来初始化class的成员：</p>
<ol>
<li><p>当初始化一个reference member时；</p>
</li>
<li><p>当初始化一个const member时；</p>
</li>
<li><p>当调用一个base class的constructor ，而它拥有一组参数（其实就是自定义的构造函数）时；</p>
</li>
<li><p>当调用一个member class的constructor，而它拥有一组参数时。</p>
</li>
</ol>
<p>不过，初始化的顺序是class members声明次序决定的，不是由初始化列表决定的。</p>
<h2 id="第三章-Data-语意学"><a href="#第三章-Data-语意学" class="headerlink" title="第三章 Data 语意学"></a>第三章 Data 语意学</h2><h3 id="3-2-Data-Member的布局"><a href="#3-2-Data-Member的布局" class="headerlink" title="3.2 Data Member的布局"></a>3.2 Data Member的布局</h3><p>nonstatic data members在class object中的排列顺序将和其声明的顺序一样的。但C++ standard允许编译器将多个access sections之中的data members自由排列，不必在乎他们的出现在class中的声明顺序。</p>
<h3 id="3-3-Data-Member的存取"><a href="#3-3-Data-Member的存取" class="headerlink" title="3.3 Data Member的存取"></a>3.3 Data Member的存取</h3><p>每一个member的存取许可（private public protected），以及与class的关联，并不会导致任何空间上或执行时间上的额外负担——不论是在个别的class objects 或是在static data member本身。</p>
<p>static data members被视为global变量，只有一个实体，存放在程序的data segment之中，每次取static member就会被内部转化为对该唯一的extern实体的直接参考操作。若取一个static data member的地址，会得到一个数据类型的指针，而不是只想起class member的指针。</p>
<p>nonstatic data members欲对一个nonstatic data member进行存取操作，编译器需要吧class object的起始地址加上data member的偏移量（在编译事情就可以获知）。</p>
<h3 id="3-4-继承与Data-Member"><a href="#3-4-继承与Data-Member" class="headerlink" title="3.4 继承与Data Member"></a>3.4 继承与Data Member</h3><h4 id="只要继承不要多态"><a href="#只要继承不要多态" class="headerlink" title="只要继承不要多态"></a>只要继承不要多态</h4><p>这种情况并不会增加空间或存储时间上的额外负担。这种情况base class和derived class的objects都是从相同的地址开始，其差异只在于derived object比较大，用以容纳自建的nonstatic data members，把一个derived class object指定给base class的指针或引用，并不需要编译器去调停或修改地址，它很滋润的可以发生，而且提供了最佳执行效率。</p>
<h4 id="加上多态"><a href="#加上多态" class="headerlink" title="加上多态"></a>加上多态</h4><p>这种情况会带来空间和存取时间的额外负担：</p>
<ol>
<li><p>导入一个和virtual table，用来存储它所声明的每一个virtual functions的地址。</p>
</li>
<li><p>在每一个class object中导入一个vptr,提供执行期的链接，使每一个object能够找到相应的virtual table。</p>
</li>
<li><p>加强constructor，使它能够为vptr设定初始值，让它指向class 所对应的virtual table 。</p>
</li>
<li><p>加强destructor，使它能够消抹指向class 相关virtual table的vptr。</p>
</li>
</ol>
<h4 id="多重继承"><a href="#多重继承" class="headerlink" title="多重继承"></a>多重继承</h4><p>对于一个多重派生对象，将其地址指定给“最左端（第一个）base class的指针”，情况和单一继承时相同，因为二者都指向了相同的起始地址，至于第二个或后面的base class 的地址指定操作，则需要将地址修改过：加上（或减去，如果是downcast）介于中间的base class subobject(s)的大小。</p>
<p>如果要存取第二个（或后面）的base class 中的一个data member ，不需要付出额外的成本，因为members的位置在编译时就固定了，因此存取member只是一个简单的offset的运算。</p>
<h4 id="虚拟继承"><a href="#虚拟继承" class="headerlink" title="虚拟继承"></a>虚拟继承</h4><p>class如果含有一个或多个virtual base class subobjects将被分割为两部分：一个不变局部和一个共享局部。不变局部中的数据，总是能有固定的offset，这部分可以被直接存取，至于共享部分，所表现的就是virtual base class subobject ，这个部分数据，其位置因为每次派生操作而有变化，所以只能间接存取。</p>
<p>如果没有virtual functions的情况下，它们和C struct完全一样。</p>
<h2 id="第四章-Function-语意学"><a href="#第四章-Function-语意学" class="headerlink" title="第四章 Function 语意学"></a>第四章 Function 语意学</h2><h3 id="4-1-Member的各种调用方式"><a href="#4-1-Member的各种调用方式" class="headerlink" title="4.1 Member的各种调用方式"></a>4.1 Member的各种调用方式</h3><p>Nonstatic Member Functions</p>
<p>实际上编译器是将member function被内化为nonmember的形式，经过下面转化步骤：</p>
<p>1.给函数添加额外参数，this。</p>
<p>2.将对每一个nonstaitc data member的存取操作改为this指针来存取。</p>
<p>3.将member function重写成一个外部函数。对函数名精选mangling处理，使之成为独一无二的语汇。</p>
<h4 id="Virtual-Member-Functions"><a href="#Virtual-Member-Functions" class="headerlink" title="Virtual Member Functions"></a>Virtual Member Functions</h4><p>将</p>
<p><code>ptr-&gt;f();   //f()为virtual member function</code></p>
<p>内部转化为</p>
<p><code>（*ptr-&gt;vptr[1](ptr);</code></p>
<p>其中：</p>
<p>vptr表示编译器产生的指针，指向virtual table。它被安插在每一个声明有（或继承自）一个或多个virtual functions 的class object中。</p>
<p>1是virtual table slot的索引值，关联到normalize()函数。</p>
<p>第二个ptr表示this指针。</p>
<h4 id="Static-Member-Functions"><a href="#Static-Member-Functions" class="headerlink" title="Static Member Functions"></a>Static Member Functions</h4><p>不能被声明为const volatile或virtual。</p>
<p>一个static member function会提出于class声明之外，并给予一个经过mangling的适当名称。如果取一个static member function 的地址，获得的是其在内存的位置也就是地址，而不是一个指向class member function的指针，如下：</p>
<p><code>&amp;Point::count();</code></p>
<p>会得到一个数值，类型是：</p>
<p><code>unsigned int(*)();</code></p>
<p>而不是：</p>
<p><code>unsigned int(Point::*)();</code></p>
<h3 id="4-2-Virtual-Member-Funcitons"><a href="#4-2-Virtual-Member-Funcitons" class="headerlink" title="4.2 Virtual Member Funcitons"></a>4.2 Virtual Member Funcitons</h3><p>C++中，多态表示以一个public base class 的指针（或reference)，寻址出一个derived class object。</p>
<p>每一个class 只会有一个virtual table，每一个table含有对应的class object中所有active virtual functions 函数实体地址。这些active virtual function包括：</p>
<ol>
<li><p>这个class 所定义的函数实体（改写（overriding)一个可能存在的base class virtual function函数实体。</p>
</li>
<li><p>继承自base class 的函数实体（不被derived class改写）</p>
</li>
<li><p>一个pure_virtual_called()。</p>
</li>
</ol>
<p>一个类继承函数virtual table的三种可能性：</p>
<ol>
<li><p>继承base class 所声明的virtual functions的函数实体。正确地说，是该函数实体的地址会被拷贝到derived class的virtual table相对应的slot之中。</p>
</li>
<li><p>使用自己的函数实体。这表示它自己的函数实体地址必须放在对应的slot之中。</p>
</li>
<li><p>可以加入一个新的virtual function。这时候virtual table 的尺寸会增大一个slot放进这个函数实体地址。</p>
</li>
</ol>
<p>编译时期设定virtual function的调用：</p>
<p>一般而言，我并不知道ptr 所指对象的真正类型。然而可以经由ptr 可以存取到该对象的virtual table。</p>
<p>虽然我不知道哪个Z()函数实体被调用，但知道每一个Z()函数地址都被放置slot 4的索引。</p>
<p>这样我们就可以将</p>
<p><code>ptr-&gt;z();</code></p>
<p>转化为：<code>（*ptr-&gt;vptr[4])(ptr);</code></p>
<p>唯一一个在执行期才能知道的东西是：slot4所指的到底是哪一个z()函数实体。</p>
<p>多重继承下的 Virtual Functions</p>
<p>在多重继承中支持virtual functions，其复杂度围绕在第二个及其后面的base class 上，以及“必须在执行期调整this 指针”这一点。一般规则是，经由指向“第二或后继base class 的指针”来调用derived class virtual function。调用操作连带的“必要的this指针调整”操作，必须在执行期完成。</p>
<p>虚拟继承下的 Virtual Functions</p>
<h3 id="4-3-函数的效能"><a href="#4-3-函数的效能" class="headerlink" title="4.3 函数的效能"></a>4.3 函数的效能</h3><p>nonmemeber、static member或nonstatic member函数都被转换为完全相同形式，所以三者效率完全相同。</p>
<h3 id="4-4-指向Member-Function的指针"><a href="#4-4-指向Member-Function的指针" class="headerlink" title="4.4 指向Member Function的指针"></a>4.4 指向Member Function的指针</h3><p>取一个nonstatic data member的地址，得到的结果是该member在class 布局中的bytes位置，所以它需要绑定于某个class object的地址上，才能够被存取。</p>
<p>取一个nonstatic member function的地址，如果该函数是nonvirtual，则得到的是内存的真正地址，然后这个值也是不完全的，也需要绑定于某个class object的地址上，才能够调用函数。</p>
<p>支持指向Virtual Member Function之指针</p>
<p>对于一个virtual function，其地址在编译时期是未知的，所能知道的仅是virtual function在其相关之virtual table的索引值，也就是说，对于一个virtual member function 取其地址，所能获得的只是一个索引值。</p>
<h3 id="4-5-Inline-Funcitons"><a href="#4-5-Inline-Funcitons" class="headerlink" title="4.5 Inline Funcitons"></a>4.5 Inline Funcitons</h3><ul>
<li><p>形参:传入参数，直接替换 传入常量，连替换都省了，直接变成常量 传入函数运行结果，则需要导入临时变量</p>
</li>
<li><p>局部变量:局部变量会被mangling，以便inline函数被替换后名字唯一 也就是说一次性调用N次，就会出现N个临时变量……程序的体积会暴增</p>
</li>
</ul>
<h2 id="第五章-构造、解构、拷贝-语意学"><a href="#第五章-构造、解构、拷贝-语意学" class="headerlink" title="第五章 构造、解构、拷贝 语意学"></a>第五章 构造、解构、拷贝 语意学</h2><h4 id="继承体系下的对象构造"><a href="#继承体系下的对象构造" class="headerlink" title="继承体系下的对象构造"></a>继承体系下的对象构造</h4><p>constructor的调用伴随了哪些步骤：</p>
<ol>
<li><p>初始化列表（member initialization list)的data members初始化操作会被放进constructor的函数本身，并以membs的声明顺序为顺序。</p>
</li>
<li><p>如果有一个member并没有在初始化列表中，但它在一个default constructor，那么该default constructor 必须被调用（手动）。</p>
</li>
<li><p>在那之前，如果class object有virtual table pointer(s)，它（们）必须被设定初始值，指定适当的virtual table(s)。</p>
</li>
<li><p>在那之前，所有上一层的base class constructors 必须被调用，以base class 的声明顺序为顺序（与初始化列表的顺序没有关联）。</p>
</li>
</ol>
<p>如果base class 被列于初始化列表中，那么任何明确指定参数都应该传递过去。</p>
<p>如果base class 没有列于初始化列表，那么调用default constructor。</p>
<p>如果base class 是多重继承下的第二或后面的base class ，那么this指针必须有所调整。</p>
<ol start="5">
<li>在那之前，所有 virtual base class constructors 必须被调用，从左到右，从最深到最浅。</li>
</ol>
<p>如果class 被列于初始化列表中，那么如果有任何明确指定的参数，都应该传递过去，若没有列于初始化列表中，则调用default constructor。</p>
<p>此外，class中的每一个virtual base class subobject的偏移量必须在执行期可存取。</p>
<p>如果class object 是最底层的class，某constructors可能被调用；某些用以支持这个行为的机制必须被放进来。</p>
<h4 id="对象复制语意学"><a href="#对象复制语意学" class="headerlink" title="对象复制语意学"></a>对象复制语意学</h4><p>当设计一个class，并以一个class object 指定另一个class object时，有三种选择：</p>
<ol>
<li><p>什么都不做，实施默认行为。</p>
</li>
<li><p>提供一个explicit copy assignment operator。</p>
</li>
<li><p>明确拒绝一个class object指定给另一个class object。</p>
</li>
</ol>
<p>一个class对于默认的copy assignment operator，在以下情况下不会表现出 bitwise copy语意：</p>
<ol>
<li><p>当一个class的base class 有一个copy assignment operator时，</p>
</li>
<li><p>当一个class 的member object，而其class 有一个copy assignment operator时，</p>
</li>
<li><p>当一个class 声明了任何virtual functions时，</p>
</li>
<li><p>当class继承一个virtual base class 时。</p>
</li>
</ol>
<h4 id="vptr语意学"><a href="#vptr语意学" class="headerlink" title="vptr语意学"></a>vptr语意学</h4><p>vptr在constructor何时被初始化？在base class constructors调用操作之后，但是在程序员供应的码或是初始化列表中所列的members初始化操作之前。</p>
<h4 id="解构语意学"><a href="#解构语意学" class="headerlink" title="解构语意学"></a>解构语意学</h4><p>destructor被扩展的方式：</p>
<ol>
<li><p>destructor的函数本身首先被执行。</p>
</li>
<li><p>如果class拥有member class objects，而后拥有destructor，那么它们会以声明顺序的相反顺序被调用。</p>
</li>
<li><p>如果object内带一个vptr，则现在被重新设定，指向适当的base class virtual table。</p>
</li>
<li><p>如果有任何直接的（上一层）nonvirtual base classes 拥有destructor ，它们会以声明顺序相反顺序调用。</p>
</li>
<li><p>如果有任何virtual base classes 拥有destructor，而当前讨论的这个class 是最尾端的class，那么它们会以其原来顺序相反顺序被调用。</p>
</li>
</ol>
<h2 id="第六章-执行期语意学"><a href="#第六章-执行期语意学" class="headerlink" title="第六章 执行期语意学"></a>第六章 执行期语意学</h2><h2 id="第七章-……"><a href="#第七章-……" class="headerlink" title="第七章 ……"></a>第七章 ……</h2><h2 id="补充：类型向上转型和多态的混淆"><a href="#补充：类型向上转型和多态的混淆" class="headerlink" title="补充：类型向上转型和多态的混淆"></a>补充：类型向上转型和多态的混淆</h2><p>构造这样的一个继承体系：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>: <span class="keyword">virtual</span> ~Base() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> :</span> <span class="keyword">public</span> Base &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>: <span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Derived"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>子类Derived类重写了基类Base中的show方法。 编写下面的测试代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Base b; Derived d;</span><br><span class="line"></span><br><span class="line">b.show(); d.show();</span><br></pre></td></tr></table></figure>
<p>结果是：</p>
<p>Base</p>
<p>Derived</p>
<p>Base的对象调用了Base的方法，而Derived的对象调用了Derived的方法。因为直接用对象来调用成员函数时不会开启多态机制，故编译器直接根据b和d各自的类型就可以确定调用哪个show函数了，也就是在这两句调用中，编译器为它们每一个都确定了一个唯一的入口地址。这实际上类似于一个重载多态，虽然这两个show函数拥有不同的作用域。 那这样呢： Base b; Derived d; b.show(); b = d; b.show(); 现在，一个Base的对象被赋值为子类Derived的对象。</p>
<p>那这样呢：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Base b; Derived d;</span><br><span class="line"></span><br><span class="line">b.show(); b = d; b.show();</span><br></pre></td></tr></table></figure>
<p>现在，一个Base的对象被赋值为子类Derived的对象。</p>
<p>结果是：</p>
<p>Base</p>
<p>Base</p>
<p>对于熟悉Java的人而言，这不可理解。但实际上，C++不是Java，它更像C。“b = d”的意思，并不是Java中的“让一个指向Base类的引用指向它的子类对象”，而是“把Base类的子类对象中的Base子对象分割出来，赋值给b”。所以，只要b的类型始终是Base，那么b.show()调用的永远都是Base类中的show函数；换句话说，编译器总是把Base中的那个show函数的入口地址作为b.show()的入口地址。这根本就没用上多态。</p>
<p>单继承下的重写多态</p>
<p>那我们再这样：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Base b; Derived d;</span><br><span class="line"></span><br><span class="line">Base *p = &amp;b;</span><br><span class="line"></span><br><span class="line">p-&gt;show();</span><br><span class="line"></span><br><span class="line">p = &amp;d;</span><br><span class="line"></span><br><span class="line">p-&gt;show();</span><br></pre></td></tr></table></figure>
<p>这时，结果就对了：</p>
<p>Base</p>
<p>Derived</p>
<p>p是一个指向基类对象的指针，第一次它指向一个Base对象，p-&gt;show()调用了Base类的show函数；而第二次它指向了一个Derived对象，p-&gt;show()调用了Derived类的show函数。</p>
<p>总结：也就是说，只有是指针或者引用才是真正的多态，将子对象赋给父类对象其实类型向上转型.</p>
<h2 id="补补充"><a href="#补补充" class="headerlink" title="补补充"></a>补补充</h2><h3 id="1-const和指针的修饰问题"><a href="#1-const和指针的修饰问题" class="headerlink" title="1.  const和指针的修饰问题"></a>1.  const和指针的修饰问题</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> * a;   <span class="comment">//一个指针a指向const char</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> <span class="keyword">const</span> *a;      <span class="comment">//这两个是a指向的内容是常量，不能改变</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> * <span class="keyword">const</span> a;     <span class="comment">//首先a 是指针然后还是const</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (<span class="keyword">char</span>*) a;     <span class="comment">//这两个是a指针本身是常量，指针本身不能改变</span></span><br></pre></td></tr></table></figure>
<p>其实，可以看出如果const修饰的char(也就是类型本身或者是 <em>variable对指针的解引用）就是指针指向的内容是常量，反之就是修饰指针本身的。那我们可以总结一个识别方法就是：看const 两边（当然有的只有一边）的类型是类型（指针指向的内容）就是类型变量本身是常量（如const char </em> a和char const <em>a 的const两边是char，</em>a）。</p>
<p>当然两者都是常量就是：const char <em> const a;第一个const是类型常量，第二个才是指针常量。同样给出 const char &amp;a ;const char </em>a;在传递参数时使用。</p>
<h3 id="2-数组和指针的组合问题"><a href="#2-数组和指针的组合问题" class="headerlink" title="2. 数组和指针的组合问题"></a>2. 数组和指针的组合问题</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">char</span> * a[M];  </span><br><span class="line"></span><br><span class="line"><span class="comment">//这是指针数组，就是每一个元素是指针的数组，每个元素都要初始化。a[M]一看就是数组，这个数组每一个元素是char *，所以可以将char *扩展为一维数组然后a[M]就是二维数组了。其实就是M个指针。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> (*a)[N];  </span><br><span class="line"></span><br><span class="line"><span class="comment">//这是一个指针，这个指针指向N个char元素，即指向数组的指针，其实就是一个指针。把（*a)看着一个变量，这个变量是指向N个元素的指针，所以只是一个一维数组。把char (*a)[N]看成是char b[N]就可以了。</span></span><br></pre></td></tr></table></figure>
<h3 id="3-C-变量的初始化"><a href="#3-C-变量的初始化" class="headerlink" title="3. C++变量的初始化"></a>3. C++变量的初始化</h3><p>对于内置类型局部变量不进行初始化，但是分配地址，全局变量会进行默认初始化。对于类类型局部变量（没有显式初始化）会进行默认初始化（有默认构造函数，否则报错），但其内部的内置数据成员不会进行初始化（如果在默认构造函数没有进行初始化）。数组也是同样。</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/programming/">编程</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C++</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-yangsilang-visit-his-mother" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/06/06/yangsilang-visit-his-mother/" class="article-date">
      <time datetime="2019-06-06T04:48:42.000Z" itemprop="datePublished">2019-06-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/06/yangsilang-visit-his-mother/">四郎探母(看url:yangsilang-visit-his-mother)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>四郎探母可以说特别经典了，本人听过很多各式各样的版本，最震撼的还是杜月笙生日那次，哈哈。</p>
<hr>
<p>四郎探母是杨家将的故事，剧中淡化了战争，突出了忠孝仁义，人情伦理。</p>
<p>杨家共生了六个儿子，两个女儿，后来又收了一个义子，分别排行为大郎、二郎、三郎、四郎、五郎、六郎、七郎、八姐、九妹（京剧中不是这样，毕竟还有一出戏叫八郎探母）。他们个个是英雄好汉，每个人都能带兵打仗，独当一面。</p>
<p>杨四郎长得一表人材，武艺高强，英勇善战，在几个兄弟中间，最得父母的喜欢。他们寄希望于四郎，日后统率杨家将的非他莫属，然而谁能想到，金沙滩一场恶战，却改写了他的人生命运。</p>
<p>雁门关北面的金沙滩，北国的契丹王在那儿设下重兵。杨家将全部出征，拼死厮杀。但杨家将在这场大战中损失惨重，伤失元气。首先是大郎和二郎身亡，一个被乱箭射死，一个被大刀劈死；而三郎死得更加悲壮，他在追杀敌军时陷入淤泥之中，被对方的战马踩死；过后清点人数时，又发现四郎失踪，有的说是被北国俘虏了，有的说失散了。由于杨家大将死伤过半，朝廷虽给予封赏，但毕竟元气难以恢复；而且有人说三道四，伤透了杨家人心。在这种情况下，五郎为了超世脱俗，便出家当了和尚（一说是重伤被五台山方丈救下）。</p>
<p>杨四郎的确是和杨家将失散了，他是在向敌人冲杀时，被对方裹挟走的。人多，混乱，在情急中迷失了方向。可当他发现走错方向时晚了，因为对方的将领早已看到他勇猛厮杀，非普通军士，就让人把他给绑了，押送回营。再说契丹王的损失也十分惨重，老王在大战中身亡。众将佐觉得不可一日无王，经过合计，就推拥皇后萧绰执掌朝政，这就是历史上有名的萧太后。人们押着杨四郎来到萧太后跟前，备说详情，断言他肯定是杨家大将。既已被俘，杨四郎已经作好了必死的准备。不过他不甘心，他要时刻准备返回宋朝，和各位兄弟一起为国尽忠。于是，当萧太后问他叫什么时，他说了一个假名：木易。呵，不是杨家人，萧太后放心了。呵。</p>
<p>萧太后所生一女，名为铁镜公主，虽已年过十八，尚未许配人家。当然会有一些大臣来为公主说媒拉线，均因萧太后看不上那些想做她女婿的人，直到如今也没有把婚事定下来。萧太后见这个穆义长得相貌堂堂，又让他试了试武功，甚为满意。便让大臣作媒，把铁镜公主嫁给了他。</p>
<p>四郎家有娇妻孟氏，两人十分恩爱。他当然不愿娶北番公主，因为他并不打算在北方呆一辈子，一有机会他会跑回宋朝的。但经不住别人的威胁，他也只好屈从了。就这样，杨家人对他生死不知；而他也是时刻挂念着母亲和众兄弟姐妹。虽说萧太后和公主待他很好，但一片思乡之情无时无刻不在煎熬着他。</p>
<p>一晃十五年过去了，杨延辉由一个青年变成了已届而立的中年人。此时我猜杨四郎心境已与当年不同了。在辽做了驸马，皇亲国戚有家有口的，为什么还要回宋给皇上卖力呢。当然这是个人理解，也可以说如果我是杨四郎我是不会回去的哈哈哈哈。</p>
<p>萧天佐摆下天门大阵，六郎延昭挂帅，老母佘太君亲押粮草来到北番，四郎很想去见母亲一面。</p>
<ul>
<li>第一折坐宫，可见四郎和公主相敬如宾十分恩爱，公主也是性情中人。</li>
<li>见母，佘太君听闻四郎经历后，并没有国别民族的偏见，而是问公主贤不贤惠，可不可爱。</li>
<li>四郎已经回到宋营，但为还令箭仍赶在天亮之前回到银安，可见与公主恩爱有佳，也可见他并不是很想为宋朝继续卖命了。</li>
<li>见妻现在逐渐不演了，咱也不知道为什么…回营，六郎、佘太君、孟氏、八姐九妹好一通哭，没拦住，天地为大忠孝当先，日后见母梦里再见。</li>
<li>四郎得救后，萧太后命其把守北天门，并把金鈚箭给了他，虽说是不准他回营探母，为什么不理解成，是对杨延辉的信任，允许他想妈了就回去看看呢？</li>
</ul>
<hr>
<p><strong>杨六郎告御状</strong></p>
<p>这段京剧一般不演了，只听过李军老师的徽剧唱段，情感很很很到位，真不愧是我准叔，很有准（真）。</p>
<p>杨六郎在八贤王的帮助下，把潘洪（潘仁美）搞死了。</p>
<blockquote>
<p>我杨家下幽州，八骑马八杆枪，好似八条蛟龙弄海潮，到如今只落得单骑延昭。</p>
</blockquote>
<p><strong>八贤王</strong></p>
<p>赵德芳（八贤王、八王），宋太祖赵匡胤第四子，宋太宗赵光义之侄，宋真宗赵恒的堂兄，北宋宗室。在戏曲演义中，赵德芳也被虚构为手持金锏，上打昏君，下打谗臣的正气凛然的“八贤王”形象，是正义化身，出现于杨家将、包青天、三侠五义等故事中。</p>
<p>赵匡胤去世之后，本来皇位的人选就是赵德芳，但是此时的赵德芳仅仅只有3岁，根本无法担任皇帝，于是赵光义申请做了摄政王，但是就在第二天上朝的时候，不知道是不是赵光义派人安排好了，满朝的文武百官纷纷要求摄政王的赵光义登基做皇帝，对于小太子赵德芳，大家认为等到赵德芳长大之后，赵光义再禅让，这样才能让天下安定，文武百官才能够信服，最终赵光义如愿以偿的做了大宋朝的第二任皇帝。</p>
<p>赵光义做了皇帝之后，首先的第一件事就是安顿赵匡胤的妻子和儿子，但是这样登基的赵光义在很多的礼教上是说不过去的，在宋皇后知道赵光义做了皇帝的消息之后，于是宋皇后公然登上金銮宝殿，对着赵光义破口大骂，毕竟是赵光义害死了自己的亲哥哥，而且还公开抢夺自己侄子的皇位，这样的举动真的是无德无义之人，面对皇后的唾骂，赵光义在无奈之下便开始对他们进行封赏，封宋皇后为皇太后。</p>
<p>不过，最让人为难的还是小太子赵德芳，最大的封赏就是把皇位还给赵德芳，但是赵德芳年纪太小，无法做皇帝，再说了赵光义也舍不得自己的皇位，于是赵光义便封了赵德芳为保国王、护国王、上殿不参王、下殿不辞王、殿前王、殿左王、殿右王、殿后王（听着这么像郭老编的，听书听个乐），八贤王，世袭罔替的八大贤王，并赐瓦面金锏，上打昏君，下打谗臣。</p>
<p>所以为什么八王上金殿他那么横，因为江山是人家家里的。</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/opera/">听戏</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/京剧/">京剧</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-songshijie" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/31/songshijie/" class="article-date">
      <time datetime="2019-05-31T10:15:02.000Z" itemprop="datePublished">2019-05-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/31/songshijie/">四进士(又名宋士杰)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>周信芳先生、马连良先生均以《四进士》享名，麒派的宋士杰苍劲老辣，马派潇洒油滑。</p>
<p>我本人完整听过麒麟童周信芳先生的电影，张学津先生、陈少云老师那一版，还有别的版本的一些片段。</p>
<hr>
<p>宋士杰是一个讼师。他们的职业是包打官司，即包揽词讼。凡有衙门处即有讼师。只要你给他钱，他可以把你的官司包下来，把你的对手搞得倾家荡产，一败涂地。生活里，他们也是很刁钻促狭的。 讼师住的地方。做小买卖的都不愿停留。邻居家的孩子都不敢和他们家的孩子打架。然而《四进士》却写了一个比较特别的好讼师。</p>
<p>宋士杰的好处在于：一是办事傲上。二是好管闲事。办事傲上是因为他有才，好管闲事是因为他心善。</p>
<p>写他的爱管闲事，从他怕管闲事写起。</p>
<hr>
<p>明朝嘉靖年间，新科进士毛朋、田伦、顾读（顾读一出场就是个白脸，一看就不是什么好东西）、刘题四人出京为官，当时严嵩专权，同仇敌忾。相约饮酒中，相互勉励，赴任后不违法渎职，以报海瑞举荐之功德。</p>
<p>当时河南上蔡县姚廷春的妻子田氏图谋财产，毒死丈夫的弟弟姚廷美，又串通弟媳杨素贞之兄杨青，又把杨素贞转卖给布商杨春为妻。杨春听素贞哭诉，可怜她的遭遇，撕毁身契，代她告状。</p>
<p>原来是四本连台本戏，现在前面的一般不演了，四进士简化成一台本后直接从柳林告状开始。</p>
<p>杨春可怜杨素贞的遭遇，要代她去越衙告状，遇到八府巡按毛朋，毛朋是个好人，于是代写状纸。</p>
<p>杨春杨素贞在路上被一群小混混算计，走散了，杨素贞遇到了宋士杰。</p>
<p>宋士杰的出场是很平淡的。几记小锣，他就走出来了。四句诗罢，自报家门：</p>
<blockquote>
<p>老汉宋士杰。在前任道台衙门，当过一名刑房书吏。只因办事傲上。 才将我的刑房革退。在西门以外，开了一所小小店房。不过是避嫌而已……”</p>
</blockquote>
<p>避嫌。避什么嫌呢?避官场之嫌。 开店是一种姿态，表示引退闲居，从此不再往衙门里插手，免遭是非物议。 他显然也不甘寂寞。 偶尔给吃衙门饭的人一点指点。杯酒之间，三言两语。平常则是韬晦深藏，很少活动的了。以至顾读听说宋士杰这名字。吃惊道：”宋士杰!这老儿还未曾死么？”</p>
<p>他卷进一场复杂的纠纷。完全是无心的，偶然的。</p>
<p>宋士杰回家喊老婆出来出手从小混混手中救了杨素贞。</p>
<blockquote>
<p>救人一命少活十年呐。</p>
</blockquote>
<p>救下杨素贞，得知她是来越衙告状，宋士杰看了毛朋写的状纸：（我词记不准，也可能串版本什么的）</p>
<blockquote>
<p>牛吃房上草，风吹千斤石。一字入公门，不赖不成词。</p>
</blockquote>
<blockquote>
<p>此人不得第便罢，得了第，少不了八台之位。</p>
</blockquote>
<p>宋士杰收杨素贞为干女儿，替杨素贞告状。在路上，遇到丁旦请宋伯伯喝酒，顺便请教一桩疑案，错过了顾读升堂，便携女击鼓鸣冤。头公堂：</p>
<blockquote>
<p>顾读 （白） 宋士杰，你还不曾死啊？<br>宋士杰 （白） 哈哈！阎王不要命，小鬼不来缠，我是怎样得死啊！<br>顾读 （白） 你为何包揽词讼？<br>宋士杰 （白） 怎见得小人包揽词讼？<br>顾读 （白） 杨素贞越衙告状，住在你的家中，分明你挑唆而来，岂不是包揽词讼？<br>宋士杰 （白） 小人有下情回禀。<br>顾读 （白） 讲！<br>宋士杰 （白） 嗻！小人宋士杰，在前任道台衙门当过一名刑房书吏。只因我办事傲上，才将我的刑房革掉。在西门以外，开了一所小小店房，不过是避闲而已。曾记得那年去往河南上蔡县办差，住在杨素贞她你的家中。杨素贞那时间才长这么大，拜在我的名下，以为义女。数载以来，书不来，信不去，杨素贞她父已死。她长大成人，许配姚廷梅为妻。她的亲夫被人害死，来到信阳州，越衙告状。常言道，是亲者不能不顾，不是亲者不能相顾。她是我的干女儿，我是她的干父，干女儿不住在干父家中，难道说，教她住在庵堂寺院！<br>顾读 （白） 嘿！你好一张利口！<br>宋士杰 （白） 句句实言。<br>顾读 （白） 杨素贞讨保！<br>宋士杰 （白） 小人愿保。<br>顾读 （白） 啊！你为何保她？<br>宋士杰 （白） 干父不保干女儿，他们哪一个敢保？<br>顾读 （白） 我原要你保。<br>宋士杰 （白） 我保保何妨！</p>
</blockquote>
<p>一件没影子的事，宋士杰说得有鼻子有眼，活灵活现，点水不漏，无懈可击。这段辩词，层次清楚，语调铿锵，掷地作金石声!。”这长这大”，真亏他想得出来。什么叫讼师?这就叫讼师：数白道黑，将无作有。</p>
<p>田氏得知有人告她，让弟弟田伦给顾读写一封求情信，三百两白银压书信，田伦很犹豫但迫于母亲的压力还是写了。两个送信的公差住在宋士杰的店中，宋士杰见他们口角带字。</p>
<blockquote>
<p>公差甲 （白） 伙计，你看田、顾、刘三位大人，谁忠谁奸？<br>公差乙 （白） 伙计，管他谁忠谁奸，我们喝酒罢！这个年头，就是，酒酒酒，终日有，有钱的在天堂，无钱的下地狱。</p>
</blockquote>
<p>分析出了缘由，盗取书信，抄在衣襟上。所以田伦是把谱子也写上了吗…</p>
<blockquote>
<p>（西皮原板） 拜上了信阳州顾大人。<br>双塔寺前分别后，<br>倒有几载未相逢。<br>姚家庄有个杨氏女，<br>（西皮流水板） 她本是姚家不贤人。<br>药酒害死亲夫主，<br>反赖我姐丈姚廷椿。<br>三百两银子押书信，<br>还望年兄念弟情。<br>上风官司归故里，<br>登门叩谢顾年兄。</p>
</blockquote>
<p>二公堂，杨素贞被迫画押，宋士杰挨了四十个板子，宋士杰决定向毛朋告状，一状告倒三个官。</p>
<blockquote>
<p>顾读 （白） 这个……宋士杰，听你之言，莫非你受了贿了？<br>宋士杰 （白） 受贿？<br>顾读 （白） 受贿。<br>宋士杰 （白） 受贿。受贿不多……<br>顾读 （白） 多少？<br>宋士杰 （白） 三百两！<br>顾读 （白） 啊！<br>来，扯下去打！<br>宋士杰 （白） 且慢！你打我不得。<br>顾读 （白） 打了你，自然有你的过犯！<br>宋士杰 （白） 打我什么过犯？<br>顾读 （白） 我打你这个……<br>宋士杰 （白） 大人？<br>顾读 （白） 这……<br>宋士杰 （白） 大人？<br>顾读 （白） 哎，我打你一个欺官傲上！<br>宋士杰 （白） 嘿嘿！今天不挨你几个板子，你也不好意思退堂。来来来，打呀！<br>宋士杰 （白） 谢大人的责！<br>顾读 （白） 宋士杰，我打得你可公？<br>宋士杰 （白） 不公。<br>顾读 （白） 打得你可是？<br>宋士杰 （白） 不是。<br>顾读 （白） 不公也要公，不是也要是。从今以后，你要少来见我！<br>宋士杰 （白） 见见何妨？<br>顾读 （白） 再若见我，定要你的老命！<br>宋士杰 （白） 不定是谁要谁的命！<br>顾读 （白） 下去！<br>宋士杰 （白） 走。<br>顾读 （白） 轰了下去！<br>宋士杰 （白） 走哇！<br>（西皮散板） 公堂打我四十板，<br>一状要告他三个官！</p>
</blockquote>
<blockquote>
<p>可恨信阳道，贪赃又放刁。打我四十板，哎！恶气何日消！</p>
</blockquote>
<p>宋士杰写好状纸要找毛朋告状，巧遇到杨春，便让杨春去把状纸递上了。此处有成心让杨春去挨板子，可以这个遭老头子也留有心眼。</p>
<blockquote>
<p>田伦密札求情，官吏过简；顾读贪赃卖法，匿案准情；刘题好酒贪杯，不理民词。</p>
</blockquote>
<p>兄弟四人见面，三公堂</p>
<blockquote>
<p>不要这样的虎威，这是按院的行埠，不是你道台衙门了。</p>
</blockquote>
<p>宋士杰说了缘由</p>
<blockquote>
<p>毛朋 （白） 二位年兄，宋士杰和衣襟，就是你二人的对证了！<br>顾读 （白） 年兄，你不应当与我那封书信！<br>田伦 （白） 你不该收我那三百两银子！<br>顾读 （白） 唉！<br>田伦 （白） 我也是母命难违；有道是：<br> （念） 父母恩情重……<br>毛朋 （念） 朝廷法度严！<br>顾读 （念） 不听恩师语……<br>毛朋 （念） 王法大如天！<br> （白） 二位年兄，你我进京赴试，得中进士，只因不拜严嵩为师，可恨奸贼专权，不放我等为官。多蒙海瑞老师，苦苦保奏，才放我等帘外为官。我们出京之时，在双塔寺盟下誓愿，不许贪赃卖法，官吏过简，若有此事，棺木一口，仰面还乡。小弟不才，实授八府巡按，查得上三府，官是清官，民是顺民。查得下五府，官是赃官，民是刁民。查来查去，这赃官二字却应在我们年兄弟的身上，叫小弟哪里去寻，哪里去访！<br>田伦、顾读 （白） 求大人谅情一二！<br>毛朋 （白） 说什么谅情一二！圣上恩赐上方宝剑，一同拜过，小弟得罪了。</p>
</blockquote>
<p>宋士杰再上</p>
<blockquote>
<p>宋士杰 （白） 与大人叩头。<br>毛朋 （白） 宋士杰，有道是“民不告官”，你一状告倒两员封疆大吏，一个百里县令，岂能无罪！<br>宋士杰 （白） 望大人格外施恩！<br>毛朋 （白） 念你年迈，发往边外充军，当堂上刑。下去！<br>宋士杰 （白） 谢大人。</p>
</blockquote>
<p>绝唱：</p>
<p>（西皮散板）</p>
<blockquote>
<p>公堂之上上了刑，<br>好似鳌鱼把钩吞。<br>悲切切出了都察院，<br>只见杨春与素贞。<br>你家在河南上蔡县，<br>你住南京水西门。<br>我三人从来不相认，<br>宋士杰与你们是哪门子亲！<br>我为你挨了四十板，<br>我为你披枷带锁边外去充军。<br>可怜我年迈人离乡井，<br>杨春、杨素贞啊！<br>谁是我披麻带孝人！<br>干父不要两泪淋，<br>孩儿言来听分明：<br>倘若干父下世早，<br>儿是披麻带孝人。<br>唉，妄想啊妄想！</p>
</blockquote>
<p>发现毛朋是代写状纸的人后，宋士杰又上堂耍了一顿嘴皮子，最后完美结局。</p>
<blockquote>
<p>（西皮散板） 你认得清来见得明，<br>我充军的事儿就去不成哪！<br>二次进了都察院，<br>尊声青天老大人：<br>百姓告官是有罪，<br>无有状子告不成！<br>毛朋 （西皮散板） 本院奉命出帝京，<br>明查暗访为黎民。<br>为不平我把状子写，<br>王法条条不徇情。<br>宋士杰 （西皮散板） 大人奉命出帝京，<br>明查暗访为黎民。<br>有日大人回朝转，<br>你在凌烟阁上标美名，你是个大忠臣。<br>毛朋 （西皮散板） 柳林写状为百姓，<br>宋士杰 （西皮散板） 宋士杰打的是抱不平。<br>毛朋 （西皮散板） 黎民告官当问斩，<br>宋士杰 （白） 大人！<br>（西皮散板） 你在那柳林写状，犯法你是头一名！<br>毛朋 （白） 哎呀！<br>（西皮散板） 宋士杰说话真凶狠，<br>问得本院似哑人！<br>下得位来忙松捆，<br>你是我说不倒的老先生！</p>
</blockquote>
<p>有的版本没有下面这一段，不知道有没有后，但最后杨春都是他的义子了。</p>
<blockquote>
<p>（白） 宋士杰，你可有后？<br>宋士杰 （白） 小人乏嗣无后！<br>毛朋 （白） 也罢！将杨春拜在你的名下以为义子，如何？<br>宋士杰 （白） 不敢。<br>毛朋 （白） 杨春，拜见你干父。<br>杨春 （白） 拜见干父。<br>宋士杰 （白） 少礼！<br>毛朋 （白） 同到姚廷梅坟前一祭，以明善恶。<br>宋士杰 （白） 大人天恩！</p>
</blockquote>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/opera/">听戏</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/京剧/">京剧</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-resume" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/29/resume/" class="article-date">
      <time datetime="2019-05-29T12:32:02.000Z" itemprop="datePublished">2019-05-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/29/resume/">简历</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>2019-05-31版。</p>
<p>有pdf版，会好看一些。</p>
<hr>
<h1 id="孙少洁"><a href="#孙少洁" class="headerlink" title="孙少洁"></a>孙少洁</h1><p>女 | 19 | 本科在读 | 工作经验：0.5年</p>
<p>北京科技大学 | 计算机类 | 博客：cracke-s-j.github.io</p>
<p>电话：13697842656  |  email：<a href="mailto:evildoer_sun@outlook.com" target="_blank" rel="noopener">evildoer_sun@outlook.com</a></p>
<h2 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈"></a>技术栈</h2><ul>
<li>熟悉Android逆向基本流程；熟悉应用加固常用手段。 </li>
<li>熟悉IDA、jadx、apktool等常用逆向分析工具，熟悉Fdex2等脱壳工具。</li>
<li>熟练掌握静态分析，动态调试等逆向技术，熟悉frida、Xposed等热门hook框架。</li>
<li>熟悉Java、C++，熟练运用python，具有编写脚本、开发工具的能力。</li>
<li>熟练掌握JNI编程，读过android源码，了解dvm、art虚拟机运行机制、android打包、运行过程。</li>
<li>熟悉安卓加壳技术，了解一些通用脱壳机的原理，并能够手动脱一、二代壳。</li>
<li>熟悉ARM、x86/64等多种指令集，熟悉编译原理，有阅读和修改汇编的能力。</li>
<li>熟悉常用加解密算法；熟悉多种算法与数据结构来优化代码。</li>
<li>有阅读英文文档的能力；有较强沟通能力与团队协作意识。</li>
</ul>
<h2 id="项目-工作经历"><a href="#项目-工作经历" class="headerlink" title="项目/工作经历"></a>项目/工作经历</h2><ul>
<li>逆向分析过android市场上多款app，写过插件，出过应用修改版。</li>
<li>在保密项目无源程序的情况下，独立将几万行sparc汇编翻译为C语言。</li>
<li>参与国内某端游辅助制作，主要负责动态分析关键call、编写客户端。</li>
<li>在学校参与“基于深度学习的网络爬虫鉴别”项目，主要负责机器学习模型建立与数据统计。</li>
<li>在梆梆安全任职安全服务工程师，主要负责app渗透测试，培训，应急响应，新技术研究。</li>
<li>工作期间负责过一段时间智能合约安全研究，完成”智能合约源码审计标准“，并培训新人相关知识。</li>
</ul>
<h2 id="自我描述"><a href="#自我描述" class="headerlink" title="自我描述"></a>自我描述</h2><ul>
<li>热爱技术；热爱学习；热爱分享；心态稳，不畏困难。</li>
<li>初中开始接触编程，对计算机尤其是逆向有浓厚的兴趣与长久的热情，享受破解的过程带来的快乐。</li>
<li>现本科大一在读，课余时间较多，紧急事件随叫随到，接受任何时间加班。</li>
<li>现在仍在不断学习，简历会随时更新调整。没有研究过怎么写简历。</li>
</ul>
<h2 id="兴趣爱好"><a href="#兴趣爱好" class="headerlink" title="兴趣爱好"></a>兴趣爱好</h2><ul>
<li>写代码</li>
<li>逆向分析市场上一些APP</li>
<li>为开发的朋友的app加固</li>
<li>逛论坛、逛github、参加技术交流会议</li>
<li>养猫、云养猫</li>
<li>中国传统曲艺，京评梆曲</li>
</ul>
<hr>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/resume/">简历</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/resume/">resume</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-CTF-android" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/29/CTF-android/" class="article-date">
      <time datetime="2019-05-29T11:42:47.000Z" itemprop="datePublished">2019-05-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/29/CTF-android/">小菜比ssj吹头发记</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>ssj是一只小菜比，ta应公司要求要写吹头发android逆向屁屁踢，所以ta需要起码做点题。</p>
</blockquote>
<h2 id="XCTF-1th-apk逆向"><a href="#XCTF-1th-apk逆向" class="headerlink" title="XCTF 1th apk逆向"></a>XCTF 1th apk逆向</h2><p>这是一道签到题，可以动态调试，可以还原算法，可以打印log。ssj选择了还原算法，因为就是一个md5。</p>
<p><strong>flag{bc72f242a6af3857};</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchAlgorithmException </span>&#123;</span><br><span class="line">    String userName = <span class="string">"Tenshine"</span>;</span><br><span class="line">    MessageDigest digest =MessageDigest.getInstance(<span class="string">"MD5"</span>);</span><br><span class="line">    digest.update(userName.getBytes());</span><br><span class="line">    String hexstr = toHexString(digest.digest(), <span class="string">""</span>);</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; hexstr.length(); i += <span class="number">2</span>) &#123;</span><br><span class="line">        sb.append(hexstr.charAt(i));</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(sb.toString());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">toHexString</span><span class="params">(<span class="keyword">byte</span>[] bytes, String separator)</span> </span>&#123;</span><br><span class="line">    StringBuilder hexString = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">byte</span> b : bytes) &#123;</span><br><span class="line">        String hex = Integer.toHexString(b &amp; <span class="number">255</span>);</span><br><span class="line">        hexString.append(hex).append(separator);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hexString.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="XCTF-easy-dex"><a href="#XCTF-easy-dex" class="headerlink" title="XCTF easy-dex"></a>XCTF easy-dex</h2><p>本题flag: <strong>qwb{TH3y_Io&lt;e_EACh_OTh3r_FOrEUER}</strong></p>
<p>这题dex是动态加载的，算是0代壳吧，加载条件是10秒里晃手机100次。IDA反编译so，看到它是先加载dex，然后优化了dex，把原dex删了，我们要做的是得到原dex，然后分析加密算法。</p>
<ol>
<li><p>hook掉remove函数，阻止文件被删除。</p>
</li>
<li><p>直接将存储在lib中的加密后的dex异或解密，再zlib解压。</p>
</li>
<li><p>静态修改so，把remove函数patch掉。（本人用的方法，上面两个只是说说）</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:0000275A                 MOV             R0, R11</span><br><span class="line">.text:0000275C                 BL              sub_2368</span><br><span class="line">.text:00002760                 ADD             R0, SP, #0x160+filename ; filename</span><br><span class="line">.text:00002762                 BLX             remove ; 把这句patch掉</span><br><span class="line">.text:00002766                 LDR             R1, =(aFindmydex - 0x2770)</span><br><span class="line">.text:00002768                 MOVS            R0, #4</span><br><span class="line">.text:0000276A                 LDR             R2, =(aCongratulation - 0x2772)</span><br><span class="line">.text:0000276C                 ADD             R1, PC  ; &quot;FindMyDex&quot;</span><br><span class="line">.text:0000276E                 ADD             R2, PC  ; &quot;Congratulations!! You made it!&quot;</span><br><span class="line">.text:00002770                 BLX             __android_log_print</span><br></pre></td></tr></table></figure>
<p>分析dex，看出是Twofish算法,在线解密。<br>密文是：884df2da1105d62ce06d551f18a590ad40ad805405a29ee21246e647059dc2c6751dd40670fc51540916cd5fde0c2f4d。<br>密钥是：I have a male fish and a female fish.</p>
<h2 id="XCTF-黑客精神"><a href="#XCTF-黑客精神" class="headerlink" title="XCTF 黑客精神"></a>XCTF 黑客精神</h2><p>本题坑点在于，要给它开读写权限，否则只能手动翻找flag格式…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.rodata:00002E77                 DCB 0x66 ; f</span><br><span class="line">.rodata:00002E78                 DCB 0x6C ; l</span><br><span class="line">.rodata:00002E79                 DCB 0x61 ; a</span><br><span class="line">.rodata:00002E7A                 DCB 0x67 ; g</span><br><span class="line">.rodata:00002E7B                 DCB 0x2C ; ,</span><br><span class="line">.rodata:00002E7C                 DCB 0xE6</span><br><span class="line">.rodata:00002E7D                 DCB 0xA0</span><br><span class="line">.rodata:00002E7E                 DCB 0xBC</span><br><span class="line">.rodata:00002E7F                 DCB 0xE5</span><br><span class="line">.rodata:00002E80                 DCB 0xBC</span><br><span class="line">.rodata:00002E81                 DCB 0x8F</span><br><span class="line">.rodata:00002E82                 DCB 0xE4</span><br><span class="line">.rodata:00002E83                 DCB 0xB8</span><br><span class="line">.rodata:00002E84                 DCB 0xBA</span><br><span class="line">.rodata:00002E85                 DCB 0x78 ; x</span><br><span class="line">.rodata:00002E86                 DCB 0x6D ; m</span><br><span class="line">.rodata:00002E87                 DCB 0x61 ; a</span><br><span class="line">.rodata:00002E88                 DCB 0x6E ; n</span><br><span class="line">.rodata:00002E89                 DCB 0x7B ; &#123;</span><br><span class="line">.rodata:00002E8A                 DCB 0xE2</span><br><span class="line">.rodata:00002E8B                 DCB 0x80</span><br><span class="line">.rodata:00002E8C                 DCB 0xA6</span><br><span class="line">.rodata:00002E8D                 DCB 0xE2</span><br><span class="line">.rodata:00002E8E                 DCB 0x80</span><br><span class="line">.rodata:00002E8F                 DCB 0xA6</span><br><span class="line">.rodata:00002E90                 DCB 0x7D ; &#125;</span><br></pre></td></tr></table></figure>
<p>密文：EoPAoY62@ElRD；密钥：W3_arE_whO_we_ARE</p>
<p>加密算法就是一个异或。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> key[] = <span class="string">"W3_arE_whO_we_ARE"</span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Encode</span><span class="params">(<span class="keyword">char</span> s[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(s); </span><br><span class="line">    <span class="keyword">int</span> j = <span class="number">2016</span>; </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i != len;i++) &#123; </span><br><span class="line">        <span class="keyword">if</span>(i%<span class="number">3</span> == <span class="number">1</span>)&#123; </span><br><span class="line">            j = (j+<span class="number">5</span>)%<span class="number">16</span>; </span><br><span class="line">            s[i] = s[i]^key[j+<span class="number">1</span>]; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(i%<span class="number">3</span> == <span class="number">2</span>) &#123; </span><br><span class="line">            j = (j+<span class="number">7</span>)%<span class="number">15</span>; </span><br><span class="line">            s[i] = s[i]^key[j+<span class="number">2</span>]; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span>&#123; </span><br><span class="line">            j = (j+<span class="number">3</span>)%<span class="number">13</span>; </span><br><span class="line">            s[i] = s[i]^key[j+<span class="number">3</span>]; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="XCTF-love你是谁"><a href="#XCTF-love你是谁" class="headerlink" title="XCTF love你是谁"></a>XCTF love你是谁</h2><p>一波翻找直接找到了flag。</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const-string v7, <span class="string">"You get the sorted flag\uff1a20667 25105 26159 36924"</span></span><br></pre></td></tr></table></figure>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/programming/">编程</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/29/hello-world/" class="article-date">
      <time datetime="2019-05-29T09:33:10.925Z" itemprop="datePublished">2019-05-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/29/hello-world/">Hello World</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ssj-android-shell-0th" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/17/ssj-android-shell-0th/" class="article-date">
      <time datetime="2019-05-17T11:38:07.000Z" itemprop="datePublished">2019-05-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/17/ssj-android-shell-0th/">小菜比ssj写了一个壳子</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>nemo大佬来北京，聊天中问起我最近有没有写代码，我一想，好像是真没有，所以单纯是想来写个代码。</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>零代壳，稍微明白点的人用010就（或者什么方法都能）可以拿掉，但是因为太垃圾通用脱壳机不能脱，可以挡一些不是很明白的人hhh，批话王。思路是从百度剽窃的，后续还会升级，再加一些其它加固措施。</p>
<h3 id="三部分"><a href="#三部分" class="headerlink" title="三部分"></a>三部分</h3><p>整个过程主要有三部分，第一是源apk，第二是那个壳（？可以这么叫），第三是一个加密工具，把前2个合成一个apk。前两个是android工程，第三个是用什么写都行此处用的java。</p>
<h4 id="源apk"><a href="#源apk" class="headerlink" title="源apk"></a>源apk</h4><p>这个就是源apk，这个要注意的是写的时候要有一个application。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        Log.i(<span class="string">"demo"</span>, <span class="string">"source apk onCreate:"</span>+<span class="keyword">this</span>);</span><br><span class="line">        Toast.makeText(MyApplication.<span class="keyword">this</span>,<span class="string">"application,start!"</span>,Toast.LENGTH_LONG).show();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>application标签里，android:name那个地方写我们写的application，否则就是默认系统给创建的。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">".MyApplication"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:allowBackup</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:icon</span>=<span class="string">"@mipmap/ic_launcher"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:roundIcon</span>=<span class="string">"@mipmap/ic_launcher_round"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:supportsRtl</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">"@style/AppTheme"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:ignore</span>=<span class="string">"GoogleAppIndexingWarning"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".MainActivity"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="那个壳"><a href="#那个壳" class="headerlink" title="那个壳"></a>那个壳</h4><p>两个类，代码写的已经很明白了，不多解释。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String appkey = <span class="string">"APPLICATION_CLASS_NAME"</span>;</span><br><span class="line">    <span class="keyword">private</span> String apkFileName;</span><br><span class="line">    <span class="keyword">private</span> String libPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//attachBaseContext执行在onCreate前，重写它来加载源apk</span></span><br><span class="line">    <span class="meta">@RequiresApi</span>(api = Build.VERSION_CODES.KITKAT)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File odex = <span class="keyword">this</span>.getDir(<span class="string">"payload_odex"</span>, MODE_PRIVATE);</span><br><span class="line">            File libs = <span class="keyword">this</span>.getDir(<span class="string">"payload_lib"</span>, MODE_PRIVATE);</span><br><span class="line">            String odexPath = odex.getAbsolutePath();</span><br><span class="line">            libPath = libs.getAbsolutePath();</span><br><span class="line">            apkFileName = odex.getAbsolutePath() + <span class="string">"/payload.apk"</span>;</span><br><span class="line">            File dexFile = <span class="keyword">new</span> File(apkFileName);</span><br><span class="line">            Log.i(<span class="string">"demo"</span>, <span class="string">"apk size:"</span>+dexFile.length());</span><br><span class="line">            <span class="keyword">if</span> (!dexFile.exists()) &#123;</span><br><span class="line">                dexFile.createNewFile();</span><br><span class="line">                <span class="keyword">byte</span>[] dexdata = <span class="keyword">this</span>.readDexFileFromApk();</span><br><span class="line">                <span class="keyword">this</span>.splitPayLoadFromDex(dexdata);</span><br><span class="line">            &#125;</span><br><span class="line">            Object currentActivityThread = RefInvoke.invokeStaticMethod(</span><br><span class="line">                    <span class="string">"android.app.ActivityThread"</span>, <span class="string">"currentActivityThread"</span>,</span><br><span class="line">                    <span class="keyword">new</span> Class[] &#123;&#125;, <span class="keyword">new</span> Object[] &#123;&#125;);</span><br><span class="line">            String packageName = <span class="keyword">this</span>.getPackageName();</span><br><span class="line">            ArrayMap mPackages = (ArrayMap) RefInvoke.getFieldOjbect(</span><br><span class="line">                    <span class="string">"android.app.ActivityThread"</span>, currentActivityThread,</span><br><span class="line">                    <span class="string">"mPackages"</span>);</span><br><span class="line">            <span class="keyword">assert</span> mPackages != <span class="keyword">null</span>;</span><br><span class="line">            WeakReference wr = (WeakReference) mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">assert</span> wr != <span class="keyword">null</span>;</span><br><span class="line">            DexClassLoader dLoader = <span class="keyword">new</span> DexClassLoader(apkFileName, odexPath,</span><br><span class="line">                    libPath, (ClassLoader) RefInvoke.getFieldOjbect(</span><br><span class="line">                    <span class="string">"android.app.LoadedApk"</span>, wr.get(), <span class="string">"mClassLoader"</span>));</span><br><span class="line">            RefInvoke.setFieldObject(<span class="string">"android.app.LoadedApk"</span>, <span class="string">"mClassLoader"</span>,</span><br><span class="line">                    wr.get(), dLoader);</span><br><span class="line">            Log.i(<span class="string">"demo"</span>,<span class="string">"classloader:"</span>+dLoader);</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                Object actObj = dLoader.loadClass(<span class="string">"com.ssj.crackeme.forceapkobj.MainActivity"</span>);</span><br><span class="line">                Log.i(<span class="string">"demo"</span>, <span class="string">"actObj:"</span>+actObj);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                Log.i(<span class="string">"demo"</span>, <span class="string">"activity:"</span>+Log.getStackTraceString(e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.i(<span class="string">"demo"</span>, <span class="string">"error:"</span>+Log.getStackTraceString(e));</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiresApi</span>(api = Build.VERSION_CODES.KITKAT)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        loadResources(apkFileName);</span><br><span class="line">        Log.i(<span class="string">"demo"</span>, <span class="string">"onCreate"</span>);</span><br><span class="line"></span><br><span class="line">        String appClassName = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ApplicationInfo ai = <span class="keyword">this</span>.getPackageManager()</span><br><span class="line">                    .getApplicationInfo(<span class="keyword">this</span>.getPackageName(), PackageManager.GET_META_DATA);</span><br><span class="line">            Bundle bundle = ai.metaData;</span><br><span class="line">            <span class="keyword">if</span> (bundle != <span class="keyword">null</span> &amp;&amp; bundle.containsKey(appkey)) &#123;</span><br><span class="line">                appClassName = bundle.getString(appkey);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.i(<span class="string">"demo"</span>, <span class="string">"have no application class name"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            Log.i(<span class="string">"demo"</span>, <span class="string">"error:"</span> + Log.getStackTraceString(e));</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object currentActivityThread = RefInvoke.invokeStaticMethod(</span><br><span class="line">                <span class="string">"android.app.ActivityThread"</span>, <span class="string">"currentActivityThread"</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;&#125;, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        Object mBoundApplication = RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">"android.app.ActivityThread"</span>, currentActivityThread,</span><br><span class="line">                <span class="string">"mBoundApplication"</span>);</span><br><span class="line">        Object loadedApkInfo = RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">"android.app.ActivityThread$AppBindData"</span>,</span><br><span class="line">                mBoundApplication, <span class="string">"info"</span>);</span><br><span class="line"></span><br><span class="line">        RefInvoke.setFieldObject(<span class="string">"android.app.LoadedApk"</span>, <span class="string">"mApplication"</span>,</span><br><span class="line">                loadedApkInfo, <span class="keyword">null</span>);</span><br><span class="line">        Object oldApplication = RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">"android.app.ActivityThread"</span>, currentActivityThread,</span><br><span class="line">                <span class="string">"mInitialApplication"</span>);</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;Application&gt; mAllApplications = (ArrayList&lt;Application&gt;) RefInvoke</span><br><span class="line">                .getFieldOjbect(<span class="string">"android.app.ActivityThread"</span>,</span><br><span class="line">                        currentActivityThread, <span class="string">"mAllApplications"</span>);</span><br><span class="line">        <span class="keyword">assert</span> mAllApplications != <span class="keyword">null</span>;</span><br><span class="line">        mAllApplications.remove(oldApplication);</span><br><span class="line">        ApplicationInfo appinfo_In_LoadedApk = (ApplicationInfo) RefInvoke</span><br><span class="line">                .getFieldOjbect(<span class="string">"android.app.LoadedApk"</span>, loadedApkInfo,</span><br><span class="line">                        <span class="string">"mApplicationInfo"</span>);</span><br><span class="line">        ApplicationInfo appinfo_In_AppBindData = (ApplicationInfo) RefInvoke</span><br><span class="line">                .getFieldOjbect(<span class="string">"android.app.ActivityThread$AppBindData"</span>,</span><br><span class="line">                        mBoundApplication, <span class="string">"appInfo"</span>);</span><br><span class="line">        <span class="keyword">assert</span> appinfo_In_LoadedApk != <span class="keyword">null</span>;</span><br><span class="line">        appinfo_In_LoadedApk.className = appClassName;</span><br><span class="line">        <span class="keyword">assert</span> appinfo_In_AppBindData != <span class="keyword">null</span>;</span><br><span class="line">        appinfo_In_AppBindData.className = appClassName;</span><br><span class="line">        Application app = (Application) RefInvoke.invokeMethod(</span><br><span class="line">                <span class="string">"android.app.LoadedApk"</span>, <span class="string">"makeApplication"</span>, loadedApkInfo,</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;<span class="keyword">boolean</span>.class, Instrumentation.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="keyword">false</span>, <span class="keyword">null</span>&#125;);</span><br><span class="line">        RefInvoke.setFieldObject(<span class="string">"android.app.ActivityThread"</span>,</span><br><span class="line">                <span class="string">"mInitialApplication"</span>, currentActivityThread, app);</span><br><span class="line">        ArrayMap mProviderMap = (ArrayMap) RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">"android.app.ActivityThread"</span>, currentActivityThread,</span><br><span class="line">                <span class="string">"mProviderMap"</span>);</span><br><span class="line">        <span class="keyword">assert</span> mProviderMap != <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Object providerClientRecord : mProviderMap.values()) &#123;</span><br><span class="line">            Object localProvider = RefInvoke.getFieldOjbect(</span><br><span class="line">                    <span class="string">"android.app.ActivityThread$ProviderClientRecord"</span>,</span><br><span class="line">                    providerClientRecord, <span class="string">"mLocalProvider"</span>);</span><br><span class="line">            RefInvoke.setFieldObject(<span class="string">"android.content.ContentProvider"</span>,</span><br><span class="line">                    <span class="string">"mContext"</span>, localProvider, app);</span><br><span class="line">        &#125;</span><br><span class="line">        Log.i(<span class="string">"demo"</span>, <span class="string">"app:"</span> + app);</span><br><span class="line">        <span class="keyword">assert</span> app != <span class="keyword">null</span>;</span><br><span class="line">        app.onCreate();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">splitPayLoadFromDex</span><span class="params">(<span class="keyword">byte</span>[] apkdata)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ablen = apkdata.length;</span><br><span class="line">        <span class="keyword">byte</span>[] dexlen = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">        System.arraycopy(apkdata, ablen - <span class="number">4</span>, dexlen, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">        ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(dexlen);</span><br><span class="line">        DataInputStream in = <span class="keyword">new</span> DataInputStream(bais);</span><br><span class="line">        <span class="keyword">int</span> readInt = in.readInt();</span><br><span class="line">        System.out.println(Integer.toHexString(readInt));</span><br><span class="line">        <span class="keyword">byte</span>[] newdex = <span class="keyword">new</span> <span class="keyword">byte</span>[readInt];</span><br><span class="line">        System.arraycopy(apkdata, ablen - <span class="number">4</span> - readInt, newdex, <span class="number">0</span>, readInt);</span><br><span class="line">        newdex = decrypt(newdex);</span><br><span class="line">        File file = <span class="keyword">new</span> File(apkFileName);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream localFileOutputStream = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">            localFileOutputStream.write(newdex);</span><br><span class="line">            localFileOutputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException localIOException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(localIOException);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ZipInputStream localZipInputStream = <span class="keyword">new</span> ZipInputStream(</span><br><span class="line">                <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file)));</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            ZipEntry localZipEntry = localZipInputStream.getNextEntry();</span><br><span class="line">            <span class="keyword">if</span> (localZipEntry == <span class="keyword">null</span>) &#123;</span><br><span class="line">                localZipInputStream.close();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String name = localZipEntry.getName();</span><br><span class="line">            <span class="keyword">if</span> (name.startsWith(<span class="string">"lib/"</span>) &amp;&amp; name.endsWith(<span class="string">".so"</span>)) &#123;</span><br><span class="line">                File storeFile = <span class="keyword">new</span> File(libPath + <span class="string">"/"</span></span><br><span class="line">                        + name.substring(name.lastIndexOf(<span class="string">'/'</span>)));</span><br><span class="line">                storeFile.createNewFile();</span><br><span class="line">                FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(storeFile);</span><br><span class="line">                <span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> i = localZipInputStream.read(arrayOfByte);</span><br><span class="line">                    <span class="keyword">if</span> (i == -<span class="number">1</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    fos.write(arrayOfByte, <span class="number">0</span>, i);</span><br><span class="line">                &#125;</span><br><span class="line">                fos.flush();</span><br><span class="line">                fos.close();</span><br><span class="line">            &#125;</span><br><span class="line">            localZipInputStream.closeEntry();</span><br><span class="line">        &#125;</span><br><span class="line">        localZipInputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] readDexFileFromApk() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ByteArrayOutputStream dexByteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ZipInputStream localZipInputStream = <span class="keyword">new</span> ZipInputStream(</span><br><span class="line">                <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(</span><br><span class="line">                        <span class="keyword">this</span>.getApplicationInfo().sourceDir)));</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            ZipEntry localZipEntry = localZipInputStream.getNextEntry();</span><br><span class="line">            <span class="keyword">if</span> (localZipEntry == <span class="keyword">null</span>) &#123;</span><br><span class="line">                localZipInputStream.close();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (localZipEntry.getName().equals(<span class="string">"classes.dex"</span>)) &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> i = localZipInputStream.read(arrayOfByte);</span><br><span class="line">                    <span class="keyword">if</span> (i == -<span class="number">1</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    dexByteArrayOutputStream.write(arrayOfByte, <span class="number">0</span>, i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            localZipInputStream.closeEntry();</span><br><span class="line">        &#125;</span><br><span class="line">        localZipInputStream.close();</span><br><span class="line">        <span class="keyword">return</span> dexByteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] decrypt(<span class="keyword">byte</span>[] srcdata) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;srcdata.length;i++)&#123;</span><br><span class="line">            srcdata[i] = (<span class="keyword">byte</span>)(<span class="number">0xFF</span> ^ srcdata[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> srcdata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> AssetManager mAssetManager;</span><br><span class="line">    <span class="keyword">protected</span> Resources mResources;</span><br><span class="line">    <span class="keyword">protected</span> Theme mTheme;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadResources</span><span class="params">(String dexPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AssetManager assetManager = AssetManager.class.newInstance();</span><br><span class="line">            Method addAssetPath = assetManager.getClass().getMethod(<span class="string">"addAssetPath"</span>, String.class);</span><br><span class="line">            addAssetPath.invoke(assetManager, dexPath);</span><br><span class="line">            mAssetManager = assetManager;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.i(<span class="string">"inject"</span>, <span class="string">"loadResource error:"</span>+Log.getStackTraceString(e));</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Resources superRes = <span class="keyword">super</span>.getResources();</span><br><span class="line">        superRes.getDisplayMetrics();</span><br><span class="line">        superRes.getConfiguration();</span><br><span class="line">        mResources = <span class="keyword">new</span> Resources(mAssetManager, superRes.getDisplayMetrics(),superRes.getConfiguration());</span><br><span class="line">        mTheme = mResources.newTheme();</span><br><span class="line">        mTheme.setTo(<span class="keyword">super</span>.getTheme());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AssetManager <span class="title">getAssets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mAssetManager == <span class="keyword">null</span> ? <span class="keyword">super</span>.getAssets() : mAssetManager;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Resources <span class="title">getResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mResources == <span class="keyword">null</span> ? <span class="keyword">super</span>.getResources() : mResources;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Theme <span class="title">getTheme</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mTheme == <span class="keyword">null</span> ? <span class="keyword">super</span>.getTheme() : mTheme;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefInvoke</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> Object <span class="title">invokeStaticMethod</span><span class="params">(String class_name, String method_name, Class[] pareTyple, Object[] pareVaules)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class obj_class = Class.forName(class_name);</span><br><span class="line">            Method method = obj_class.getDeclaredMethod(method_name, pareTyple);</span><br><span class="line">            method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(<span class="keyword">null</span>, pareVaules);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Object <span class="title">invokeMethod</span><span class="params">(String class_name, String method_name, Object obj, Class[] pareTyple, Object[] pareVaules)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class obj_class = Class.forName(class_name);</span><br><span class="line">            Method method = obj_class.getDeclaredMethod(method_name, pareTyple);</span><br><span class="line">            method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(obj, pareVaules);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Object <span class="title">getFieldOjbect</span><span class="params">(String class_name, Object obj, String filedName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class obj_class = Class.forName(class_name);</span><br><span class="line">            Field field = obj_class.getDeclaredField(filedName);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> field.get(obj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldObject</span><span class="params">(String classname, String filedName, Object obj, Object filedVaule)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class obj_class = Class.forName(classname);</span><br><span class="line">            Field field = obj_class.getDeclaredField(filedName);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            field.set(obj, filedVaule);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里要注意的是，manifest里的入口activity要写那个源apk的入口activity。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"APPLICATION_CLASS_NAME"</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">"com.xxx.xxx.MyApplication"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"com.xxx.xxx.MainActivity"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="加密-拼装工具"><a href="#加密-拼装工具" class="headerlink" title="加密+拼装工具"></a>加密+拼装工具</h4><p>这个就是把源apk和壳的dex拼在一起，并加密，变成新的壳的dex，并修正dex头中<strong>checksum</strong>、<strong>signature</strong>、<strong>file_size</strong>的值。</p>
<p>新dex结构：</p>
<table>
<thead>
<tr>
<th style="text-align:center">dex</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">…</td>
</tr>
<tr>
<td style="text-align:center">checksum</td>
</tr>
<tr>
<td style="text-align:center">signature</td>
</tr>
<tr>
<td style="text-align:center">file_size</td>
</tr>
<tr>
<td style="text-align:center">…</td>
</tr>
<tr>
<td style="text-align:center">壳的dex</td>
</tr>
<tr>
<td style="text-align:center">源程序的apk</td>
</tr>
<tr>
<td style="text-align:center">源程序apk的大小</td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ssjShellTool</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] intToByte(<span class="keyword">int</span> number) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>]; </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &gt;= <span class="number">0</span>; i--) &#123; </span><br><span class="line">            b[i] = (<span class="keyword">byte</span>) (number % <span class="number">256</span>); </span><br><span class="line">            number &gt;&gt;= <span class="number">8</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> b; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File payloadSrcFile = <span class="keyword">new</span> File(<span class="string">"force/source.apk"</span>);</span><br><span class="line">            System.out.println(<span class="string">"apk size:"</span>+payloadSrcFile.length());</span><br><span class="line">            File unShellDexFile = <span class="keyword">new</span> File(<span class="string">"force/shell.dex"</span>);</span><br><span class="line">            System.out.println(<span class="string">"dex size:"</span>+unShellDexFile.length());</span><br><span class="line">            <span class="keyword">byte</span>[] payloadArray = encrpt(readFileBytes(payloadSrcFile));</span><br><span class="line">            <span class="keyword">byte</span>[] unShellDexArray = readFileBytes(unShellDexFile);</span><br><span class="line">            <span class="keyword">int</span> payloadLen = payloadArray.length;</span><br><span class="line">            <span class="keyword">int</span> unShellDexLen = unShellDexArray.length;</span><br><span class="line">            <span class="keyword">int</span> totalLen = payloadLen + unShellDexLen + <span class="number">4</span>;</span><br><span class="line">            System.out.println(<span class="string">"tot size:"</span>+totalLen);</span><br><span class="line">            <span class="keyword">byte</span>[] newdex = <span class="keyword">new</span> <span class="keyword">byte</span>[totalLen];</span><br><span class="line">            </span><br><span class="line">            System.arraycopy(unShellDexArray, <span class="number">0</span>, newdex, <span class="number">0</span>, unShellDexLen);</span><br><span class="line">            System.arraycopy(payloadArray, <span class="number">0</span>, newdex, unShellDexLen, payloadLen);</span><br><span class="line">            System.arraycopy(intToByte(payloadLen), <span class="number">0</span>, newdex, totalLen-<span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">            fixFileSizeHeader(newdex);</span><br><span class="line">            fixSHA1Header(newdex);</span><br><span class="line">            fixCheckSumHeader(newdex);</span><br><span class="line"></span><br><span class="line">            String str = <span class="string">"force/classes.dex"</span>;</span><br><span class="line">            File file = <span class="keyword">new</span> File(str);</span><br><span class="line">            <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                file.createNewFile();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            FileOutputStream localFileOutputStream = <span class="keyword">new</span> FileOutputStream(str);</span><br><span class="line">            localFileOutputStream.write(newdex);</span><br><span class="line">            localFileOutputStream.flush();</span><br><span class="line">            localFileOutputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"finish"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//此处加密</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encrpt(<span class="keyword">byte</span>[] srcdata)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;srcdata.length;i++)&#123;</span><br><span class="line">            srcdata[i] = (<span class="keyword">byte</span>)(<span class="number">0xFF</span> ^ srcdata[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> srcdata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixCheckSumHeader</span><span class="params">(<span class="keyword">byte</span>[] dexBytes)</span> </span>&#123;</span><br><span class="line">        Adler32 adler = <span class="keyword">new</span> Adler32();</span><br><span class="line">        adler.update(dexBytes, <span class="number">12</span>, dexBytes.length - <span class="number">12</span>);</span><br><span class="line">        <span class="keyword">long</span> value = adler.getValue();</span><br><span class="line">        <span class="keyword">int</span> va = (<span class="keyword">int</span>) value;</span><br><span class="line">        <span class="keyword">byte</span>[] newcs = intToByte(va);</span><br><span class="line">        <span class="keyword">byte</span>[] recs = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            recs[i] = newcs[newcs.length - <span class="number">1</span> - i];</span><br><span class="line">        &#125;</span><br><span class="line">        System.arraycopy(recs, <span class="number">0</span>, dexBytes, <span class="number">8</span>, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixSHA1Header</span><span class="params">(<span class="keyword">byte</span>[] dexBytes)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> NoSuchAlgorithmException </span>&#123;</span><br><span class="line">        MessageDigest md = MessageDigest.getInstance(<span class="string">"SHA-1"</span>);</span><br><span class="line">        md.update(dexBytes, <span class="number">32</span>, dexBytes.length - <span class="number">32</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] newdt = md.digest();</span><br><span class="line">        System.arraycopy(newdt, <span class="number">0</span>, dexBytes, <span class="number">12</span>, <span class="number">20</span>);</span><br><span class="line">        String hexstr = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; newdt.length; i++) &#123;</span><br><span class="line">            hexstr += Integer.toString((newdt[i] &amp; <span class="number">0xff</span>) + <span class="number">0x100</span>, <span class="number">16</span>)</span><br><span class="line">                    .substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(hexstr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixFileSizeHeader</span><span class="params">(<span class="keyword">byte</span>[] dexBytes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] newfs = intToByte(dexBytes.length);</span><br><span class="line">        <span class="keyword">byte</span>[] refs = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            refs[i] = newfs[newfs.length - <span class="number">1</span> - i];</span><br><span class="line">        &#125;</span><br><span class="line">        System.arraycopy(refs, <span class="number">0</span>, dexBytes, <span class="number">32</span>, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] readFileBytes(File file) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        ByteArrayOutputStream localByteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> i = fis.read(arrayOfByte);</span><br><span class="line">            <span class="keyword">if</span> (i != -<span class="number">1</span>) &#123;</span><br><span class="line">                localByteArrayOutputStream.write(arrayOfByte, <span class="number">0</span>, i);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                fis.close();</span><br><span class="line">                <span class="keyword">return</span> localByteArrayOutputStream.toByteArray();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="综上"><a href="#综上" class="headerlink" title="综上"></a>综上</h3><p>综上，这就是一个垃圾壳子。</p>
<p>TODO:</p>
<ul>
<li>搞一个加密算法把内容加密一下</li>
<li>加载源apk的代码写到so里</li>
<li>加些反调试、检测Xposed的内容</li>
<li>后续可能还会升级成类抽取的…</li>
</ul>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/programming/">编程</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-iSmart-break-sign" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/10/iSmart-break-sign/" class="article-date">
      <time datetime="2019-05-10T11:33:40.000Z" itemprop="datePublished">2019-05-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/10/iSmart-break-sign/">iSmart逆向分析之绕过签名验证</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>这个iSmart我本想搞一搞它，但是被乱七八糟的事一拖再拖，一直拖到我iSmart<strong>读完了</strong>，没有搞下去的动力了，所以只绕了个签名验证。这个app是个新手练手的好样本，日后有机会或者会继续分析。</p>
<p>扔一个链接。</p>
<p><a href="https://bbs.pediy.com/thread-251339.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-251339.htm</a></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/programming/">编程</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2019 ssj
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style="display:none">
                        <span id="site-visit">到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style="display:none">
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 13;
            var backgroundimg = "url(/background/bg-" + backgroundnum +".jpg)";
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>